---
output: html_document
editor_options: 
  chunk_output_type: console
---
0---
title: Report on data in AusTraits
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---

Load data
```{r, warning=FALSE, message=FALSE}
# Load packages and functions for this analysis

rm(list=ls())

source("R/error_checking_functions/error_checking_function.R")

#climate extraction functions
source("R/climate_extraction_functions/load_climate_data.R")

#plotting functions
source("R/plotting_functions/plot_whittaker_biomes.R")
source("R/plotting_functions/plot_climate.R")
source("R/plotting_functions/plot_trait_by_dataset.R")


library(xtable)
library(lubridate)
library(R.utils)
library(tidyverse)
library(corrplot)
library(ggpointdensity)
library(tagger)
library(relaimpo)
library(austraits)
library(terra)
# load trait data
latest_version <- austraits::get_version_latest()
austraits <- austraits::load_austraits(version = latest_version)

# austraits <- readRDS("data/austraits_vesk.RDS")
```

```{r}
sum_no_NA <- function(x) if(all(is.na(x))) NA_integer_ else sum(x, na.rm=TRUE)
```

```{r}
traits <- austraits$traits %>%
  filter(trait_name %in% c("leaf_area","leaf_mass_per_area","leaf_N_per_dry_mass","leaf_N_per_area","wood_density","plant_height", "seed_dry_mass", "leaf_delta13C","huber_value")) %>%
  mutate(value = as.numeric(value))
```

```{r}
traits %>%
  filter(basis_of_record %in% c("field", "field, field_experiment")) %>%
  filter(!(dataset_id == "Cheesman_2020" & (method_id %in% c("03","04") | treatment_id %in% c("03")))) -> field_traits
```

We also remove all trait values which are records across multiple sites, are from the literature, expert values, or are from unknown sources except for height in which we take all values

```{r}
field_traits %>%
  filter(basis_of_value %in% c("measurement") | trait_name == "plant_height") -> field_traits
```


first need to work out which studies in the available dataset had looked at leaf area and if they considered compound leaves as leaflets or leaves.

```{r}
field_traits %>%
  filter(trait_name == "leaf_area") %>%
  distinct(dataset_id) %>%
  write_csv("data/leaf_compound_filter/datasets_with_leaf_area.csv")
```

```{r}
datasets_with_leaf_area <- read_csv("data/leaf_compound_filter/datasets_with_leaf_area_edited.csv")

field_traits %>%
  filter(trait_name %in% c("leaf_area")) %>%
  left_join(datasets_with_leaf_area) -> field_traits_leaf_area

austraits$traits %>%
  filter(trait_name == "leaf_compoundness") %>% 
  group_by(taxon_name) %>%
  mutate(num_types = n_distinct(value)) %>%
  ungroup() %>%
  mutate(compoundness = if_else(num_types > 1 | value =="compound" | value == "compound simple", "compound", "simple")) %>% 
  dplyr::select(-value) %>%
  distinct(taxon_name, .keep_all = T) %>%
  dplyr::select(compoundness, taxon_name) -> compound_taxa
  
field_traits_leaf_area %>%
  left_join(compound_taxa) %>% 
  filter(!(compound_species == "compound_present" & leaf_unit_measured == "leaf" & compoundness %in% c(NA,"compound"))) -> field_traits_leaf_area_compound_removed
```

```{r}
field_traits %>%
  filter(!trait_name %in% c("leaf_area")) %>%
  bind_rows(field_traits_leaf_area_compound_removed) -> field_traits
```

```{r}
austraits$traits %>%
  filter(trait_name %in% c("woodiness_detailed"))  %>% 
  filter(dataset_id == "Wenk_2022") %>%
  filter(value %in% c("woody")) %>%
  pull(taxon_name) %>%
  unique() -> woody_taxa

austraits$traits %>%
  filter(trait_name %in% c("woodiness_detailed"))  %>% 
  filter(dataset_id == "Wenk_2022") %>%
  filter(!value %in% c("woody")) %>%
  pull(taxon_name) %>%
  unique() -> non_woody_taxa

austraits$traits %>%
  filter(trait_name %in% c("woodiness_detailed"))  %>% 
  filter(dataset_id == "Wenk_2022") %>%
  filter(value %in% c("woody_like_stem")) %>%
  pull(taxon_name) %>%
  unique() -> woody_like_taxa

austraits$traits %>%
  filter(trait_name %in% c("woodiness_detailed"))  %>% 
  filter(dataset_id == "Wenk_2022") %>%
  filter(value != c("woody_like_stem")) %>%
  pull(taxon_name) %>%
  unique() -> non_woody_like_taxa

field_traits %>%
  mutate(growth_form = case_when(taxon_name %in% woody_taxa ~ "Woody",
                                 taxon_name %in% non_woody_taxa ~ "Non-woody"),
         woody_like_taxa = case_when(taxon_name %in% woody_like_taxa ~ "Woody",
                                 taxon_name %in% non_woody_like_taxa ~ "Non-woody")) %>%
  group_by(taxon_name, growth_form, woody_like_taxa) %>%
  nest() %>%
  group_by(taxon_name) %>%
  nest(growth_form_data = c(growth_form, woody_like_taxa)) %>%
  unnest(data) -> woody_field_traits
```


```{r}
woody_field_traits %>%
  filter(trait_name %in% c("leaf_N_per_dry_mass", "leaf_mass_per_area", "leaf_N_per_area")) %>%
  mutate(value = as.numeric(value)) %>%
  group_by(location_id, dataset_id, taxon_name, observation_id, trait_name, growth_form_data) %>% 
  nest(.key = "value") %>%
  mutate(value = map_dbl(value, ~mean(.x$value))) %>% 
  ungroup() %>%
  pivot_wider(names_from = "trait_name", values_from = "value") %>%
  mutate(leaf_N_per_dry_mass = leaf_N_per_dry_mass/1000) %>%
  mutate(leaf_N_per_area= if_else(!is.na(leaf_N_per_area), 
                                  leaf_N_per_area, 
                                  leaf_N_per_dry_mass * leaf_mass_per_area)) %>%
  dplyr::select(-leaf_N_per_dry_mass, -leaf_mass_per_area) %>%
  drop_na(leaf_N_per_area) %>%
  pivot_longer(cols = leaf_N_per_area, names_to = "trait_name") %>%
  mutate(trait_name = "leaf_N_per_area_calc") -> calculated_leaf_N_data

woody_field_traits %>%
  bind_rows(calculated_leaf_N_data) -> woody_field_traits
```

Error checking for leaf mass per area

```{r}
error_check(woody_field_traits, "leaf_mass_per_area") -> error_check_lma
```

Error checking for huber value

```{r}
error_check(woody_field_traits_georef, "huber_value") -> error_check_huber
```

Error checking for leaf N per area

```{r}
error_check(woody_field_traits_georef, "leaf_N_per_area") -> error_check_leaf_N
```

Error checking for wood density - no problematic data points detected

```{r}
error_check(woody_field_traits_georef, "wood_density") -> error_check_wood_density
```

Error checking for plant height - no problematic data points detected

```{r}
error_check(woody_field_traits_georef, "plant_height") -> error_check_plant_height
```


Error checking for leaf_delta13C - no problematic points detected

```{r}
error_check(woody_field_traits_georef, "leaf_delta13C") -> error_check_13C
```

Error checking for seed mass

```{r}
error_check(woody_field_traits_georef, "seed_dry_mass") -> error_check_seed_mass
```

Error checking for leaf area

```{r}
error_check(woody_field_traits_georef, "leaf_area") -> error_check_leaf_area
```

To see if there any instances where data is shared between studies, we inspect occurrences of identical trait values for each trait~species group. Although there are a number of cases where this occurs, most seem to be coincidental.

```{r}
woody_field_traits_georef %>%
  group_by(value, taxon_name, trait_name) %>% 
  filter(n()>1) %>% 
  filter(n_distinct(dataset_id)>1) -> identical_values
```


```{r}
erroneous_values <- read_csv("data/erroneous_values/erroneous_values.csv")

erroneous_list <- vector("list", nrow(erroneous_values))

for(i in 1:nrow(erroneous_values)){
  erroneous_data <- erroneous_values[i,] %>% dplyr::select_if(~ !any(is.na(.)))
  erroneous_data <- woody_field_traits %>% left_join(erroneous_data) %>% drop_na(erroneous)
  erroneous_list[[i]] <- erroneous_data
}

woody_field_traits <- left_join(woody_field_traits,bind_rows(erroneous_list))

woody_field_traits %>%
  filter(is.na(erroneous)) -> woody_field_traits
```

```{r}
woody_field_traits %>%
  filter(trait_name == "leaf_delta13C") %>%
  mutate(trait_name = "leaf_capital_delta13C") %>%
  mutate(value = (-8/1000 - value/1000)/(1 + value/1000)*1000) -> leaf_Delta13C_calculated
```

```{r}
woody_field_traits %>%
  bind_rows(leaf_Delta13C_calculated) -> woody_field_traits
```


```{r}
austraits$traits %>%
  filter(trait_name == "photosynthetic_pathway") %>%
  dplyr::select(taxon_name, value) %>%
  group_by(taxon_name) %>%
  nest(photosynthetic_pathway = -taxon_name) %>%
  mutate(photosynthetic_pathway = map(photosynthetic_pathway, ~unique(.x$value))) %>%
  mutate(length_pathways = map_dbl(photosynthetic_pathway, ~length(.x))) %>%
  filter(length_pathways == 1) %>%
  unnest(photosynthetic_pathway) %>%
  filter(photosynthetic_pathway == "c3") %>%
  dplyr::select(-length_pathways) -> austraits_photosythnetic_pathway
```

```{r}
woody_field_traits %>% 
  left_join(austraits_photosythnetic_pathway) %>%
  filter(!(trait_name == "leaf_capital_delta13C" & is.na(photosynthetic_pathway))) -> woody_field_traits
```

```{r}
#where are sites located?
location_of_sites <-
  austraits$locations %>%
  filter(location_property %in% c("longitude (deg)", "latitude (deg)")) %>%
  spread(location_property, value) %>%
  rowid_to_column("ID") %>%
  rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
  mutate_at(c("latitude", "longitude"), ~suppressWarnings(as.numeric(.x))) %>%
  drop_na(longitude, latitude)
```


Create a new trait dataframe to only include observations with associated latitude and longitude
```{r}
woody_field_traits_georef <- woody_field_traits %>%
  left_join(location_of_sites) %>%
  drop_na(latitude,longitude)
```

```{r}
#define the core traits to focus on
core_traits <- c("huber_value","leaf_capital_delta13C","leaf_N_per_area_calc","leaf_mass_per_area","wood_density","plant_height","leaf_area","seed_dry_mass")
```


```{r}
source("R/plotting_functions/plot_climate.R")

woody_field_traits_georef %>%
  unnest(growth_form_data) %>%
  drop_na(growth_form) %>%
  filter(trait_name %in% core_traits) %>%
    filter(!trait_name %in% c("huber_value","wood_density")) %>%
  plot_site_map_by_trait() -> overall_distribution

woody_field_traits_georef %>%
  ungroup() %>%
  unnest(growth_form_data) %>%
  drop_na(growth_form) %>%
  filter(growth_form == "Woody" | woody_like_taxa == "Woody") %>%
  filter(trait_name %in% core_traits) %>%
  plot_site_map_by_trait() -> woody_distribution

woody_field_traits_georef %>%
      unnest(growth_form_data) %>%
  drop_na(growth_form) %>%
  filter(growth_form == "Non-woody" & woody_like_taxa != "Woody") %>% 
  filter(trait_name %in% core_traits) %>%
  filter(!trait_name %in% c("huber_value","wood_density")) %>%
  plot_site_map_by_trait() -> non_woody_distribution

png("output/manuscript/overall_distribution.png", height = 1333, width = 2000, res = 300)
overall_distribution +
  labs(title = "All trait data")
dev.off()

png("output/manuscript/woody_distribution.png", height = 2000, width = 2000, res = 300)
woody_distribution +
  labs(title = "Woody trait data")
dev.off()

png("output/manuscript/non_woody_distribution.png", height = 1333, width = 2000, res = 300)
non_woody_distribution +
  labs(title = "Non-woody trait data")
dev.off()

```
#Run from above

```{r}
# source("R/climate_extraction_functions/load_climate_data.R")
source("R/climate_extraction_functions/load_climate_data_prec_only.R")

```


```{r}
climate_data <- load_climate_data(woody_field_traits_georef, simple_only = FALSE)%>% 
  group_by(ID, cell) %>%
  nest(.key = "climate_data")
```

#Read in climate data and join

```{r}
woody_field_traits_georef  %>%
  left_join(climate_data) -> woody_field_traits_georef_climate
```

We will now inspect distribution of data in each study relative to total distribution to see if there is any erroneous data
```{r eval=FALSE, include=FALSE}
trait_by_dataset_core_traits<-function(trait, data){
data %>%
  distinct(dataset_id) -> dataset_index

purrr::map(dataset_index$dataset_id, plot_trait_by_dataset, trait, data)
}

woody_field_traits_georef_climate %>%
  group_by(trait_name) %>% 
  nest() %>%
  map2(.x = .$trait_name, .y = .$data, .f = ~trait_by_dataset_core_traits(.x, .y))
```



```{r}
#two too many cells, occurring because same cell has different climate values somehow.
woody_field_traits_georef_climate %>% 
  dplyr::select(cell, taxon_name, trait_name, value, climate_data, growth_form_data) %>%
  group_by(cell, taxon_name, trait_name, climate_data, growth_form_data) %>%
  nest(.key = "value") %>% 
  mutate(value = map_dbl(value, ~mean(.x$value))) %>%
  ungroup() -> woody_field_traits_georef_mean_climate
```

#Prep data for analysis
First, let's calculate the correlations between the traits and the environmental variables. This is will be the key statistic which will be used for analysis.For starters, which traits and environmental variables are not normally distributed? We need to turn the data into a wide format.

```{r}
woody_field_traits_georef_mean_climate %>%
  filter(trait_name %in% core_traits) %>%
  pivot_wider(values_from = value, names_from = trait_name) %>%
  unnest(climate_data) %>%
  dplyr::rename(Temp = temp,
                PET = annualPET, 
                Prec = prec,
                VPD = vpd, 
                prec_cv = prec.cv, 
                temp_cv = temp.cv, 
                prec_wq = prec.wq, 
                prec_dq = prec.dq, 
                AI_thorn = aridityIndexThornthwaite, GDD_5 =  growingDegDays5) -> woody_field_traits_georef_mean_climate_wide
  
woody_field_traits_georef_mean_climate_wide %>%
  mutate(MI = Prec/PET) %>%
  mutate(log_MI = log(MI)) %>%
  mutate(log_leaf_capital_delta13C = log(leaf_capital_delta13C),
         log_leaf_area = log(leaf_area),
         log_seed_mass = log(seed_dry_mass),
         log_LMA = log(leaf_mass_per_area),
         log_wood_dens = log(wood_density),
         log_leaf_N = log(leaf_N_per_area_calc),
         log_height = log(plant_height),
         log_huber = log(huber_value),
         log_VPD = log(VPD),
         log_Prec = log(Prec),
         log_prec_wq = log(prec_wq),
         sqrt_prec_dq = sqrt(prec_dq),
         log_Prec_CV = log(prec_cv)) -> woody_field_traits_georef_mean_climate_wide

#environmental variables
hist(woody_field_traits_georef_mean_climate_wide$Temp)
hist(woody_field_traits_georef_mean_climate_wide$GDD_5)
hist(log(woody_field_traits_georef_mean_climate_wide$VPD))
hist(woody_field_traits_georef_mean_climate_wide$SWdown)
hist(log(woody_field_traits_georef_mean_climate_wide$Prec))
hist(sqrt(woody_field_traits_georef_mean_climate_wide$prec_dq))
hist(log(woody_field_traits_georef_mean_climate_wide$prec_wq))

hist(sqrt(woody_field_traits_georef_mean_climate_wide$elev))
hist(woody_field_traits_georef_mean_climate_wide$Max_temp)
hist(log(woody_field_traits_georef_mean_climate_wide$MI))
hist(woody_field_traits_georef_mean_climate_wide$AI_thorn)
hist(log(woody_field_traits_georef_mean_climate_wide$prec_cv))
hist((woody_field_traits_georef_mean_climate_wide$temp_cv))


#traits
hist(log(woody_field_traits_georef_mean_climate_wide$leaf_area))
hist(log(woody_field_traits_georef_mean_climate_wide$leaf_mass_per_area))
hist((woody_field_traits_georef_mean_climate_wide$wood_density))
hist(log(woody_field_traits_georef_mean_climate_wide$leaf_N_per_area_calc))
hist(log(woody_field_traits_georef_mean_climate_wide$plant_height))
hist(log(woody_field_traits_georef_mean_climate_wide$huber_value))
hist(log(woody_field_traits_georef_mean_climate_wide$seed_dry_mass))
hist(woody_field_traits_georef_mean_climate_wide$leaf_capital_delta13C)

#all traits bar wood density will be log transformed.
```


First, just check relationships between environmental variables
```{r}
png("output/manuscript/supps_ellipse_environmental.png", height=1300, width=2000, res=300)

library(corrplot)

woody_field_traits_georef_mean_climate_wide %>%
  drop_na(growth_form) %>%
  distinct(cell, .keep_all = T) %>%
  dplyr::select(-c(taxon_name,cell, growth_form, woody_climber)) -> for_corrplot
trait_env_correlation<- cor(for_corrplot, use="pairwise.complete.obs")

corrplot_example <- trait_env_correlation[c("Temp","GDD_5","log_VPD","SWdown","log_Prec","sqrt_elev","Max_temp", "MI","AI_thorn","log_Prec_CV","temp_cv","log_prec_wq","sqrt_prec_dq"),c("Temp","GDD_5","log_VPD","SWdown","log_Prec","sqrt_elev","Max_temp", "MI","AI_thorn","log_Prec_CV","temp_cv","log_prec_wq","sqrt_prec_dq")]

colnames(corrplot_example) <- c("MAT","GDD_5","log(VPD)","SWDown","log(MAP)","sqrt(Elevation)","max(Temp)", "MI", "aridity index Thornthwaite","log_Prec_CV","temp_cv","Prec_WQ", "Prec_DQ")
rownames(corrplot_example) <- c("MAT","GDD_5","log(VPD)","SWDown","log(MAP)","sqrt(Elevation)","max(Temp)", "MI", "aridity index Thornthwaite","log_Prec_CV","temp_cv","Prec_WQ", "Prec_DQ")

corrplot::corrplot(corrplot_example, method="ellipse", type = "upper")

dev.off()
```

Basic patterns with environment

Supp Figure. 1

```{r}
library(lme4)

fit_models <- function(...){
  data <- tibble(...) %>%
    unnest(data)
  
  fit_lm <- lm(trait_value~env_value, data)
  
  data$env_value2 <- data$env_value^2
  fit_quad <- lm(trait_value ~ env_value + env_value2, data)
  
  return(tibble(p_lm = summary(fit_lm)$coef[2,4],
         fit_lm = summary(fit_lm)$r.squared, 
         fit_quad = summary(fit_quad)$r.squared))
}
```


```{r}
woody_field_traits_georef_mean_climate_wide %>%
  unnest(growth_form_data) %>%
  drop_na(growth_form) %>% 
  # drop_na(AI_thorn) %>%
  dplyr::select(log_leaf_capital_delta13C, log_height, log_leaf_N, log_LMA, log_seed_mass, log_leaf_area, log_Prec, GDD_5, log_MI, log_VPD, AI_thorn,log_Prec_CV,temp_cv, log_prec_wq, sqrt_prec_dq, cell) %>%
  pivot_longer(cols = c(log_leaf_capital_delta13C, 
                        log_leaf_area,
                        log_seed_mass,
                        log_LMA,
                        log_leaf_N,
                        log_height),
                        names_to = "trait_name", values_to = "trait_value") %>%
  pivot_longer(cols = c(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI), names_to = "env_name", values_to = "env_value") %>% 
  group_by(trait_name, env_name) %>%
  nest() %>%
  ungroup %>%
  mutate(r2 = pmap(., fit_models)) %>%
  unnest(r2) -> overall_relationships

overall_relationships %>%
  dplyr::select(fit_lm, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_lm") -> fit_lm_overall

print(xtable(fit_lm_overall %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI") %>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_lm_overall_prec.tex")

overall_relationships %>%
  dplyr::select(fit_quad, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_quad") -> fit_quad_overall

print(xtable(fit_quad_overall %>%
   dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI") %>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_quad_overall_prec.tex")


print(xtable(fit_lm_overall %>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_quad_overall.tex")

 
woody_field_traits_georef_mean_climate_wide %>%
  unnest(growth_form_data) %>%
  drop_na(growth_form) %>% 
  filter(growth_form == "Woody") %>%
  # drop_na(AI_thorn) %>%
  dplyr::select(log_leaf_capital_delta13C, log_height, log_leaf_N, log_LMA, log_seed_mass, log_leaf_area,
                        log_huber,
                        log_wood_dens, log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, cell) %>%
  pivot_longer(cols = c(log_leaf_capital_delta13C, 
                        log_leaf_area,
                        log_seed_mass,
                        log_LMA,
                        log_leaf_N,
                        log_height,
                        log_huber,
                        log_wood_dens),
                        names_to = "trait_name", values_to = "trait_value") %>%
  pivot_longer(cols = c(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI), names_to = "env_name", values_to = "env_value") %>% 
  group_by(trait_name, env_name) %>%
  nest() %>%
  ungroup %>%
  mutate(r2 = pmap(., fit_models)) %>%
  unnest(r2)-> woody_relationships

woody_relationships %>%
  dplyr::select(fit_lm, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_lm") -> fit_lm_woody


print(xtable(fit_lm_woody %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI") %>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_lm_woody_prec.tex")

woody_relationships %>%
  dplyr::select(fit_quad, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_quad") -> fit_quad_woody

print(xtable(fit_quad_woody %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI")%>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_quad_woody_prec.tex")


woody_field_traits_georef_mean_climate_wide %>%
  unnest(growth_form_data) %>%
  drop_na(growth_form) %>% 
  filter(growth_form == "Woody" | woody_like_taxa == "Woody") %>%
  dplyr::select(log_leaf_capital_delta13C, log_height, log_leaf_N, log_LMA, log_seed_mass, log_leaf_area,
                        log_huber,
                        log_wood_dens, log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, cell) %>%
  pivot_longer(cols = c(log_leaf_capital_delta13C, 
                        log_leaf_area,
                        log_seed_mass,
                        log_LMA,
                        log_leaf_N,
                        log_height,
                        log_huber,
                        log_wood_dens),
                        names_to = "trait_name", values_to = "trait_value") %>%
  pivot_longer(cols = c(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI), names_to = "env_name", values_to = "env_value") %>% 
  group_by(trait_name, env_name) %>%
  nest() %>%
  ungroup %>%
  mutate(r2 = pmap(., fit_models)) %>%
  unnest(r2)-> woody_relationships

woody_relationships %>%
  dplyr::select(fit_lm, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_lm") -> fit_lm_woody


print(xtable(fit_lm_woody %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI") %>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_lm_woody_prec_woody_like.tex")

woody_relationships %>%
  dplyr::select(fit_quad, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_quad") -> fit_quad_woody

print(xtable(fit_quad_woody %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI")%>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_quad_woody_prec_woody_like.tex")

woody_field_traits_georef_mean_climate_wide %>%
  unnest(growth_form_data) %>%
  drop_na(growth_form) %>% 
  filter(growth_form != "Woody") %>%
  # drop_na(AI_thorn) %>%
  dplyr::select(log_leaf_capital_delta13C, log_height, log_leaf_N, log_LMA, log_seed_mass, log_leaf_area,
                        log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, cell) %>%
  pivot_longer(cols = c(log_leaf_capital_delta13C, 
                        log_leaf_area,
                        log_seed_mass,
                        log_LMA,
                        log_leaf_N,
                        log_height),
                        names_to = "trait_name", values_to = "trait_value") %>%
  pivot_longer(cols = c(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI), names_to = "env_name", values_to = "env_value") %>% 
  group_by(trait_name, env_name) %>%
  nest() %>%
  ungroup %>%
  mutate(r2 = pmap(., fit_models)) %>%
  unnest(r2)-> non_woody_relationships

non_woody_relationships %>%
  dplyr::select(fit_lm, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_lm") -> fit_lm_non_woody


print(xtable(fit_lm_non_woody %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI") %>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_lm_non_woody_prec.tex")

non_woody_relationships %>%
  dplyr::select(fit_quad, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_quad") -> fit_quad_non_woody

print(xtable(fit_quad_non_woody %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI")%>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_quad_non_woody_prec.tex")


woody_field_traits_georef_mean_climate_wide %>%
  unnest(growth_form_data) %>%
  drop_na(growth_form) %>% 
  filter(growth_form != "Woody" & woody_like_taxa != "Woody") %>% 
  dplyr::select(log_leaf_capital_delta13C, log_height, log_leaf_N, log_LMA, log_seed_mass, log_leaf_area, log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, cell) %>%
  pivot_longer(cols = c(log_leaf_capital_delta13C, 
                        log_leaf_area,
                        log_seed_mass,
                        log_LMA,
                        log_leaf_N,
                        log_height),
                        names_to = "trait_name", values_to = "trait_value") %>%
  pivot_longer(cols = c(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI), names_to = "env_name", values_to = "env_value") %>% 
  group_by(trait_name, env_name) %>%
  nest() %>%
  ungroup %>%
  mutate(r2 = pmap(., fit_models)) %>%
  unnest(r2)-> non_woody_relationships

non_woody_relationships %>%
  dplyr::select(fit_lm, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_lm") -> fit_lm_non_woody


print(xtable(fit_lm_non_woody %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI") %>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_lm_non_woody_prec_woody_like.tex")

non_woody_relationships %>%
  dplyr::select(fit_quad, trait_name, env_name) %>%
  pivot_wider(names_from = "env_name", values_from ="fit_quad") -> fit_quad_non_woody

print(xtable(fit_quad_non_woody %>%
  dplyr::select(log_Prec, log_VPD,log_Prec_CV, log_prec_wq, sqrt_prec_dq,log_MI, trait_name) %>% 
  rename("log(MAP)" = "log_Prec",
         "log(VPD)" = "log_VPD",
         "log(Precipitation seasonality)" = "log_Prec_CV",
         "log(Wettest quarter precipitation)" = "log_prec_wq",
         "sqrt(Driest quarter precipitation)" = "sqrt_prec_dq",
         "log(Moisture index)" = "log_MI")%>% pivot_longer(cols = -(trait_name)) %>% pivot_wider(names_from = "trait_name", values_from = "value")), include.rownames=FALSE, file = "output/manuscript/fit_quad_non_woody_prec_woody_like.tex")
```


```{r}
woody_field_traits_georef_mean_climate %>%
  unnest(growth_form_data, climate_data) %>%
  drop_na(growth_form) %>% 
  # mutate(growth_form = if_else(woody_like_taxa == "Woody" | growth_form == "Woody", "Woody","Non-woody")) %>%
  filter(!(trait_name %in% c("huber_value","wood_density") & growth_form == "Non-woody" )) %>%
    dplyr::select(trait_name, value, prec, growth_form)%>%
    pivot_longer(-c("trait_name", "value","growth_form"), names_to = "env", values_to = "env_value")%>%
    # left_join(sub_labels) %>%
    filter(trait_name %in% c("leaf_area","seed_dry_mass","leaf_capital_delta13C","leaf_mass_per_area","leaf_N_per_area_calc","wood_density","plant_height","huber_value")) %>%
    group_by(trait_name) %>%
    ungroup() %>%
    drop_na(value, env_value) %>%
    group_by(trait_name) %>%
    ungroup() %>%
  group_by(trait_name, growth_form, env) %>%
  mutate(n = length(value)) %>%
    ungroup() -> data_for_plot
  
  data_for_plot$trait_name <- factor(data_for_plot$trait_name, 
                                     levels  = c("leaf_capital_delta13C","plant_height","huber_value","leaf_area","leaf_mass_per_area","leaf_N_per_area_calc","seed_dry_mass","wood_density"),
                                     labels = c("Delta^13~C~(`\u2030`)", "H~(m)", "H[v]","LA~(mm^2)", "LMA~(g~m^{-2})", "N[area]~(g~m^{-2})", "SM~(mg)", "Wood~density~(mg~mm^{-3})"))

  library(ggrepel)
  
data_for_plot %>%
  ggplot(aes(env_value, value,group = trait_name)) +
  geom_point(alpha = 0.5, aes(colour = growth_form)) + 
  scale_y_log10(expand = expansion(mult = 0.1)) +
  scale_x_log10(limits = c(min(data_for_plot$env_value, na.rm = T), max(data_for_plot$env_value, na.rm = T))) +
  theme_classic() +
  facet_wrap(~trait_name, scales = "free_y", 
                strip.position = "left",
               labeller = label_parsed) +
     theme(strip.background = element_blank(),
           strip.placement = "outside") +
  xlab("MAP (mm)") +
  ylab("") +
  theme(text=element_text(size=20), legend.position = "none") +
    # geom_text(mapping = aes(x = 0, y = Inf, label = label, group=env),
    #         hjust = "inward", vjust = "inward",
    #         inherit.aes = FALSE, check_overlap = TRUE, size = 6) +
  scale_color_manual(values = c("#009292","#db6d00")) +
  geom_smooth(method = "lm", aes(group = growth_form, colour = growth_form)) +
  tag_facets() +
  geom_text_repel(data = data_for_plot %>%
                     mutate(x= ifelse(growth_form == "Woody", 0, Inf)) %>%
                     group_by(growth_form) %>%
               distinct(trait_name, .keep_all = T) %>%
                 mutate(n = paste("n = ",n)), aes(x = x, y = 0, label = n, colour = growth_form), segment.color = "transparent", size = 5) -> p


  png("output/manuscript/gridded_relationships_prec_overall.png", height = 1500, width = 2666, res = 180)
p 
dev.off()
```


```{r}
bioclim <- terra::rast(list.files("data/climate_data/wc2.1_30s_bio", full.names = T)[c(1,2)])

australia <- terra::rast("data/australia.tif")

bioclim %>%
  terra::project(australia, mask = TRUE) -> bioclim_au

global_values_prec <- tibble(prec = terra::values(bioclim[[2]]))
au_values_prec <- tibble(prec = terra::values(bioclim_au[[2]]))

au_values_prec %>%
  summarise(min_prec = min(prec, na.rm = T),
            max_prec = max(prec, na.rm = T)) -> au_values_prec_summarised

global_values_prec %>% drop_na() %>%
  pull(prec) %>% ecdf() -> global_values_prec_ecdf

global_values_prec_ecdf(au_values_prec_summarised$min_prec)
global_values_prec_ecdf(au_values_prec_summarised$max_prec)


global_values_prec %>%
  drop_na() %>%
  sample_n(100000000) %>%
  ggplot() +
  ylab("Quantile") +
  xlab("Mean annual precipitation (mm/yr)") +
  theme_classic() +
  geom_polygon(data = tibble(y = c(0,1,1,0),
                             x = c(au_values_prec_summarised$min_prec,
                                         au_values_prec_summarised$min_prec,
                                         au_values_prec_summarised$max_prec,
                                         au_values_prec_summarised$max_prec)),
                             aes(x = x, y = y), alpha = 0.3, fill = "red") +
  stat_ecdf(aes(prec), linewidth = 2) + 
  theme(text=element_text(size=12)) +
  xlim(c(0, 5000))-> ecdf_prec


global_values_temp <- tibble(temp = terra::values(bioclim[[1]]))
au_values_temp <- tibble(temp = terra::values(bioclim_au[[1]]))

source("R/plotting_functions/plot_whittaker_biomes.R")

austraits_climate_space(core_traits) -> whittaker_plot


png("output/manuscript/ecdf_whittaker.png", height = 1200, width = 2800, res = 200)

cowplot::plot_grid(whittaker_plot, ecdf_prec, labels = "auto")

dev.off()


cor(au_values_prec, au_values_temp, use = "pairwise.complete.obs")



```


Whittaker distribution of each trait

```{r}

austraits_climate_space_trait_specific <- function(core_trait){
  
  aus_data = bind_cols(au_values_prec, au_values_temp)
  if(length(core_trait) == 1){
  if(core_trait == "legend"){
    
    ggplot() +
      geom_polygon(
        data = Whittaker_biomes,
        aes(x    = temp_c,
            y    = precp_cm,
            fill = biome),
        colour = "gray98",
        # colour of polygon border
        size   = 0.1
      ) +
      
      # set color for  the temperature - precipitation data points and the the AusTraits Sites
      scale_colour_manual(name = "Australian climate space", values = c("#FF7F50", "#233D4D")) +
      scale_fill_manual(
        name   = "Whittaker biomes",
        breaks = names(Ricklefs_colors),
        labels = names(Ricklefs_colors),
        values =  alpha(Ricklefs_colors, 0.5)
        
      ) +
      theme_classic() +
      guides(colour = guide_legend(override.aes = list(alpha = 1, size = 2))) +
      xlab(expression(Temperature (degree * C))) +
      ylab(" Precipitation (cm/yr)") +
      theme(text = element_text(size = 12))  +
      theme(
        legend.justification = c(-0.1, 0),
        legend.position = c(0.005, 0.25),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 10),
        legend.background = element_rect(fill=NA)
      ) -> p
    p <- cowplot::get_legend(p)
  } else{
  
   woody_field_traits_georef_mean_climate_wide %>%
    drop_na(core_trait) %>%
      group_by(cell) %>%
      nest() %>%
      mutate(Temp = map_dbl(data, ~unique(.x$Temp)),
             Prec = map_dbl(data, ~unique(.x$Prec)))-> site_data

    
  ggplot() +
  geom_polygon(
    data = Whittaker_biomes,
    aes(x    = temp_c,
        y    = precp_cm,
        fill = biome),
    colour = "gray98",
    # colour of polygon border
    size   = 0.1
  ) +
  
  # set color for  the temperature - precipitation data points and the the AusTraits Sites
  scale_colour_manual(name = "Australian climate space", values = c("#FF7F50", "#233D4D")) +
  scale_fill_manual(
    name   = "Whittaker biomes",
    breaks = names(Ricklefs_colors),
    labels = names(Ricklefs_colors),
    values =  alpha(Ricklefs_colors, 0.5)
    
  ) +
  theme_classic() +
  guides(colour = guide_legend(override.aes = list(alpha = 1, size = 2))) +
  xlab(expression(Temperature (degree * C))) +
  ylab(" Precipitation (cm/yr)") +
  theme(text = element_text(size = 12))  +
  theme(
    legend.justification = c(-0.1, 0),
    legend.position = "none",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 10)
  ) +
  geom_point(
    data = aus_data,
    aes(x = temp,
        y = prec/10),
    col = "orange", alpha = 0.1
  ) +
  geom_point(
    data = site_data,
    aes(x = Temp,
        y = Prec/10)
    )+
    ggtitle(core_trait) ->p
  }
}
  }

```



```{r}
png("output/manuscript/whittaker_plot.png", height=4000, width=4000, res=300)
purrr::map(c(core_traits, "legend"), austraits_climate_space_trait_specific) -> whittaker_plots
cowplot::plot_grid(plotlist = whittaker_plots)

dev.off()
```


