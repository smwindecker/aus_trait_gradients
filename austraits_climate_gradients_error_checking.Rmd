---
title: Report on data in AusTraits
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---

Load data
```{r, warning=FALSE, message=FALSE}
# Install dependencies as needed
# devtools::install_deps()
# Load packages and functions for this analysis

rm(list=ls())
devtools::load_all()
source("R/load_climate_data_AWAP.R")
source("R/compile_and_read_AWAP_data.R")
source("R/load_bioclim.R")
source("R/load_elevation.R")
source("R/sat_slope.R")
source("R/load_worldclim.R")
source("R/plot_trait_by_dataset.R")

library(lubridate)
library(R.utils)

# load trait data
austraits <- readRDS("data/austraits_develop.RDS")


```

```{r}
# sum_no_NA <- function(x) if(all(is.na(x))) NA_integer_ else sum(x, na.rm=TRUE)
```


```{r}
#where are sites located?

location_of_sites <-
  austraits$sites %>%
  filter(site_property %in% c("longitude (deg)", "latitude (deg)")) %>%
  spread(site_property, value) %>%
  rowid_to_column("ID") %>%
  rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
  mutate_at(c("latitude", "longitude"), ~suppressWarnings(as.numeric(.x))) %>%
  drop_na(longitude, latitude)


# load map of australia (required for climate data analysis)
au_map <- raster::raster("data/australia.tif")
```

Start with solar which has the highest temporal resolution (i.e. unique daily values)

```{r}
# # Finally, extract values for solar irradiance (12, 16-27th November 2009 missing, 2014 incomplete)
# 
# #This function compiles extracts point values from daily spatial files and compiles these values into yearly csvs
# # compile_daily_solar_data()
# #This function reads yearly csvs and compiles them into a total data frame
# read_and_combine_compiled_solar_data()
# 
# available_years <- c(1990:2008, 2010:2013)
# 
# read_csv("data/AWAP_solar/compiled_annual_solar/compiled_total_solar_data.csv") %>%
#   filter(year %in% available_years) %>%
#   mutate(day = as.numeric(day)) -> solar_data
```

```{r}
# #all other data is on at least a monthly scale, so let's convert solar to monthly before joining all enviro variables together (Solar has daily data for 1990 - 2013)
# 
# solar_data_monthly <- solar_data %>%
#   group_by(ID, year, month) %>%
#   summarise(mean_monthly_shortwave_radiation = mean(shortwave_radiation, na.rm=T))
# 
# #remove the daily dataset to free up computational resources
# rm(solar_data)
```

Next, data for which we have unique monthly data within years.

Start with Australian water availability project data

```{r}
# # First, extract values for 9am vapour pressure (hPA) #2020 incomplete
# 
# # compile_vp_09_data()
# 
# vp_09_data <- read_csv("data/agcd/v1/vapourpres_h09_monthly/mean/r005/01month/compiled_h09_data/compiled_h09_data.csv") %>%
#   select(-day) %>%
#   filter(year !="2020")

```

```{r}
# # Next, extract values for 3pm vapour pressure (hPA) #2020 incomplete
# 
# # compile_vp_15_data()
# 
# vp_15_data <- read_csv("data/agcd/v1/vapourpres_h15_monthly/compiled_h15_data/compiled_h15_data.csv") %>%
#   select(-day)%>%
#   filter(year !="2020")

```

```{r}
# # compile_annual_rainfall_data()
# 
# annual_rainfall_data <- read_csv("data/agcd/v2/r005/01month/compiled_rainfall_data/compiled_rainfall_data.csv") %>%select(-day) %>%
#   filter(year !="2020") %>%
#   rename(prec_AWAP = prec)
```

```{r}
# # compile_max_T_data()
# 
# max_t_data <- read_csv("data/agcd/v1/monthly_tmax/compiled_temperature_data/compiled_temperature_data.csv") %>%select(-day) %>%
#   filter(year !="2020")
```

Now, data from CRU clim

```{r}
# # gunzip("data/CRU/pet/cru_ts4.05.1901.2020.pet.dat.nc.gz", remove=FALSE)
# # pet_path <- "data/CRU/pet/cru_ts4.05.1901.2020.pet.dat.nc"
# # pet_data <- load_CRU_clim(pet_path)
# # write_csv(pet_data, "data/CRU/pet/pet_data.csv")
# 
# pet_data <- read_csv("data/CRU/pet/pet_data.csv")  %>%
#   rename(pet_CRU = value)%>%
#   mutate(date = paste(year, month, day, sep="-")) %>%
#   mutate(date = ymd(date)) %>%
#   mutate(num_days = days_in_month(date)) %>%
#   mutate(monthly_pet_CRU = pet_CRU*num_days) -> pet_data
```


```{r}
# # gunzip("data/CRU/temp_avg/cru_ts4.05.1901.2020.tmp.dat.nc.gz", remove=FALSE)
# # temp_avg_path <- "data/CRU/temp_avg/cru_ts4.05.1901.2020.tmp.dat.nc"
# # temp_avg_data <- load_CRU_clim(temp_avg_path)
# # write_csv(temp_avg_data, "data/CRU/temp_avg/temp_avg_data.csv")
# 
# temp_avg_data <- read_csv("data/CRU/temp_avg/temp_avg_data.csv") %>%
#   rename(temp_avg_CRU = value) %>%
#   mutate(sat_slope = sat_slope_func(temp_avg_CRU))
```

```{r}
# # gunzip("data/CRU/cloud/cru_ts4.05.1901.2020.cld.dat.nc.gz", remove=FALSE)
# # cloud_path <- "data/CRU/cloud/cru_ts4.05.1901.2020.cld.dat.nc"
# # cloud_data <- load_CRU_clim(cloud_path)
# # write_csv(cloud_data, "data/CRU/cloud/cloud_data.csv")
# 
# cloud_data <- read_csv("data/CRU/cloud/cloud_data.csv") %>%
#   rename(cloudiness = value)
```


Elevation has just average values for each site, but is needed for SPLASH to calculate net radiation

```{r}
# elevation <- load_elevation()
```

```{r}
# data_for_splash <- cloud_data %>%
#   left_join(temp_avg_data) %>%
#   left_join(elevation)
# 
# data_for_splash %>%
#   mutate(date = paste(year, month, day, sep="-")) %>%
#   mutate(date = ymd(date)) %>%
#   mutate(doy = yday(date)) %>%
#   mutate(sun_frac = (100-cloudiness)/100) -> data_for_splash
# 
# # write_csv(data_for_splash,"data/splash_input.csv")
```

```{r}
# #net radiation from SPLASH
# 
# net_rad_paths<-paste("data/net_rad/", list.files("data/net_rad"), sep="")
# map(net_rad_paths, read_csv) %>%
#   bind_rows() %>%
#   select(-sat_slope) %>%
#   mutate(net_rad_w = net_rad/24/60/60) -> net_rad 
```


```{r}
# left_join(data_for_splash, net_rad) %>%
#   left_join(pet_data) %>%
#   left_join(annual_rainfall_data) %>% 
#   left_join(vp_09_data) %>%
#   left_join(vp_15_data) %>%
#   left_join(solar_data_monthly) %>%
#   left_join(max_t_data) %>%
#   mutate(days_in_month = lubridate::days_in_month(date)) %>%
#   mutate(eet_day = net_rad_w*sat_slope/(sat_slope+65)/(2.45*1000000)*24*60*60) %>%
#   mutate(eet_month = eet_day*days_in_month) -> compiled_monthly_dataset

```


Next, prepare monthly data from the Worldclim dataset. Worldclim has monthly values averaged across years

```{r}
# load_worldclim("data/wc2.1_2.5m_tavg/", "avg_temp_wordlclim")
# 
# avg_temp_data <- read_csv("data/wc2.1_2.5m_tavg/avg_temp_wordlclim.csv")
# 
# avg_temp_data %>%
#   group_by(ID) %>%
#   summarise(avg_temp_WC = mean(value, na.rm=T)) %>%
#   drop_na() -> avg_temp_WC
# 
# #growing season temperature excludes months where the average monthly temperature is less than 5
# 
# avg_temp_data %>%
#   filter(value > 5) %>%
#   group_by(ID) %>%
#   summarise(avg_gs_temp_WC = mean(value)) -> avg_growing_season_temp_WC

```

```{r}
# load_worldclim("data/wc2.1_2.5m_srad/", "solar_wordlclim")
# 
# solar_worldclim_data <- read_csv("data/wc2.1_2.5m_srad/solar_wordlclim.csv")
# 
# solar_worldclim_data %>%
#   group_by(ID) %>%
#   summarise(solar_WC = mean(value, na.rm=T)) %>%
#   drop_na() -> solar_worldclim
```

```{r}
# climate_data <- compiled_monthly_dataset %>%
#   left_join(avg_temp_WC) %>%
#   left_join(avg_growing_season_temp_WC) %>%
#   left_join(solar_worldclim)
```


```{r}
# #add vapour pressure deficit to dataframe using formulas for saturated vapour pressure (esat; kPa) and vapour pressure deficit (VPD; kPa) in Monteith JL & Unsworth MH (1990) Principles of environmental physics
# 
# es_T_star = 0.611 #kPa
# T_dash = 36.0;  #K
# T_star = 273.0; #K
# A = 17.27
# DEG_TO_KELVIN = 273.0 # convert celcius to kelvins
# hPa_to_kPA = 1/10 #vapour pressure is in hPa
# 
# climate_data$max_t_K<- climate_data$max_t+DEG_TO_KELVIN
# 
# climate_data$esat = es_T_star * exp(A * (climate_data$max_t_K - T_star) / (climate_data$max_t_K - T_dash))
# 
# #convert vapour pressure to kPa
# 
# climate_data$vp_09_kpa <- climate_data$vp09 * hPa_to_kPA
# climate_data$vp_15_kpa <- climate_data$vp15 * hPa_to_kPA
# 
# #VPD is saturated vapour pressure minus vapour pressure
# 
# climate_data$VPD_09 <- climate_data$esat - climate_data$vp_09_kpa
# climate_data$VPD_15 <- climate_data$esat - climate_data$vp_15_kpa
```

```{r}
# #calculate a yearly value for each site, we want the sum of the monthly sums of rainfall and eet, and the average for the remaining variables
# 
# climate_data_yearly_summary <- climate_data %>%
#   group_by(year, ID, longitude,latitude) %>%
#   summarise(temp_avg_CRU = mean(temp_avg_CRU, na.rm=T),
#             temp_avg_WC = mean(avg_temp_WC, na.rm=T),
#             temp_avg_gs_WC = mean(avg_gs_temp_WC, na.rm=T), 
#             eet_annual = sum_no_NA(eet_month), 
#             VPD_09 = mean(VPD_09, na.rm=T), 
#             VPD_15 = mean(VPD_15, na.rm=T), 
#             annual_prec_AWAP=sum_no_NA(prec_AWAP),
#             annual_pet_CRU=sum_no_NA(monthly_pet_CRU),
#             mean_annual_shortwave_radiation_AWAP=mean(mean_monthly_shortwave_radiation, na.rm=T), 
#             mean_annual_shortwave_radiation_WC = mean(solar_WC,na.rm=T)) %>%
#   mutate(MI = annual_prec_AWAP/eet_annual)

```

```{r}
# #set up a yearly value for each site
# climate_data_site_level_average <- climate_data_yearly_summary %>%
#   group_by(ID) %>%
#   summarise(VPD_09 = mean(VPD_09, na.rm=T), 
#             VPD_15 = mean(VPD_15, na.rm=T), 
#             annual_prec_AWAP = mean(annual_prec_AWAP,na.rm=T),
#             annual_pet_CRU = mean(annual_pet_CRU, na.rm=T),
#             mean_annual_shortwave_radiation_AWAP = mean(mean_annual_shortwave_radiation_AWAP, na.rm=T),
#              mean_annual_shortwave_radiation_WC = mean(mean_annual_shortwave_radiation_WC, na.rm=T),
#             mean_eet_annual = mean(eet_annual,na.rm=T), 
#             mean_MI = mean(MI, na.rm=T), 
#             mean_temp_avg_CRU = mean(temp_avg_CRU, na.rm=T),
#             mean_temp_avg_WC = mean(temp_avg_WC, na.rm=T),
#             mean_temp_avg_gs_WC = mean(temp_avg_gs_WC, na.rm=T))
```


```{r}
# #bind wordclim data to compare temp and rainfall data to
# 
# #load bioclim data
# au_bioclim <- load_climate_data()
# 
# au_sites_bioclim <-
#   austraits$sites %>%
#   filter(site_property %in% c("longitude (deg)", "latitude (deg)")) %>%
#   spread(site_property, value) %>%
#   rowid_to_column("ID") %>%
#   rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
#   mutate_at(c("latitude", "longitude"), ~suppressWarnings(as.numeric(.x))) %>%
#   combine_occurence_climate(au_bioclim)

```

```{r}
# combined_climate_data <- left_join(climate_data_site_level_average, au_sites_bioclim)
# 
# saveRDS(combined_climate_data, "data/combined_climate_data.RDS")
```

```{r}
annual_PET_worldclim <- raster::raster("data/Australia_current_2.5arcmin_geotiff/current_2-5arcmin_annualPET.tif")

new_annual_PET_worldclim  <- raster::projectRaster(annual_PET_worldclim, au_map) 
    coordinates <- select(location_of_sites, longitude, latitude)
    raster::extract(x = new_annual_PET_worldclim,  y = sp::SpatialPoints(coordinates),method = "simple") %>% 
      as_tibble() %>% 
      mutate(ID = location_of_sites$ID,longitude = location_of_sites$longitude, latitude = location_of_sites$latitude) %>% 
      gather(key,value,-longitude, -latitude, -ID) %>%
      mutate(key = str_sub(key, -2)) %>%
      rename(month = key) -> extracted_annual_PET_worldclim

combined_climate_data <- readRDS("data/combined_climate_data.RDS")
```

```{r}
traits <- austraits$traits %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass","leaf_N_per_area","ci_over_ca","wood_density","plant_height", "seed_mass", "leaf_delta13C","huber_value")) %>%
  mutate(value = as.numeric(value)) %>%
  left_join(combined_climate_data)
```


```{r}
field_traits <- traits %>%
  filter(!(dataset_id %in% c("Ahrens_2019", "Crous_2013", "Crous_2019", "Du_2018",
                            "Du_2019", "Duan_2015", "EsperonRodriguez_2019",
                            "EsperonRodriguez_2020","Everingham_2020",
                            "Farrell_2012", "Farrell_2013", "Farrell_2017", "Firn_2019",
                            "Gallagher_2011_1", "Gallagher_2011_3", "Gallagher_2015", 
                            "Gardiner_2019", "Geange_2017", "Geange_2020", "Ghannoum_2010",
                            "Harrison_2009",
                            "Hassiotou_2009", "Huang_2015", "Jagdish_2020", "Lewis_2015",
                            "Lusk_2012", "Lusk_2014", "Moore_2019_2", "Reynolds_2018",
                            "Roderick_2002", "Schulze_2006", "Smith_2012",
                            "Tomlinson_2013","Tomlinson_2019", "Turner_2010", "Vesk_2019",
                            "Vlasveld_2018", "Warren_2005", "Warren_2006"))) %>%
  filter(!(site_name %in% c("Currency Creek Arboretum","Currency Creek Arboretum, South Australia",
                            "Australian National University glasshouse","MU_campus",
                            "Australian National Botanic Gardens","Australian National University"))) 
```

We also remove all trait values which are records across multiple sites, are from the literature, expert values, or are from unknown sources

```{r}
field_traits %>%
  filter(value_type %in% c("raw_value", "site_mean", "site_max", "individual_mean") | trait_name == "plant_height") -> field_traits
```


Create a new trait dataframe to only include observations with associated latitude and longitude
```{r}
field_traits_georef <- 
  field_traits %>%
  drop_na(lat,lon)
```

```{r}

woody_plant_growth_forms <- c("hemi-epiphyte_shrub", "hemi-epiphyte_tree", "leafless_shrub_tree", "parasite_woody", "subshrub", "shrub", "treelet", "tree", "shrub tree", "shrub treelet",
"shrub subshrub","herb subshrub", "herb_large shrub", "herb shrub", "tree tree")

austraits$traits %>% 
  filter(trait_name== "plant_growth_form") %>%
  group_by(taxon_name) %>% 
  filter(all((value %in% woody_plant_growth_forms))) %>%
  ungroup() %>%
  distinct(taxon_name)-> woody_taxa_plant_growth_form

austraits$traits %>% 
  filter(trait_name == "woodiness") %>% 
  group_by(taxon_name) %>%
  filter(all(value %in% c("woody","semi_woody"))) %>%
  distinct(taxon_name)%>%
  bind_rows(woody_taxa_plant_growth_form) %>%
    distinct(taxon_name) -> woody_taxa

# list of species which did not have woody data, updated with data pulled off internet
read_csv("data/no_woody_data_updated.csv") %>%
  filter(woodiness %in% c("woody","semi_woody")) %>%
           distinct(taxon_name) %>%
           bind_rows(woody_taxa) %>%
           distinct(taxon_name) -> woody_taxa

```

Create a new trait dataframe to only include observations with associated latitude and longitude
```{r include=FALSE}
woody_field_traits_georef <- 
  field_traits_georef %>%
  filter(taxon_name %in% woody_taxa$taxon_name)
```

```{r include=FALSE}
ferns_species <-
  austraits$taxa%>%
  filter(family %in% c("Schizaeaceae", "Gleicheniaceae","Dennstaedtiaceae", "Polypodiaceae","Dicksoniaceae", "Datiscaceae"))

palm_species <-
  austraits$taxa%>%
  filter(family %in% c("Arecaceae"))

cycad_species <-
  austraits$taxa%>%
  filter(family %in% c("Cycadaceae","Zamiaceae", "Stangeriaceae"))

graminoid_species <- 
  austraits$taxa %>%
  filter(family %in% c("Poaceae","Cyperaceae","Restionaceae"))

ginger_species <- 
  austraits$taxa %>%
  filter(family %in% c("Zingiberaceae"))

woody_field_traits_georef %>%
  filter(!taxon_name %in% ferns_species$taxon_name) %>%
  filter(!taxon_name %in% palm_species$taxon_name)%>%
  filter(!taxon_name %in% cycad_species$taxon_name)%>%
  filter(!taxon_name %in% graminoid_species$taxon_name)%>%
  filter(!taxon_name %in% ginger_species$taxon_name) ->
  woody_field_traits_georef_tree_form
```

For species with more than one observation, we can check to see if their values are relatively consistent by inspecting max:min ratio, sd, CV etc. We need to do this seperately for measurements involving leaves and for the rest of the traits because of the fact that hte leaf vs. leaflet perspective will lead to large differences in measurements


```{r}
read_csv("data/datasets_with_leaf_area_or_dry_mass.csv") %>%
  select(dataset_id, compound_species, leaf_unit_measured)-> leaf_area_leaf_dry_mass_studies

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "no_compound") -> no_compound

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "compound_present" & leaf_unit_measured == "leaflet") -> compound_leaflet

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "compound_present" & leaf_unit_measured %in% c(NA,"leaf")) %>%
  mutate(trait_name = paste(trait_name, "_leaf_unit", sep=""))-> compound_leaf

leaf_leaflet <- bind_rows(no_compound, compound_leaflet)  %>%
  mutate(trait_name = paste(trait_name, "_leaflet_unit", sep=""))
```


```{r}
leaf_leaflet %>% 
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100) %>%
  filter(max_min_ratio > 10)-> error_check_leaf_leaflet

leaf_leaflet %>%
  filter(taxon_name %in% error_check_leaf_leaflet$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_leaf_leaflet) -> error_check_leaf_leaflet

compound_leaf %>% 
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100) %>%
  filter(max_min_ratio > 10)-> error_check_leaf_leaf

compound_leaf %>%
  filter(taxon_name %in% error_check_leaf_leaf$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_leaf_leaf) -> error_check_leaf_leaf
```

Dong_et_al_2017 leaf area and dry mass values appear to be consistentely larger than expected so we will remove these values

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(dataset_id == "Dong_2017" & trait_name %in% c("leaf_area","leaf_dry_mass"))) -> woody_field_traits_georef_tree_form
```

Error checking for specific leaf area

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "specific_leaf_area") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_SLA

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_SLA$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_SLA) -> error_check_SLA
```

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(observation_id == "Kanowski_2000_196" & trait_name == "specific_leaf_area" & taxon_name == "Endiandra insignis")) -> woody_field_traits_georef_tree_form

```

Error checking for leaf N per area

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "leaf_N_per_area") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>1) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_leaf_N

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_leaf_N$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_leaf_N)-> error_check_leaf_N
```

Remove errroneous leaf_n_per_area values

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(observation_id == "Prior_2003_157" & taxon_name == "Corymbia foelscheana" & trait_name == "Leaf_N_per_area")) -> woody_field_traits_georef_tree_form
```

Error checking for wood density

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "wood_density") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_wood_density

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_wood_density$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_wood_density)-> error_check_wood_density
```

Error checking for plant height

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "plant_height") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_plant_height

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_plant_height$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_plant_height)-> error_check_plant_height
```

Error checking for ci:ca ratio

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "ci_over_ca") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_ci_over_ca

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_ci_over_ca$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_ci_over_ca)-> error_check_ci_over_ca
```

Remove erroneous ci_ca_ratio values

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(observation_id == "Bloomfield_2018_1100" & taxon_name == "Eucalyptus camaldulensis" & trait_name == "ci_over_ca")) %>%
  filter(!(observation_id == "Bloomfield_2018_0977" & taxon_name == "Eucalyptus salmonophloia" & trait_name == "ci_over_ca")) -> woody_field_traits_georef_tree_form
```


Error checking for leaf_delta13C

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "leaf_delta13C") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_leaf_delta13C

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_leaf_delta13C$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_leaf_delta13C)-> error_check_leaf_delta13C
```

To see if there any instances where data is shared between studies, we inspect occurrences of identical trait values for each trait~species group. Although there are a number of cases where this occurs, most seem to be coincidental.

```{r}
woody_field_traits_georef_tree_form %>%
  group_by(value, taxon_name, trait_name) %>% 
  filter(n()>1) %>% 
  filter(n_distinct(dataset_id)>1) -> identical_values
```

Combine leaf mass and area back onto dataframe now that it is seperated into studies which considered the leaflet scale vs. leaf scale

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(trait_name %in% c("leaf_area", "leaf_dry_mass"))) %>%
  bind_rows(leaf_leaflet) %>%
  bind_rows(compound_leaf) -> woody_field_traits_georef_tree_form
```

We will now inspect distribution of data in each study relative to total distribution to see if there is any erroneous data
```{r eval=FALSE, include=FALSE}
# traits_to_inspect <- woody_field_traits_georef_tree_form %>%
#    distinct(trait_name)
# 
# trait_by_dataset_core_traits<-function(trait){
# 
# woody_field_traits_georef_tree_form %>%
#   filter(trait_name == trait) %>%
#   distinct(dataset_id) -> dataset_index
# 
# purrr::map(dataset_index$dataset_id, plot_trait_by_dataset, trait)
# }
# 
# purrr::map(traits_to_inspect$trait_name, trait_by_dataset_core_traits)
```

Remove some outliers based on the distributions above
(Wood density: fine
Specific leaf area: inspected)


```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(trait_name == "leaf_delta13C"& taxon_name == "Atriplex stipitata"& observation_id == "Wright_2002_039")) %>%
  filter(!(trait_name == "specific_leaf_area" & dataset_id == "Angevin_2011"))%>%
  filter(!(trait_name == "specific_leaf_area"& dataset_id == "Dwyer_2017"&taxon_name == "Pimelia imbricata")) %>%
  filter(!(trait_name == "specific_leaf_area"& dataset_id == "Schulze_1998"&taxon_name == "Grevillea pyramidalis")) %>%
  filter(!(trait_name == "specific_leaf_area"& observation_id == "Burrows_2001_204"&taxon_name == "Melichrus urceolatus"))%>%
  filter(!(trait_name == "specific_leaf_area"& observation_id == "Fonseca_2000_0603"&taxon_name == "Xanthorrhoea sp."))%>%
  filter(!(trait_name == "specific_leaf_area"& observation_id == "Knox_2011_13"&taxon_name == "Calytix_tetragona"))%>%
  filter(!(trait_name == "leaf_N_per_dry_mass"& observation_id == "Soper_2014_121"&taxon_name == "Grevillea wickhamii"))%>%
  filter(!(trait_name == "leaf_N_per_area"& observation_id == "Schulze_1998_090"&taxon_name == "Grevillea pyramidalis")) %>%
#remove Schulze_1998_090 Grevillea pyramidalis entirely, two suspect values
filter(!(observation_id == "Schulze_1998_090"&taxon_name == "Grevillea pyramidalis")) -> woody_field_traits_georef_tree_form
 
```

Calculate leaf_N_per_area and leaf_area for additional observations:
```{r include=FALSE}
woody_field_traits_georef_tree_form %>% 
  filter(trait_name %in% c("leaf_dry_mass_leaflet_unit","leaf_dry_mass_leaf_unit","leaf_area_leaflet_unit","leaf_area_leaf_unit","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass","leaf_N_per_area")) %>%
  select(ID, trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date) %>%
    group_by(ID, trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  mutate(value = as.numeric(value)) %>%
    pivot_wider(names_from = trait_name, values_from = value) %>%
  mutate(leaf_area_combined = ifelse(!is.na(leaf_area_leaflet_unit),leaf_area_leaflet_unit,specific_leaf_area*leaf_dry_mass_leaflet_unit)) %>%
  mutate(specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area),specific_leaf_area,leaf_area_leaflet_unit/leaf_dry_mass_leaflet_unit)) %>%
  mutate(specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area_combined),specific_leaf_area_combined,leaf_area_leaf_unit/leaf_dry_mass_leaf_unit)) %>%
  mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area_combined,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass_leaflet_unit/leaf_area_leaflet_unit,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA)) %>%
   mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass_leaf_unit/leaf_area_leaf_unit,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA))->calculated_data
  
  
calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_N_per_area_combined) %>%
  filter(!is.na(leaf_N_per_area_combined)) %>%
  mutate(units = "g/m2",
         trait_name = "leaf_N_per_area_calc",
         value = leaf_N_per_area_combined) %>%
  select(-leaf_N_per_area_combined) -> leaf_N_per_area_calcuated

calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_area_combined) %>%
  filter(!is.na(leaf_area_combined)) %>%
  mutate(units = "mm2",
         trait_name = "leaf_area_calc",
         value = leaf_area_combined) %>%
  select(-leaf_area_combined) -> leaf_area_calcuated

calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         specific_leaf_area_combined) %>%
  filter(!is.na(specific_leaf_area_combined)) %>%
  mutate(units = "mm2/mg",
         trait_name = "specific_leaf_area_calc",
         value = specific_leaf_area_combined) %>%
  select(-specific_leaf_area_combined) -> specific_leaf_area_calcuated


```

Extract values for ci:ca ratios from delta13c using equations in Farqhuar (1989) and Wang et al. (2017)

Carbon isotope discrimination values are dervied from delta_13C $\delta ^{13}C$ using the following equation from Farqhuar (1989):

$$\Delta = \frac{\delta_a-\delta ^{13}C}{1+\delta ^{13}C/1000}$$

The ci:ca ratio $(X)$ is linked to the carbon isotope discrimination value of plant samples according the following equation:

$$X = \frac{\Delta-a}{b-a},$$
where a’ and b’ have standard values 4.4‰ and 27‰, representing the diffusional 
and biochemical components of carbon isotope discrimination, respectively (Wang et al. 2017).


``` {r}
woody_field_traits_georef_tree_form %>% 
  filter(trait_name %in% c("ci_over_ca", "leaf_delta13C")) %>%
  select(trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date) %>%
  mutate(value = as.numeric(value)) %>%
  group_by(trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  spread(key = trait_name, value = value)%>%
  mutate(delta_C = (-8-leaf_delta13C)/(1+leaf_delta13C/1000))%>%
  mutate(ci_over_ca_calc = (delta_C-4.4)/(27-4.4)) %>%
  mutate(ci_over_ca_combined = ifelse(!is.na(ci_over_ca),ci_over_ca,ci_over_ca_calc)) ->calculated_data

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         ci_over_ca_combined) %>%
  filter(!is.na(ci_over_ca_combined)) %>%
  mutate(units = "unitless",
         trait_name = "ci_over_ca_calc",
         value = as.character(ci_over_ca_combined)) %>%
  select(-ci_over_ca_combined) -> ci_over_ca_calculated

```


``` {r, fig.width=10}
# 
# calculated_data %>% drop_na(leaf_delta13C, ci_over_ca)%>% mutate(proportion_difference = abs(ci_over_ca - ci_over_ca_calc)/ci_over_ca_calc) -> ci_over_ca_validation
# 
# 
# hist(ci_over_ca_validation$proportion_difference, xlab = "abs(Observed_X-Predicted_X)/Predicted_X", main = "Difference between observed and predicted X")
```


``` {r, fig.width=10}
#add a 1:1 line

# ci_over_ca_validation %>% ggplot(aes(x=ci_over_ca, y=leaf_delta13C))+geom_point()+theme(axis.text=element_text(size=12),
#         axis.title=element_text(size=14,face="bold"))
# 
# ci_over_ca_validation %>% ggplot(aes(x=ci_over_ca, y=ci_over_ca_calc))+geom_point()+xlab("Observed ci_over_ca")+ylab("Estimated ci_over_ca")+theme(axis.text=element_text(size=12),
#         axis.title=element_text(size=14,face="bold"))
```

Bind cliamte data to the summarised data frame
```{r}
extracted_annual_PET_worldclim <- extracted_annual_PET_worldclim %>% select(ID, value) %>%
  rename(PET_WC = value)

woody_field_traits_georef_tree_form %>%
  bind_rows(leaf_N_per_area_calcuated) %>%
  bind_rows(leaf_area_calcuated) %>%
  bind_rows(specific_leaf_area_calcuated) %>%
  group_by(site_name, taxon_name, dataset_id, trait_name, ID) %>%
  summarise(value=mean(value, na.rm=T)) %>%
  ungroup() %>%
  left_join(combined_climate_data) %>%
  left_join(extracted_annual_PET_worldclim)-> woody_field_traits_georef_tree_form_climate
```

We will now inspect distribution of data in each study relative to total distribution to see if there is any erroneous data now that data has been averaged
```{r}
traits_to_inspect <- woody_field_traits_georef_tree_form %>%
   distinct(trait_name)

trait_by_dataset_core_traits<-function(trait) {
  woody_field_traits_georef_tree_form %>%
  filter(trait_name == trait) %>%
  distinct(dataset_id) -> dataset_index_leaf_area

purrr::map(dataset_index_leaf_area$dataset_id, plot_trait_by_dataset_site_level, trait)
}

purrr::map(traits_to_inspect$trait_name, trait_by_dataset_core_traits)
```



```{r}
# library(sf)
# library(rgeos)
# library("ggspatial")
# library("rnaturalearth")
# library("rnaturalearthdata")
# 
# world <- ne_countries(scale = "medium", returnclass = "sf")

# gene world map
```


```{r, fig.height==15, fig.width=15}
# ggplot(data = world) +
#   geom_sf() +
#   labs( x = "Longitude", y = "Latitude") +
#   coord_sf(xlim = c(100.00, 160.00), ylim = c(-45.00, -10.00)) +
#   annotation_scale(location = "bl", width_hint = 0.5) +
#   annotation_north_arrow(location = "bl", which_north = "true", 
#                          pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
#                          style = north_arrow_fancy_orienteering) +
#   geom_point(data=woody_field_traits_georef_core_traits, aes(x=lon, y=lat, colour=annual_prec)) +
#   theme_bw() +
  # facet_wrap(~trait_name)
```


```{r, fig.height==15, fig.width=15}
# ggplot(data = world) +
#   geom_sf() +
#   labs( x = "Longitude", y = "Latitude") +
#   coord_sf(xlim = c(100.00, 160.00), ylim = c(-45.00, -10.00)) +
#   annotation_scale(location = "bl", width_hint = 0.5) +
#   annotation_north_arrow(location = "bl", which_north = "true", 
#                          pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
#                          style = north_arrow_fancy_orienteering) +
#   geom_point(data=woody_field_traits_georef_core_traits, aes(x=lon, y=lat, colour=mean_annual_shortwave_radiation)) +
#   theme_bw()+
#   facet_wrap(~trait_name)
```


```{r, fig.height==15, fig.width=15}
# ggplot(data = world) +
#   geom_sf() +
#   labs( x = "Longitude", y = "Latitude") +
#   coord_sf(xlim = c(100.00, 160.00), ylim = c(-45.00, -10.00)) +
#   annotation_scale(location = "bl", width_hint = 0.5) +
#   annotation_north_arrow(location = "bl", which_north = "true", 
#                          pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
#                          style = north_arrow_fancy_orienteering) +
#   geom_point(data=woody_field_traits_georef_core_traits, aes(x=lon, y=lat, colour=max_t)) +
#   theme_bw()+
#   facet_wrap(~trait_name)
```


```{r, fig.height==15, fig.width=15}
# ggplot(data = world) +
#   geom_sf() +
#   labs( x = "Longitude", y = "Latitude") +
#   coord_sf(xlim = c(100.00, 160.00), ylim = c(-45.00, -10.00)) +
#   annotation_scale(location = "bl", width_hint = 0.5) +
#   annotation_north_arrow(location = "bl", which_north = "true", 
#                          pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
#                          style = north_arrow_fancy_orienteering) +
#   geom_point(data=woody_field_traits_georef_core_traits, aes(x=lon, y=lat, colour=VPD_15)) +
#   theme_bw()+
#   facet_wrap(~trait_name)

```

Basic patterns with environment

```{r}

core_traits <- c("huber_value","ci_over_ca","leaf_N_per_area_calc","specific_leaf_area_calc","wood_density","plant_height","leaf_area_calc")

```

```{r, fig.width=10}
library("wesanderson")
pal<-wesanderson::wes_palette("Darjeeling1", 5)

trait_names <- tibble(trait_name = core_traits,
                      trait = c("huber","ci:ca","leaf_N", "SLA", "Wood_dens", "height", "leaf_area"))

woody_field_traits_georef_tree_form_climate %>%
  filter(trait_name %in% core_traits) %>%
  left_join(by="trait_name", trait_names) %>%
  select(trait, value, Temp = mean_temp_avg_CRU, VPD = VPD_15, PAR = mean_annual_shortwave_radiation_AWAP, MI = mean_MI, Prec_CV = Prec_CV_BC) %>%
  pivot_longer(-c("trait", "value"), names_to = "env", values_to = "env_value") %>%
  mutate(env = factor(env, levels = c("MI", "Temp", "VPD","PAR","Prec_CV"))) ->data_for_plot


png("output/trait_by_environment_viridis_high_res_small_axes.png", height=1200, width=2000, res=300)
data_for_plot %>% 
  ggplot(aes(env_value, value, col = trait)) + geom_point(alpha = 0.3, shape=16, stroke=0, show.legend = F) + scale_y_log10()   +scale_x_log10()+ theme_classic() + facet_grid(trait ~ env, scales = "free")+ scale_colour_viridis(discrete = TRUE) +theme(axis.title.x=element_blank()) +theme(axis.title.y=element_blank()) +
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 6), axis.text=element_text(size=7))
dev.off()

woody_field_traits_georef_tree_form_climate %>%
  filter(trait_name %in% c("leaf_N_per_area_calc")) -> leaf_n_data
  
fit<-(lm(log(value)~mean_MI+mean_temp_avg_CRU+VPD_15, leaf_n_data))
fit1<-(lm(log(value)~mean_temp_avg_CRU+VPD_15+mean_annual_shortwave_radiation_AWAP, leaf_n_data))
fit2<-(lm(log(value)~mean_MI+VPD_15+mean_annual_shortwave_radiation_AWAP, leaf_n_data))
fit3<-(lm(log(value)~mean_MI+mean_temp_avg_CRU+mean_annual_shortwave_radiation_AWAP, leaf_n_data))
fit4<-(lm(log(value)~mean_MI, leaf_n_data))

resid <- resid(fit)
resid1 <- resid(fit1)
resid2 <- resid(fit2)
resid3 <- resid(fit3)
resid4 <- resid(fit4)

visreg

visreg:::setupV
visreg:::getXY
visreg:::setupD
visreg:::Response
visreg:::visregResid
visreg:::visregPred


rr <- residuals(fit)
nr <- length(rr)

a<-visreg(fit, "mean_MI")
b<-visreg(fit, "mean_temp_avg_CRU")
c<-visreg(fit, "mean_annual_shortwave_radiation_AWAP")
d<-visreg(fit, "VPD_15")

tibble(a=a$res$visregRes, b=b$res$visregRes)

predict(fit, type="terms") -> terms
rowSums(terms[,c(2,3)]) -> terms_rowSums
(terms_rowSums + resid(fit)) -> partial_resid


partial_resid_comparison = tibble(manual_partial_resid=rep(NA, nrow(terms)), visreg_partial_resid=rep(NA, nrow(terms)))

for(i in 1:nrow(terms)){
manual_partial_resid<- coef(fit) %*% c(1, leaf_n_data$mean_MI[i], median(leaf_n_data$mean_temp_avg_CRU),median(leaf_n_data$VPD_15)) +partial_resid[i]

partial_resid_comparison$visreg_partial_resid[i] <- a$res$visregRes [i]
partial_resid_comparison$manual_partial_resid[i] <- manual_partial_resid
}
plot(partial_resid_comparison$visreg_partial_resid~partial_resid_comparison$manual_partial_resid)


rowSums(terms[,c(2,3)]) -> terms_rowSums
(terms_rowSums + resid(fit))[1] -> partial_resid
manual_partial_resid<- coef(fit) %*% c(1, leaf_n_data$mean_MI[1], mean(leaf_n_data$mean_temp_avg_CRU),mean(leaf_n_data$VPD_15)) +partial_resid

partial_resid_comparison$visreg_partial_resid[i] <- $res$visregRes [1]
partial_resid_comparison$manual_partial_resid[i] <- manual_partial_resid
}
partial_resid_comparison

partial.residuals <- apply(pterms,2,function(x)x+resid(fit))
# create our own termplot of partial residuals
par(mfrow=c(2,2))
# the model in lm.cars includes the response in first column, so we index with i + 1
for(i in 1:3){
  plot(x=fit$model[,(i+1)],y=partial.residuals[,i], col="purple")
  abline(lm(partial.residuals[,i] ~ fit$model[,(i+1)]), col="red")
}
partial.residuals()
?pterms

pterms <- predict(fit, type="terms")
partial.residuals <- apply(pterms,2,function(x)x+resid(fit))
a$res$visregPos

coef(fit) %*% c(1, leaf_n_data$mean_MI[1]-mean(leaf_n_data$mean_MI), mean(leaf_n_data$mean_temp_avg_CRU),mean(leaf_n_data$VPD_15))
```
