---
title: Report on data in AusTraits
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---

Load data
```{r, warning=FALSE, message=FALSE}
# Install dependencies as needed
# devtools::install_deps()

# Load packages and functions for this analysis
devtools::load_all()

# load data
austraits <- readRDS("data/austraits_2.1.0.9000.rds")

au_bioclim <- load_climate_data()

# match with climate data
au_sites_clim <-
  austraits$sites %>%
  filter(site_property %in% c("longitude (deg)", "latitude (deg)")) %>%
  spread(site_property, value) %>%
  rowid_to_column("ID") %>%
  rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
  mutate_at(c("latitude", "longitude"), ~suppressWarnings(as.numeric(.x))) %>%
  combine_occurence_climate(au_bioclim)
```
Calculate leaf_N_per_area and leaf_area for additional observations:
```{r}
#two current problems, in summarise argument, `first` should be `mean` but breaking on instances with a single observation (almost all). Second, this code means the newly calculated values don't have value_type and replicate linked to them
austraits$traits %>% 
  filter(trait_name %in% c("leaf_area","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass",
                           "leaf_N_per_area")) %>%
  select(trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date) %>%
  group_by(trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date) %>%
  summarise(value = first(value)) %>%
  ungroup() %>%
  spread(key = trait_name, value = value) %>% 
  mutate(specific_leaf_area = as.numeric(specific_leaf_area),
         leaf_N_per_dry_mass = as.numeric(leaf_N_per_dry_mass),
         leaf_area = as.numeric(leaf_area),
         leaf_dry_mass = as.numeric(leaf_dry_mass),
         leaf_N_per_area = as.numeric(leaf_N_per_area)) %>%
  mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass/leaf_area,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA),
         specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area),specific_leaf_area,leaf_area/leaf_dry_mass),
         leaf_area_combined = ifelse(!is.na(leaf_area),leaf_area,specific_leaf_area*leaf_dry_mass)) -> calculated_data

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_N_per_area_combined) %>%
  filter(!is.na(leaf_N_per_area_combined)) %>%
  mutate(units = "g/m2",
         trait_name = "leaf_N_per_area_calc",
         value = as.character(leaf_N_per_area_combined)) %>%
  select(-leaf_N_per_area_combined) -> leaf_N_per_area_calcuated

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_area_combined) %>%
  filter(!is.na(leaf_area_combined)) %>%
  mutate(units = "mm2",
         trait_name = "leaf_area_calc",
         value = as.character(leaf_area_combined)) %>%
  select(-leaf_area_combined) -> leaf_area_calcuated

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         specific_leaf_area_combined) %>%
  filter(!is.na(specific_leaf_area_combined)) %>%
  mutate(units = "mm2/mg",
         trait_name = "specific_leaf_area_calc",
         value = as.character(specific_leaf_area_combined)) %>%
  select(-specific_leaf_area_combined) -> specific_leaf_area_calcuated
```

Select subset of traits:
```{r}
# add max height, N_area, delta13_c
# Also do for some alternatives: e.g. leaf_width, leaf_area ?
trait_names_short <- c("leaf_width","leaf_delta13C","plant_height","leaf_N_per_area","specific_leaf_area","leaf_area", "wood_density", "seed_mass", "plant_growth_form")
trait_names <- c("leaf_N_per_area","leaf_N_per_area_calc","specific_leaf_area","specific_leaf_area_calc","leaf_area","leaf_area_calc","leaf_width","leaf_delta13C","wood_density","seed_mass","plant_height", "plant_growth_form")

traits <- 
  austraits$traits %>%
  filter(trait_name %in% trait_names_short) %>% 
  bind_rows(leaf_N_per_area_calcuated) %>%
  bind_rows(specific_leaf_area_calcuated) %>%
  bind_rows(leaf_area_calcuated) %>%
  left_join(by = c("dataset_id", "site_name"), au_sites_clim)
```

Inspect data availability across growth forms (woody vs. non-woody)

```{r}
plant_growth_form_index <- 
  traits %>%
  filter(trait_name == "plant_growth_form") %>%
  rename("plant_growth_form" = "value") %>%
  mutate(plant_form_broad = ifelse(plant_growth_form %in% c("grass-tree","herb shrub","herb subshrub","herb_large shrub","prostate_shrub","shrub subshrub","shrub tree","shrub treelet","subshrub","shrub","treelet","tree","tree tree"), "woody", "non_woody")) 

# how many species for which growth form was recorded have both woody and non-woody forms
number_of_forms_species <- plant_growth_form_index %>% 
  group_by(taxon_name) %>%
  summarise(length(unique(plant_form_broad))) %>%
  rename(number_of_forms = 2)

# join number of growth forms to plant_growth_form_index
plant_growth_form_index <- plant_growth_form_index %>%
  left_join(number_of_forms_species) %>%
  select("taxon_name", "plant_form_broad", "plant_growth_form", "number_of_forms") %>%
  group_by(taxon_name) %>%
  slice(1)

traits <- traits %>%
  filter(!trait_name=="plant_growth_form") %>%
  mutate_at("value", as.numeric)

# reintroduce plant_growth_form index to trait dataframe
traits <- traits %>%
  left_join(plant_growth_form_index) 

# how are samples distributed across species with 1, 2 or no recorded broad growth form (i.e. woody or non-woody)
table(traits$number_of_forms, useNA = "ifany")
```

54600 trait samples belong to taxa which have been recorded to have  both woody and non-woody growth forms; 5555 trait samples belong to taxa which have not yet had a growth form recorded. Note that growth form is often not available for all trait observations of a given taxa. Will need to address how species with woody and non-woody forms should be addressed.

Create trait data frame for woody taxa only

```{r}
woody_traits <- traits %>%
# remove species which had two forms - will keep ones that had no growth form identified (i.e. NAs)
  filter(is.na(number_of_forms) | number_of_forms == 1 )  %>%
# finally, remove species which were exclusively non-woody
  filter(is.na(plant_form_broad) | plant_form_broad == "woody")
```

Create a new trait dataframe to only include observations with associated latitude and longitude
```{r}
traits_georef <- 
  traits %>%
  drop_na(latitude,longitude)

woody_traits_georef <- 
  woody_traits %>%
  drop_na(latitude,longitude)

traits_site_summary <- 
  traits %>% 
  group_by(dataset_id, trait_name, latitude, longitude, Temp, Prec, Prec_CV) %>% 
  summarise(nspp=n_distinct(taxon_name))

woody_traits_site_summary <- 
  traits %>% 
  group_by(dataset_id, trait_name, latitude, longitude, Temp, Prec, Prec_CV) %>% 
  summarise(nspp=n_distinct(taxon_name))
```

Write some summaries about availability of data.....


Plots:

Austraits sites across biomes - total dataset vs. woody only dataset

```{r eval=FALSE, fig.height=12, fig.width=6, include=FALSE}
austraits_climate_space <-
  plot_climate_space(traits, au_bioclim)

austraits_climate_space_woody <-
  plot_climate_space(woody_traits, au_bioclim)

austraits_climate_space / austraits_climate_space_woody
```

Woody trait dataset

```{r eval=FALSE, fig.height=12, fig.width=6, include=FALSE}
austraits_site_by_trait <-
  plot_site_map_by_trait(traits)

austraits_site_by_trait_woody <-
  plot_site_map_by_trait(woody_traits)

austraits_site_by_trait / austraits_site_by_trait_woody
```

Shading of points (blue -> yellow) indicates the number of neighbouring points (e.g. there is substantial seed mass data in SE Australia)

Compare the number of observations and taxa in the **total dataset** for each trait which are **georeferenced vs. not georeferenced**.

```{r}
number_observations_per_trait<-traits %>%
  group_by(trait_name) %>%
  summarise(n_total_obs=length(value), n_total_taxa=length(unique(taxon_name)))

number_observations_per_trait_georeferenced<-traits_georef %>%
  group_by(trait_name) %>%
  summarise(n_georef_obs=length(value), n_georef_taxa=length(unique(taxon_name))) %>%
  left_join(number_observations_per_trait)

number_observations_per_trait_georeferenced %>% 
  relocate(n_total_obs, .after=trait_name) %>%
  relocate(n_total_taxa, .before=n_georef_taxa) %>%
  kbl(caption = "Table 1: Total trait dataset. n_total_obs: Total number of observations of a given trait, n_georef_obs: Number of observations of a given trait with georeference, n_total_taxa: Total number of taxa with at least one observation of a given trait, n_georef_taxa: Number of taxa with at least one georeferenced observation of a given trait") %>%
  kable_classic(full_width = T, html_font = "Cambria")  

```

Compare the number of observations and taxa in the **woody dataset** for each trait which are **georeferenced vs. not georeferenced**.

```{r}
number_observations_per_trait<-woody_traits %>%
  group_by(trait_name) %>%
  summarise(n_total_obs=length(value), n_total_taxa=length(unique(taxon_name)))

number_observations_per_trait_georeferenced<-woody_traits_georef %>%
  group_by(trait_name) %>%
  summarise(n_georef_obs=length(value), n_georef_taxa=length(unique(taxon_name))) %>%
  left_join(number_observations_per_trait)

number_observations_per_trait_georeferenced %>% 
  relocate(n_total_obs, .after=trait_name) %>%
  relocate(n_total_taxa, .before=n_georef_taxa) %>%
  kbl(caption = "Table 2: Woody trait dataset. n_total_obs: Total number of observations of a given trait, n_georef_obs: Number of observations of a given trait with georeference, n_total_taxa: Total number of taxa with at least one observation of a given trait, n_georef_taxa: Number of taxa with at least one georeferenced observation of a given trait") %>%
  kable_classic(full_width = T, html_font = "Cambria")  

```

Basic patterns with environment - all data

```{r, fig.width=10}
traits %>%
  #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
  mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
    ggplot(aes(Prec, value, colour=plant_form_broad)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
```

```{r, fig.width=10}
traits %>%
  #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
  mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
  ggplot(aes(Temp, value, colour=plant_form_broad)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
```

```{r, fig.width=10}
traits %>%
  #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
  mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
  ggplot(aes(Prec_CV, value, colour=plant_form_broad)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
```

Basic patterns with environment - woody only

```{r, fig.width=10}
woody_traits %>%
  #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
  mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
    ggplot(aes(Prec, value)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
```

```{r, fig.width=10}
woody_traits %>%
  #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
  mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
  ggplot(aes(Temp, value)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
```

```{r, fig.width=10}
woody_traits %>%
  #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
  mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
  ggplot(aes(Prec_CV, value)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
```


Isaac - looking to do pair-wise relationships for common trait-pairs

```{r}
# pivot trait dataframe to give traits across species from each site
woody_traits_georef_spread <- woody_traits_georef %>% 
  select(observation_id,Temp, Prec, Prec_CV, taxon_name, trait_name, value) %>% 
  pivot_wider(names_from = "trait_name", values_from = "value")%>%
  unnest(trait_names[-12]) %>%
  mutate(Temperature_binary = ifelse(Temp > median(Temp, na.rm=T), paste("Above", round(median(woody_traits_georef$Temp/10, na.rm=T),1), "C",   sep=" ") ,paste("Below", round(median(woody_traits_georef$Temp/10, na.rm=T),1), "C", sep=" "))) %>%
  mutate(Precipitation_binary = ifelse(Prec > median(Prec, na.rm=T), paste("Above", round(median(woody_traits_georef$Prec, na.rm=T),1), "mm",   sep=" ") ,paste("Below", round(median(woody_traits_georef$Prec, na.rm=T),1), "mm", sep=" "))) %>%
  mutate(Precipitation_seasonality_binary = ifelse(Prec_CV > median(Prec_CV, na.rm=T), paste("Above", round(median(woody_traits_georef$Prec_CV, na.rm=T),1),   sep=" ") ,paste("Below", round(median(woody_traits_georef$Prec_CV, na.rm=T),1), sep=" ")))

```

Plot the 5 most populous pair-wise trait combinations, including high and low climate values - please forgive the coding below, still learning how to do functions using tidyverse and ggplot


```{r echo=FALSE, fig.height= 8, fig.width= 6}
SLA_LA_Temp <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_area, colour=Temperature_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_LA_Prec <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_area, colour=Precipitation_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_LA_Prec_CV <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_area, colour=Precipitation_seasonality_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_LA_Temp / SLA_LA_Prec / SLA_LA_Prec_CV

SLA_LN_Temp <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_N_per_area, colour=Temperature_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_LN_Prec <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_N_per_area, colour=Precipitation_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_LN_Prec_CV <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_N_per_area, colour=Precipitation_seasonality_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_LN_Temp / SLA_LN_Prec / SLA_LN_Prec_CV

SLA_deltaC_Temp <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_delta13C*-1, colour=Temperature_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_deltaC_Prec <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_delta13C*-1, colour=Precipitation_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_deltaC_Prec_CV <- woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, leaf_delta13C*-1, colour=Precipitation_seasonality_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_deltaC_Temp / SLA_deltaC_Prec / SLA_deltaC_Prec_CV

LA_deltaC_Temp <- woody_traits_georef_spread %>%
  ggplot(aes(leaf_delta13C*-1, leaf_area, colour=Temperature_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

LA_deltaC_Prec <- woody_traits_georef_spread %>%
  ggplot(aes(leaf_delta13C*-1, leaf_area, colour=Precipitation_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

LA_deltaC_Prec_CV <- woody_traits_georef_spread %>%
  ggplot(aes(leaf_delta13C*-1, leaf_area, colour=Precipitation_seasonality_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

LA_deltaC_Temp / LA_deltaC_Prec / LA_deltaC_Prec_CV

SLA_WD_Temp <-woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, wood_density, colour=Temperature_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_WD_Prec <-woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, wood_density, colour=Precipitation_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_WD_Prec_CV <-woody_traits_georef_spread %>%
  ggplot(aes(specific_leaf_area, wood_density, colour=Precipitation_seasonality_binary))+geom_point()+ scale_x_log10() + scale_y_log10()

SLA_WD_Temp / SLA_WD_Prec / SLA_WD_Prec_CV

```