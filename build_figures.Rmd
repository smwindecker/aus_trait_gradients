---
title: Report on data in AusTraits
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---

Load data
```{r, warning=FALSE, message=FALSE}
# Install dependencies as needed
# devtools::install_deps()

# Load packages and functions for this analysis
devtools::load_all()

# load data
austraits <- readRDS("data/austraits_2.1.0.9000.rds")

au_bioclim <- load_climate_data()

#match with climate data
au_sites_clim <-
  austraits$sites %>%
  filter(site_property %in% c("longitude (deg)", "latitude (deg)")) %>%
  spread(site_property, value) %>%
  rowid_to_column("ID") %>%
  rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
  mutate_at(c("latitude", "longitude"), ~(as.numeric(.x)))%>%
  combine_occurence_climate(au_bioclim)

au_sites_clim %>% filter_all(any_vars(is.na(.)))


```
Calculate leaf_N_per_area and leaf_area for additional observations:
```{r}
#two current problems, in summarise argument, `first` should be `mean` but breaking on instances with a single observation (almost all). Second, this code means the newly calculated values don't have value_type and replicate linked to them
austraits$traits %>% 
  filter(trait_name %in% c("leaf_area","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass",
                           "leaf_N_per_area")) %>%
  select(trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date) %>%
  group_by(trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date) %>%
  summarise(value = first(value)) %>%
  ungroup() %>%
  spread(key = trait_name, value = value) %>% 
  mutate(specific_leaf_area = as.numeric(specific_leaf_area),
         leaf_N_per_dry_mass = as.numeric(leaf_N_per_dry_mass),
         leaf_area = as.numeric(leaf_area),
         leaf_dry_mass = as.numeric(leaf_dry_mass),
         leaf_N_per_area = as.numeric(leaf_N_per_area)) %>%
  mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass/leaf_area,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA),
         specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area),specific_leaf_area,leaf_area/leaf_dry_mass),
         leaf_area_combined = ifelse(!is.na(leaf_area),leaf_area,specific_leaf_area*leaf_dry_mass)) -> calculated_data

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_N_per_area_combined) %>%
  filter(!is.na(leaf_N_per_area_combined)) %>%
  mutate(units = "g/m2",
         trait_name = "leaf_N_per_area_calc",
         value = as.character(leaf_N_per_area_combined)) %>%
  select(-leaf_N_per_area_combined) -> leaf_N_per_area_calcuated

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_area_combined) %>%
  filter(!is.na(leaf_area_combined)) %>%
  mutate(units = "mm2",
         trait_name = "leaf_area_calc",
         value = as.character(leaf_area_combined)) %>%
  select(-leaf_area_combined) -> leaf_area_calcuated

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         specific_leaf_area_combined) %>%
  filter(!is.na(specific_leaf_area_combined)) %>%
  mutate(units = "mm2/mg",
         trait_name = "specific_leaf_area_calc",
         value = as.character(specific_leaf_area_combined)) %>%
  select(-specific_leaf_area_combined) -> specific_leaf_area_calcuated
```

Select subset of traits:
```{r}

trait_names <-c("ci_at_Amax","ci_at_Asat","ci_over_ca","hydraulic_safety_margin_50","Jmax_per_area","leaf_delta13C","leaf_dark_respiration_per_area","leaf_N_per_area_calc","leaf_transpiration_at_Asat","leaf_transpiration_at_Amax","leaf_turgor_loss_point","photosynthetic_rate_per_area_ambient","sapwood_specific_conductivity","specific_leaf_area_calc","stem_hydraulic_conductivity","stomatal_resistance_conductance_ambient","Vcmax_per_area","vessel_density","vessel_diameter","water_potential_50percent_lost_conductivity","water_potential_88percent_lost_conductivity","wood_density")

traits <- 
  austraits$traits %>%
  filter(trait_name %in% trait_names) %>%
  bind_rows(leaf_N_per_area_calcuated) %>%
  bind_rows(specific_leaf_area_calcuated) %>%
  bind_rows(leaf_area_calcuated) %>%
  left_join(by = c("dataset_id", "site_name"), au_sites_clim) %>%
  mutate(value = as.numeric(value))

```

Remove datasets where there is a mix of field sites and common garden/botanical garden sites

```{r}
field_traits <- traits %>%
  filter(!(dataset_id %in% c("Ahrens_2019", "Crous_2013", "Crous_2019", "Du_2018",
                            "Du_2019", "Duan_2015", "EsperonRodriguez_2019",
                            "EsperonRodriguez_2020","Everingham_2020",
                            "Farrell_2012", "Farrell_2013", "Farrell_2017", "Firn_2019",
                            "Gallagher_2011_1", "Gallagher_2011_3", "Gallagher_2015", 
                            "Gardiner_2019", "Geange_2017", "Geange_2020", "Ghannoum_2010",
                            "Harrison_2009",
                            "Hassiotou_2009", "Huang_2015", "Jagdish_2020", "Lewis_2015",
                            "Lusk_2012", "Lusk_2014", "Moore_2019_2", "Reynolds_2018",
                            "Roderick_2002", "Schulze_2006", "Smith_2012",
                            "Tomlinson_2013","Tomlinson_2019", "Turner_2010", "Vesk_2019",
                            "Vlasveld_2018", "Warren_2005", "Warren_2006"))) %>%
  filter(!(site_name %in% c("Currency Creek Arboretum","Currency Creek Arboretum, South Australia",
                            "Australian National University glasshouse","MU_campus",
                            "Australian National Botanic Gardens","Australian National University"))) 
```

Identify all woody taxa in austraits and subset traits dataframe with it

``` {r}

austraits$traits %>%
  filter(trait_name == "plant_growth_form") %>%
  filter(value %in% c("hemi-epiphyte_shrub", "hemi-epiphyte_tree", "leafless_shrub_tree", "parasite_woody", 
                       "subshrub", "shrub", "treelet", "tree", "shrub tree", "shrub treelet",
                      "shrub subshrub","herb subshrub", "herb_large shrub", "herb shrub", "tree tree")) %>%
  distinct(taxon_name) -> woody_taxa
austraits$traits %>% filter(trait_name == "woodiness") %>% 
  filter(value %in% c("woody","semi_woody")) %>%
  distinct(taxon_name) %>%
    bind_rows(woody_taxa) %>%
    distinct(taxon_name) -> woody_taxa  
  
woody_traits <- traits %>%
  filter(taxon_name %in% woody_taxa$taxon_name)

woody_field_traits <- field_traits %>%
  filter(taxon_name %in% woody_taxa$taxon_name)
```

Create a new trait dataframe to only include observations with associated latitude and longitude
```{r}

woody_traits_georef <- 
  woody_traits %>%
  drop_na(latitude,longitude)


woody_field_traits_georef <- 
  woody_field_traits %>%
  drop_na(latitude,longitude)


```

Plot the distribution of these species across Australia

```{r, fig.height=20, fig.width=10}
austraits_site_by_trait_woody <-
  plot_site_map_by_trait(woody_traits_georef)
austraits_site_by_trait_woody_field <-
  plot_site_map_by_trait(woody_field_traits_georef)

austraits_site_by_trait_woody / austraits_site_by_trait_woody
```

```{r}
number_observations_per_trait<-woody_traits %>%
  group_by(trait_name) %>%
  summarise(n_total_obs=n(), n_total_taxa=length(unique(taxon_name)))

number_observations_per_trait_georeferenced<-woody_traits_georef %>%
  group_by(trait_name) %>%
  summarise(n_georef_obs=n(), n_georef_taxa=length(unique(taxon_name))) %>%
  left_join(number_observations_per_trait)

number_observations_per_trait_georeferenced_field<-woody_field_traits_georef %>%
  group_by(trait_name) %>%
  summarise(n_field_georef_obs=n(), n_field_georef_taxa=length(unique(taxon_name))) %>%
  left_join(number_observations_per_trait_georeferenced)

number_observations_per_trait_georeferenced_field %>% 
  relocate(n_total_obs, .after = trait_name) %>%
  relocate(n_georef_obs, .after = n_total_obs) %>%
  relocate(n_field_georef_obs, .after = n_georef_obs) %>%
  relocate(n_total_taxa, .after = n_field_georef_obs) %>%
  relocate(n_georef_taxa, .after = n_total_taxa) %>%
  relocate(n_field_georef_taxa, .after = n_georef_taxa) %>%
  kbl(caption = "Table 1: Total trait dataset. n_total_obs: Total number of observations of a given trait, n_georef_obs: Number of observations of a given trait with georeference, n_field_georef_obs: Number of observations of a given trait with georeference and recorded in the field, n_total_taxa: Total number of taxa with at least one observation of a given trait, n_georef_taxa: Number of taxa with at least one georeferenced observation of a given trait, n_field_georef_taxa: Number of taxa with at least one georeferenced observation of a given trait and recorded in the field.") %>%
  kable_classic(full_width = T, html_font = "Cambria")  

```


Basic patterns with environment - woody only

# ```{r, fig.width=10}
# woody_field_traits_georef %>%
#   #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
#   mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
#     ggplot(aes(Prec, value)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
# ```
# 
# ```{r, fig.width=10}
# woody_field_traits_georef %>%
#   #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
#   mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
#   ggplot(aes(Temp, value)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
# ```
# 
# ```{r, fig.width=10}
# woody_field_traits_georef %>%
#   #multiply leaf_delta13C by -1 to put it on the positive scale for log scaling
#   mutate(value = if_else(trait_name=="leaf_delta13C", value*-1, value), trait_name = if_else(trait_name=="leaf_delta13C", paste0("-1 * ",trait_name, sep=""), trait_name)) %>%
#   ggplot(aes(Prec_CV, value)) + geom_point(alpha = 0.2, stroke=0) + scale_x_log10() + scale_y_log10() + facet_wrap(~trait_name, scales = "free_y")
# ```


<!-- Isaac - looking to do pair-wise relationships for common trait-pairs -->

```{r}
# pivot trait dataframe to give traits across species from each site
woody_field_traits_georef_spread <- woody_field_traits_georef %>%
  select(observation_id,Temp, Prec, Prec_CV, taxon_name, trait_name, value) %>%
  pivot_wider(names_from = "trait_name", values_from = "value")%>%
  unnest(trait_names) %>%
  mutate(Temperature_binary = ifelse(Temp > median(Temp, na.rm=T), paste("Above", round(median(woody_traits_georef$Temp/10, na.rm=T),1), "C",   sep=" ") ,paste("Below", round(median(woody_traits_georef$Temp/10, na.rm=T),1), "C", sep=" "))) %>%
  mutate(Precipitation_binary = ifelse(Prec > median(Prec, na.rm=T), paste("Above", round(median(woody_traits_georef$Prec, na.rm=T),1), "mm",   sep=" ") ,paste("Below", round(median(woody_traits_georef$Prec, na.rm=T),1), "mm", sep=" "))) %>%
  mutate(Precipitation_seasonality_binary = ifelse(Prec_CV > median(Prec_CV, na.rm=T), paste("Above", round(median(woody_traits_georef$Prec_CV, na.rm=T),1),   sep=" ") ,paste("Below", round(median(woody_traits_georef$Prec_CV, na.rm=T),1), sep=" ")))

```

```{r, fig.height=30, fig.width=30}
pairs(woody_field_traits_georef_spread %>% select(trait_names))
```

<!-- Plot the 5 most populous pair-wise trait combinations, including high and low climate values - please forgive the coding below, still learning how to do functions using tidyverse and ggplot -->

<!-- ```{r echo=FALSE, fig.height= 8, fig.width= 6} -->
<!-- SLA_VDen <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(specific_leaf_area, vessel_density))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- SLA_VDen -->
<!-- SLA_VDiam <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(specific_leaf_area, vessel_diameter))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- SLA_VDiam -->
<!-- VDen_VDIAM <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(vessel_diameter, vessel_density))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- VDen_VDIAM -->
<!-- VDen_WUE <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(vessel_density, water_use_efficiency_intrinsic))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- VDen_WUE -->
<!-- VDiam_WUE <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(vessel_diameter, water_use_efficiency_intrinsic))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- VDiam_WUE -->
<!-- SLA_HydC <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(specific_leaf_area, leaf_hydraulic_conductivity))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- SLA_HydC -->
<!-- SLA_SHC <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(specific_leaf_area, wood_conduit_fraction))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- SLA_SHC -->
<!-- VDen_WCF <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(wood_conduit_fraction, vessel_density))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- VDen_WCF -->
<!-- VDiam_WCF <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(vessel_diameter, wood_conduit_fraction))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- VDiam_WCF -->
<!-- VDiam_PH <- woody_traits_georef_spread %>% -->
<!--   ggplot(aes(vessel_diameter, plant_height))+geom_point()+ scale_x_log10() + scale_y_log10() -->
<!-- VDiam_PH -->
<!-- ``` -->
