---
title: Report on data in AusTraits
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---

Load data
```{r, warning=FALSE, message=FALSE}
# Install dependencies as needed
# devtools::install_deps()
# Load packages and functions for this analysis

rm(list=ls())
devtools::load_all()
source("R/load_climate_data_AWAP.R")
source("R/compile_and_read_AWAP_data.R")
source("R/load_bioclim.R")
source("R/load_worldclim.R")
source("R/plot_trait_by_dataset.R")
source("R/load_CRU_clim.R")
source("R/load_envirem.R")
library(lubridate)
library(R.utils)
library(tidyverse)

# load trait data
austraits <- readRDS("data/austraits_develop.RDS")

```

```{r}
sum_no_NA <- function(x) if(all(is.na(x))) NA_integer_ else sum(x, na.rm=TRUE)
```

```{r}
##test to check if points were correclty sampled from raster

# raster::plot(new_worldclim)
# points(x=extracted_object$longitude, y=extracted_object$latitude, col=rev(terrain.colors(255))[(extracted_object$value - raster::minValue(new_worldclim))/
#                                          (raster::maxValue(new_worldclim)- raster::minValue(new_worldclim)) * 255])

```


```{r}
#where are sites located?

location_of_sites <-
  austraits$sites %>%
  filter(site_property %in% c("longitude (deg)", "latitude (deg)")) %>%
  spread(site_property, value) %>%
  rowid_to_column("ID") %>%
  rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
  mutate_at(c("latitude", "longitude"), ~suppressWarnings(as.numeric(.x))) %>%
  drop_na(longitude, latitude)


# load map of australia (required for climate data analysis)
au_map <- raster::raster("data/australia.tif")
```

Start with solar which has the highest temporal resolution (i.e. unique daily values)

```{r}
# extract values for solar irradiance (12, 16-27th November 2009 missing, 2014 incomplete)

available_years <- c(1990:2008, 2010:2013)

#This function compiles extracts point values from daily spatial files and compiles these values into yearly csvs
map(available_years, compile_daily_solar_data)


#This function reads yearly csvs and compiles them into a total data frame
read_and_combine_compiled_solar_data()


read_csv("data/AWAP/AWAP_solar/compiled_annual_solar/compiled_total_solar_data.csv") %>%
  filter(year %in% available_years) %>%
  mutate(day = as.numeric(day)) -> solar_data_daily_AWAP
```

```{r}
#all other data is on at least a monthly scale, so let's convert solar to monthly before joining all enviro variables together (Solar has daily data for 1990 - 2013, except 2009 which had days missing)

if(file.exists("data/AWAP/AWAP_solar/compiled_annual_solar/compiled_monthly_solar_data.csv")){
  solar_data_monthly_AWAP<-read_csv("data/AWAP/AWAP_solar/compiled_annual_solar/compiled_monthly_solar_data.csv")
} else{
  solar_data_monthly_AWAP <- solar_data_daily_AWAP %>%
  group_by(ID, year, month) %>%
  summarise(mean_monthly_shortwave_radiation = mean(shortwave_radiation, na.rm=T)) %>%
  ungroup()

  write_csv(solar_data_monthly_AWAP,"data/AWAP/AWAP_solar/compiled_annual_solar/compiled_monthly_solar_data.csv")
}

solar_data_monthly_AWAP %>%
  group_by(ID, year) %>%
  summarise(mean_annual_shortwave_radiation_AWAP = mean(mean_monthly_shortwave_radiation, na.rm=T)) %>%
  ungroup() %>%
  group_by(ID) %>%
  summarise(mean_annual_shortwave_radiation_AWAP = mean(mean_annual_shortwave_radiation_AWAP, na.rm=T)) -> solar_data_AWAP

#remove the daily dataset to free up computational resources
rm(solar_data_daily_AWAP)

```

Next, data for which we have unique monthly data within years.

Start with Australian water availability project data

```{r}
# Extract values for monthly totaly rainfall (mm) #2020 incomplete

compile_annual_rainfall_data()

annual_rainfall_data_AWAP <- read_csv("data/AWAP/agcd/v2/r005/01month/compiled_rainfall_data/compiled_rainfall_data.csv")%>%
  select(-day) %>%
  filter(year !="2020") %>%
  rename(prec_AWAP = prec) %>%
  select(-buffer_extracted) %>%
  group_by(year, ID, latitude, longitude) %>%
  summarise(prec_AWAP = sum_no_NA(prec_AWAP)) %>%
  ungroup() %>%
  group_by(ID, latitude, longitude) %>%
  summarise(prec_AWAP = mean(prec_AWAP, na.rm=T)) %>%
  ungroup()
```


```{r}
# First, extract values for 9am vapour pressure (hPA) #2020 incomplete

compile_vp_09_data()

vp_09_data_AWAP <- read_csv("data/AWAP/agcd/v1/vapourpres_h09_monthly/mean/r005/01month/compiled_h09_data/compiled_h09_data.csv") %>%
  select(-day) %>%
  filter(year !="2020")%>%
  rename(vp09_AWAP = vp09) %>%
  select(-buffer_extracted)


# vp_09_data_AWAP1 <- read_csv("data/AWAP/agcd/v1/vapourpres_h09_monthly/mean/r005/01month/compiled_h09_data/compiled_h09_data1.csv") %>%
#   select(-day) %>%
#   filter(year !="2020")%>%
#   rename(vp09_AWAP = vp09) %>%
#   select(-buffer_extracted)
# 
# plot(vp_09_data_AWAP$vp09_AWAP~vp_09_data_AWAP1$vp09_AWAP)


```

```{r}
# Next, extract values for 3pm vapour pressure (hPA) #2020 incomplete

compile_vp_15_data()

vp_15_data_AWAP <- read_csv("data/AWAP/agcd/v1/vapourpres_h15_monthly/compiled_h15_data/compiled_h15_data.csv") %>%
  select(-day)%>%
  filter(year !="2020")%>%
  rename(vp15_AWAP = vp15)%>%
  select(-buffer_extracted)

```

```{r}
# Next, extract values for average monthly maximum temperature #2020 incomplete

compile_max_T_data()

max_t_data_AWAP <- read_csv("data/AWAP/agcd/v1/monthly_tmax/compiled_temperature_data/compiled_temperature_data.csv") %>%select(-day) %>%
  filter(year !="2020") %>%
  rename(max_t_AWAP = max_t)%>%
  select(-buffer_extracted)
```

```{r}
vpd_data_AWAP <- left_join(max_t_data_AWAP, vp_15_data_AWAP) %>%
  left_join(vp_09_data_AWAP)
```


```{r}
#add vapour pressure deficit to dataframe using formulas for saturated vapour pressure (esat; kPa) and vapour pressure deficit (VPD; kPa) in Monteith JL & Unsworth MH (1990) Principles of environmental physics

es_T_star = 0.611 #kPa
T_dash = 36.0;  #K
T_star = 273.0; #K
A = 17.27
DEG_TO_KELVIN = 273.0 # convert celcius to kelvins
hPa_to_kPA = 1/10 #vapour pressure is in hPa

vpd_data_AWAP$max_t_K_AWAP<- vpd_data_AWAP$max_t_AWAP+DEG_TO_KELVIN

vpd_data_AWAP$esat = es_T_star * exp(A * (vpd_data_AWAP$max_t_K_AWAP - T_star) / (vpd_data_AWAP$max_t_K_AWAP - T_dash))

#convert vapour pressure to kPa

vpd_data_AWAP$vp_09_kpa_AWAP <- vpd_data_AWAP$vp09_AWAP * hPa_to_kPA
vpd_data_AWAP$vp_15_kpa_AWAP <- vpd_data_AWAP$vp15_AWAP * hPa_to_kPA

#VPD is saturated vapour pressure minus vapour pressure

vpd_data_AWAP$VPD_09 <- vpd_data_AWAP$esat - vpd_data_AWAP$vp_09_kpa_AWAP
vpd_data_AWAP$VPD_15 <- vpd_data_AWAP$esat - vpd_data_AWAP$vp_15_kpa_AWAP
```

```{r}
vpd_data_AWAP %>%
  group_by(year, ID, latitude,longitude) %>%
  summarise(VPD_09_AWAP = mean(VPD_09, na.rm=T),
            VPD_15_AWAP = mean(VPD_15, na.rm=T),
            max_t_AWAP = mean(max_t_AWAP, na.rm=T)) %>%
  ungroup() %>%
  group_by(ID, latitude,longitude) %>%
  summarise(VPD_09_AWAP = mean(VPD_09_AWAP, na.rm=T),
            VPD_15_AWAP = mean(VPD_15_AWAP, na.rm=T),
            max_t_AWAP = mean(max_t_AWAP, na.rm=T)) %>%
  ungroup() %>%
  left_join(solar_data_AWAP) %>%
  left_join(annual_rainfall_data_AWAP) -> climate_data_AWAP
```

Now, data from CRU clim

```{r}
#CRU data sometimes needs to be unzipped using this function gunzip

gunzip("data/CRU/pet/cru_ts4.05.1901.2020.pet.dat.nc.gz", remove=FALSE)

pet_directory <- "data/CRU/pet/"
pet_file <- "cru_ts4.05.1901.2020.pet.dat.nc"

pet_data <- load_CRU_clim(pet_directory, pet_file)
write_csv(pet_data, "data/CRU/pet/pet_data.csv")

read_csv("data/CRU/pet/pet_data.csv")  %>%
  rename(pet_CRU = value)%>%
  mutate(date = paste(year, month, day, sep="-")) %>%
  mutate(date = ymd(date)) %>%
  mutate(num_days = days_in_month(date)) %>%
  mutate(monthly_pet_CRU = pet_CRU*num_days) %>%
  select(-buffer_extracted, -day) -> pet_data_CRU
```


```{r}
gunzip("data/CRU/pre/cru_ts4.05.1901.2020.pre.dat.nc.gz", remove=FALSE)

pre_directory <- "data/CRU/pre/"
pre_file <- "cru_ts4.05.1901.2020.pre.dat.nc"

pre_data <- load_CRU_clim(pre_directory, pre_file)
write_csv(pre_data, "data/CRU/pre/pre_data.csv")

pre_data_CRU <- read_csv("data/CRU/pre/pre_data.csv") %>%
  rename(prec_CRU = value) %>%
  select(-buffer_extracted, -day)
```


```{r}
gunzip("data/CRU/temp_avg/cru_ts4.05.1901.2020.tmp.dat.nc.gz", remove=FALSE)

temp_avg_directory <- "data/CRU/temp_avg/"
temp_avg_file <- "cru_ts4.05.1901.2020.tmp.dat.nc"

temp_avg_data <- load_CRU_clim(temp_avg_directory, temp_avg_file)
write_csv(temp_avg_data, "data/CRU/temp_avg/temp_avg_data.csv")

temp_avg_data_CRU <- read_csv("data/CRU/temp_avg/temp_avg_data.csv") %>%
  rename(temp_avg_CRU = value) %>%
  select(-buffer_extracted, -day)
```

```{r}
left_join(temp_avg_data_CRU, pre_data_CRU) %>%
  left_join(pet_data_CRU) -> climate_data_CRU
```

```{r}
climate_data_CRU %>%
  group_by(year, ID, latitude, longitude) %>%
  summarise(pet_CRU = sum_no_NA(monthly_pet_CRU),
            prec_CRU = sum_no_NA(prec_CRU),
            temp_avg_CRU = mean(temp_avg_CRU, na.rm=T)) %>%
  ungroup() %>%
  mutate(MI = prec_CRU/pet_CRU) %>%
  group_by(ID, latitude, longitude) %>%
  summarise(pet_CRU = mean(pet_CRU,na.rm=T),
            prec_CRU = mean(prec_CRU, na.rm=T),
            temp_avg_CRU = mean(temp_avg_CRU, na.rm=T),
            MI_CRU = mean(MI, na.rm=T)) %>%
  ungroup() -> climate_data_CRU

```


Next, prepare monthly data from the Worldclim dataset. Worldclim has monthly values averaged across years

```{r}
load_worldclim("data/WC/wc2.1_30s_elev/", "elev_worldclim")

elev_worldclim <- read_csv("data/WC/wc2.1_30s_elev/elev_worldclim.csv") %>%
  rename(elev_WC = value)%>%
  select(-buffer_extracted, -month)
```


```{r}
load_worldclim("data/WC/wc2.1_30s_prec/", "prec_worldclim")

prec_worldclim <- read_csv("data/WC/wc2.1_30s_prec/prec_worldclim.csv") %>%
  rename(prec_WC = value)%>%
  select(-buffer_extracted)
```


```{r}
load_worldclim("data/WC/wc2.1_30s_tavg/", "avg_temp_wordlclim")

avg_temp_worldclim <- read_csv("data/WC/wc2.1_30s_tavg/avg_temp_wordlclim.csv") %>%
  rename(avg_temp_WC = value)%>%
  select(-buffer_extracted)
```

```{r}
load_worldclim("data/WC/wc2.1_30s_srad/", "solar_wordlclim")

solar_worldclim_data <- read_csv("data/WC/wc2.1_30s_srad/solar_wordlclim.csv") %>%
  rename(solar_WC = value)%>%
  select(-buffer_extracted)
```

```{r}
load_worldclim("data/WC/wc2.1_30s_vapr/", "VP_wordlclim")

VP_worldclim_data <- read_csv("data/WC/wc2.1_30s_vapr/VP_wordlclim.csv") %>%
  rename(VP_WC = value)%>%
  select(-buffer_extracted)
```

```{r}
load_worldclim("data/WC/wc2.1_30s_tmax/", "tmax_wordlclim")

tmax_worldclim_data <- read_csv("data/WC/wc2.1_30s_tmax/tmax_wordlclim.csv") %>%
  rename(tmax_WC = value)%>%
  select(-buffer_extracted)
```


```{r}
vpd_data_WC <- left_join(tmax_worldclim_data, VP_worldclim_data)
```


```{r}
# #add vapour pressure deficit to dataframe using formulas for saturated vapour pressure (esat; kPa) and vapour pressure deficit (VPD; kPa) in Monteith JL & Unsworth MH (1990) Principles of environmental physics
#
es_T_star = 0.611 #kPa
T_dash = 36.0;  #K
T_star = 273.0; #K
A = 17.27
DEG_TO_KELVIN = 273.0 # convert celcius to kelvins

vpd_data_WC$max_t_K_WC<- vpd_data_WC$tmax_WC+DEG_TO_KELVIN

vpd_data_WC$esat = es_T_star * exp(A * (vpd_data_WC$max_t_K_WC - T_star) / (vpd_data_WC$max_t_K_WC - T_dash))

#VPD is saturated vapour pressure minus vapour pressure

vpd_data_WC$VPD_WC <- vpd_data_WC$esat - vpd_data_WC$VP_WC
```

```{r}
vpd_data_WC %>%
  select(tmax_WC, ID, latitude, longitude, month, VPD_WC) %>%
  left_join(solar_worldclim_data) %>%
  left_join(avg_temp_worldclim) %>%
  left_join(prec_worldclim) %>%
  left_join(elev_worldclim) %>%
  group_by(ID, latitude, longitude) %>%
  summarise(VPD_WC = mean(VPD_WC, na.rm=T),
            solar_WC = mean(solar_WC, na.rm=T),
            avg_temp_WC = mean(avg_temp_WC, na.rm=T),
            prec_WC = sum_no_NA(prec_WC),
            tmax_WC = mean(tmax_WC, na.rm=T),
            elev_WC = mean(elev_WC, na.rm=T))-> climate_data_WC

```

Also, bring in some data from the ENVIREM dataset which is derived from Worldclim data. Specifically, PET and growing degree days. 

```{r}
load_envirem("data/Envirem/Australia_current_30arcsec_geotiff_set1/","PET_ENVIREM")

PET_envirem <- read_csv("data/Envirem/Australia_current_30arcsec_geotiff_set1/PET_ENVIREM.csv") %>%
  rename(PET_envirem = value) %>%
  select(-buffer_extracted)
```

```{r}
load_envirem("data/Envirem/Australia_current_30arcsec_geotiff_set2/","growing_deg_day_5")

GDD_5_envirem <- read_csv("data/Envirem/Australia_current_30arcsec_geotiff_set2/growing_deg_day_5.csv") %>%
  rename(GDD_5_envirem = value) %>%
  select(-buffer_extracted)
```

```{r}
climate_data_WC <- left_join(climate_data_WC, PET_envirem) %>%
  mutate(MI_WC = prec_WC/PET_envirem) %>%
  left_join(GDD_5_envirem)
```

```{r}
#bind wordclim data to compare temp and rainfall data to

#load bioclim data
climate_data_BC <- load_climate_data() %>%
  select(-buffer_extracted) %>%
  pivot_wider(names_from = key, values_from= value)
```

```{r}
climate_data <- climate_data_AWAP %>%
  left_join(climate_data_CRU) %>%
  left_join(climate_data_WC) %>%
  left_join(climate_data_BC)
```


```{r}
saveRDS(climate_data, "data/climate_data.RDS")
climate_data <- readRDS("data/climate_data.RDS")
```

```{r}
library("GGally")

climate_data %>% 
  select(starts_with(c("Prec","prec")), -Prec_CV_BC) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

climate_data %>% 
  select(temp_avg_CRU, avg_temp_WC, Temp_BC) %>%
  mutate(Temp_BC = Temp_BC/10) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

climate_data %>% 
  select(starts_with("VPD")) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

climate_data %>% 
  select(mean_annual_shortwave_radiation_AWAP, solar_WC) %>%
  mutate(mean_annual_shortwave_radiation_AWAP = mean_annual_shortwave_radiation_AWAP * 1000) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)
                
climate_data %>% 
  select(MI_CRU, MI_WC) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

climate_data %>% 
  select(starts_with("PET")) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)
```

```{r}
climate_data %>% 
  select(-ID, -latitude, -longitude, -dataset_id, -site_name) %>%
  cor(use="pairwise.complete.obs") %>%
  corrplot(., diag=TRUE, method = "ellipse", type="upper", order="AOE")


plot(climate_data$Temp_BC~climate_data$Prec_CV_BC)

plot(climate_data$VPD_09_AWAP~climate_data$prec_AWAP, log = "xy")

```


```{r}
traits <- austraits$traits %>%
  left_join(location_of_sites) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass","leaf_N_per_area","ci_over_ca","wood_density","plant_height", "seed_mass", "leaf_delta13C","huber_value")) %>%
  mutate(value = as.numeric(value)) %>%
  left_join(climate_data)
```


```{r}
field_traits <- traits %>%
  filter(!(dataset_id %in% c("Ahrens_2019", "Crous_2013", "Crous_2019", "Du_2018",
                            "Du_2019", "Duan_2015", "EsperonRodriguez_2019",
                            "EsperonRodriguez_2020","Everingham_2020",
                            "Farrell_2012", "Farrell_2013", "Farrell_2017", "Firn_2019",
                            "Gallagher_2011_1", "Gallagher_2011_3", "Gallagher_2015", 
                            "Gardiner_2019", "Geange_2017", "Geange_2020", "Ghannoum_2010",
                            "Harrison_2009",
                            "Hassiotou_2009", "Huang_2015", "Jagdish_2020", "Lewis_2015",
                            "Lusk_2012", "Lusk_2014", "Moore_2019_2", "Reynolds_2018",
                            "Roderick_2002", "Schulze_2006", "Smith_2012",
                            "Tomlinson_2013","Tomlinson_2019", "Turner_2010", "Vesk_2019",
                            "Vlasveld_2018", "Warren_2005", "Warren_2006"))) %>%
  filter(!(site_name %in% c("Currency Creek Arboretum","Currency Creek Arboretum, South Australia",
                            "Australian National University glasshouse","MU_campus",
                            "Australian National Botanic Gardens","Australian National University"))) 
```

We also remove all trait values which are records across multiple sites, are from the literature, expert values, or are from unknown sources

```{r}
field_traits %>%
  filter(value_type %in% c("raw_value", "site_mean", "site_max", "individual_mean") | trait_name == "plant_height") -> field_traits
```


Create a new trait dataframe to only include observations with associated latitude and longitude
```{r}
field_traits_georef <- 
  field_traits %>%
  drop_na(latitude,longitude)
```

```{r}

woody_plant_growth_forms <- c("hemi-epiphyte_shrub", "hemi-epiphyte_tree", "leafless_shrub_tree", "parasite_woody", "subshrub", "shrub", "treelet", "tree", "shrub tree", "shrub treelet",
"shrub subshrub","herb subshrub", "herb_large shrub", "herb shrub", "tree tree")

austraits$traits %>% 
  filter(trait_name== "plant_growth_form") %>%
  group_by(taxon_name) %>% 
  filter(all((value %in% woody_plant_growth_forms))) %>%
  ungroup() %>%
  distinct(taxon_name)-> woody_taxa_plant_growth_form

austraits$traits %>% 
  filter(trait_name == "woodiness") %>% 
  group_by(taxon_name) %>%
  filter(all(value %in% c("woody","semi_woody"))) %>%
  distinct(taxon_name)%>%
  bind_rows(woody_taxa_plant_growth_form) %>%
    distinct(taxon_name) -> woody_taxa

# list of species which did not have woody data, updated with data pulled off internet
read_csv("data/no_woody_data_updated.csv") %>%
  filter(woodiness %in% c("woody","semi_woody")) %>%
           distinct(taxon_name) %>%
           bind_rows(woody_taxa) %>%
           distinct(taxon_name) -> woody_taxa

```

Create a new trait dataframe to only include observations with associated latitude and longitude
```{r include=FALSE}
woody_field_traits_georef <- 
  field_traits_georef %>%
  filter(taxon_name %in% woody_taxa$taxon_name)
```

Go through and remove families which were recorded as woody but either aren't woody or do not have a tree/shrub-like growth form, e.g. grass,sedges, palms, ferns

```{r include=FALSE}
ferns_species <-
  austraits$taxa%>%
  filter(family %in% c("Schizaeaceae", "Gleicheniaceae","Dennstaedtiaceae", "Polypodiaceae","Dicksoniaceae", "Datiscaceae"))

palm_species <-
  austraits$taxa%>%
  filter(family %in% c("Arecaceae"))

cycad_species <-
  austraits$taxa%>%
  filter(family %in% c("Cycadaceae","Zamiaceae", "Stangeriaceae"))

graminoid_species <- 
  austraits$taxa %>%
  filter(family %in% c("Poaceae","Cyperaceae","Restionaceae"))

ginger_species <- 
  austraits$taxa %>%
  filter(family %in% c("Zingiberaceae"))

woody_field_traits_georef %>%
  filter(!taxon_name %in% ferns_species$taxon_name) %>%
  filter(!taxon_name %in% palm_species$taxon_name)%>%
  filter(!taxon_name %in% cycad_species$taxon_name)%>%
  filter(!taxon_name %in% graminoid_species$taxon_name)%>%
  filter(!taxon_name %in% ginger_species$taxon_name) ->
  woody_field_traits_georef_tree_form
```

For species with more than one observation, we can check to see if their values are relatively consistent by inspecting max:min ratio, sd, CV etc. We need to do this seperately for measurements involving leaves and for the rest of the traits because of the fact that hte leaf vs. leaflet perspective will lead to large differences in measurements


```{r}
read_csv("data/datasets_with_leaf_area_or_dry_mass.csv") %>%
  select(dataset_id, compound_species, leaf_unit_measured)-> leaf_area_leaf_dry_mass_studies

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "no_compound") -> no_compound

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "compound_present" & leaf_unit_measured == "leaflet") -> compound_leaflet

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "compound_present" & leaf_unit_measured %in% c(NA,"leaf")) %>%
  mutate(trait_name = paste(trait_name, "_leaf_unit", sep=""))-> compound_leaf

leaf_leaflet <- bind_rows(no_compound, compound_leaflet)  %>%
  mutate(trait_name = paste(trait_name, "_leaflet_unit", sep=""))
```


```{r}
leaf_leaflet %>% 
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100) %>%
  filter(max_min_ratio > 10)-> error_check_leaf_leaflet

leaf_leaflet %>%
  filter(taxon_name %in% error_check_leaf_leaflet$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_leaf_leaflet) -> error_check_leaf_leaflet

compound_leaf %>% 
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100) %>%
  filter(max_min_ratio > 10)-> error_check_leaf_leaf

compound_leaf %>%
  filter(taxon_name %in% error_check_leaf_leaf$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_leaf_leaf) -> error_check_leaf_leaf
```

Dong_et_al_2017 leaf area and dry mass values appear to be consistentely larger than expected so we will remove these values

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(dataset_id == "Dong_2017" & trait_name %in% c("leaf_area","leaf_dry_mass"))) -> woody_field_traits_georef_tree_form
```

Error checking for specific leaf area

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "specific_leaf_area") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_SLA

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_SLA$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_SLA) -> error_check_SLA
```

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(observation_id == "Kanowski_2000_196" & trait_name == "specific_leaf_area" & taxon_name == "Endiandra insignis")) -> woody_field_traits_georef_tree_form

```

Error checking for leaf N per area

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "leaf_N_per_area") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>1) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_leaf_N

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_leaf_N$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_leaf_N)-> error_check_leaf_N
```

Remove errroneous leaf_n_per_area values

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(observation_id == "Prior_2003_157" & taxon_name == "Corymbia foelscheana" & trait_name == "Leaf_N_per_area")) -> woody_field_traits_georef_tree_form
```

Error checking for wood density

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "wood_density") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_wood_density

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_wood_density$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_wood_density)-> error_check_wood_density
```

Error checking for plant height

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "plant_height") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_plant_height

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_plant_height$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_plant_height)-> error_check_plant_height
```

Error checking for ci:ca ratio

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "ci_over_ca") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_ci_over_ca

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_ci_over_ca$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_ci_over_ca)-> error_check_ci_over_ca
```

Remove erroneous ci_ca_ratio values

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(observation_id == "Bloomfield_2018_1100" & taxon_name == "Eucalyptus camaldulensis" & trait_name == "ci_over_ca")) %>%
  filter(!(observation_id == "Bloomfield_2018_0977" & taxon_name == "Eucalyptus salmonophloia" & trait_name == "ci_over_ca")) -> woody_field_traits_georef_tree_form
```


Error checking for leaf_delta13C

```{r}
woody_field_traits_georef_tree_form %>%
  filter(trait_name == "leaf_delta13C") %>%
  group_by(taxon_name, trait_name) %>%
  filter(n()>2) %>%
  summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
  mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check_leaf_delta13C

woody_field_traits_georef_tree_form %>%
  filter(taxon_name %in% error_check_leaf_delta13C$taxon_name) %>%
  group_by(trait_name, taxon_name) %>%
  distinct(dataset_id) %>%
  mutate(studies = paste0(dataset_id, collapse= "")) %>%
  slice(1) %>%
  inner_join(error_check_leaf_delta13C)-> error_check_leaf_delta13C
```

To see if there any instances where data is shared between studies, we inspect occurrences of identical trait values for each trait~species group. Although there are a number of cases where this occurs, most seem to be coincidental.

```{r}
woody_field_traits_georef_tree_form %>%
  group_by(value, taxon_name, trait_name) %>% 
  filter(n()>1) %>% 
  filter(n_distinct(dataset_id)>1) -> identical_values
```

Combine leaf mass and area back onto dataframe now that it is seperated into studies which considered the leaflet scale vs. leaf scale

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(trait_name %in% c("leaf_area", "leaf_dry_mass"))) %>%
  bind_rows(leaf_leaflet) %>%
  bind_rows(compound_leaf) -> woody_field_traits_georef_tree_form
```

We will now inspect distribution of data in each study relative to total distribution to see if there is any erroneous data
```{r eval=FALSE, include=FALSE}
# traits_to_inspect <- woody_field_traits_georef_tree_form %>%
#    distinct(trait_name)
# 
# trait_by_dataset_core_traits<-function(trait){
# 
# woody_field_traits_georef_tree_form %>%
#   filter(trait_name == trait) %>%
#   distinct(dataset_id) -> dataset_index
# 
# purrr::map(dataset_index$dataset_id, plot_trait_by_dataset, trait)
# }
# 
# purrr::map(traits_to_inspect$trait_name, trait_by_dataset_core_traits)
```

Remove some outliers based on the distributions above
(Wood density: fine
Specific leaf area: inspected)


```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(trait_name == "leaf_delta13C"& taxon_name == "Atriplex stipitata"& observation_id == "Wright_2002_039")) %>%
  filter(!(trait_name == "specific_leaf_area" & dataset_id == "Angevin_2011"))%>%
  filter(!(trait_name == "specific_leaf_area"& dataset_id == "Dwyer_2017"&taxon_name == "Pimelia imbricata")) %>%
  filter(!(trait_name == "specific_leaf_area"& dataset_id == "Schulze_1998"&taxon_name == "Grevillea pyramidalis")) %>%
  filter(!(trait_name == "specific_leaf_area"& observation_id == "Burrows_2001_204"&taxon_name == "Melichrus urceolatus"))%>%
  filter(!(trait_name == "specific_leaf_area"& observation_id == "Fonseca_2000_0603"&taxon_name == "Xanthorrhoea sp."))%>%
  filter(!(trait_name == "specific_leaf_area"& observation_id == "Knox_2011_13"&taxon_name == "Calytix_tetragona"))%>%
  filter(!(trait_name == "leaf_N_per_dry_mass"& observation_id == "Soper_2014_121"&taxon_name == "Grevillea wickhamii"))%>%
  filter(!(trait_name == "leaf_N_per_area"& observation_id == "Schulze_1998_090"&taxon_name == "Grevillea pyramidalis")) %>%
#remove Schulze_1998_090 Grevillea pyramidalis entirely, two suspect values
filter(!(observation_id == "Schulze_1998_090"&taxon_name == "Grevillea pyramidalis")) -> woody_field_traits_georef_tree_form
 
```

Calculate leaf_N_per_area and leaf_area for additional observations:
```{r include=FALSE}
woody_field_traits_georef_tree_form %>% 
  filter(trait_name %in% c("leaf_dry_mass_leaflet_unit","leaf_dry_mass_leaf_unit","leaf_area_leaflet_unit","leaf_area_leaf_unit","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass","leaf_N_per_area")) %>%
  select(ID, trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date) %>%
    group_by(ID, trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  mutate(value = as.numeric(value)) %>%
    pivot_wider(names_from = trait_name, values_from = value) %>%
  mutate(leaf_area_combined = ifelse(!is.na(leaf_area_leaflet_unit),leaf_area_leaflet_unit,specific_leaf_area*leaf_dry_mass_leaflet_unit)) %>%
  mutate(specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area),specific_leaf_area,leaf_area_leaflet_unit/leaf_dry_mass_leaflet_unit)) %>%
  mutate(specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area_combined),specific_leaf_area_combined,leaf_area_leaf_unit/leaf_dry_mass_leaf_unit)) %>%
  mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area_combined,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass_leaflet_unit/leaf_area_leaflet_unit,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA)) %>%
   mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass_leaf_unit/leaf_area_leaf_unit,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA))->calculated_data
  
  
calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_N_per_area_combined) %>%
  filter(!is.na(leaf_N_per_area_combined)) %>%
  mutate(units = "g/m2",
         trait_name = "leaf_N_per_area_calc",
         value = leaf_N_per_area_combined) %>%
  select(-leaf_N_per_area_combined) -> leaf_N_per_area_calcuated

calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_area_combined) %>%
  filter(!is.na(leaf_area_combined)) %>%
  mutate(units = "mm2",
         trait_name = "leaf_area_calc",
         value = leaf_area_combined) %>%
  select(-leaf_area_combined) -> leaf_area_calcuated

calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         specific_leaf_area_combined) %>%
  filter(!is.na(specific_leaf_area_combined)) %>%
  mutate(units = "mm2/mg",
         trait_name = "specific_leaf_area_calc",
         value = specific_leaf_area_combined) %>%
  select(-specific_leaf_area_combined) -> specific_leaf_area_calcuated


```

Extract values for ci:ca ratios from delta13c using equations in Farqhuar (1989) and Wang et al. (2017)

Carbon isotope discrimination values are dervied from delta_13C $\delta ^{13}C$ using the following equation from Farqhuar (1989):

$$\Delta = \frac{\delta_a-\delta ^{13}C}{1+\delta ^{13}C/1000}$$

The ci:ca ratio $(X)$ is linked to the carbon isotope discrimination value of plant samples according the following equation:

$$X = \frac{\Delta-a}{b-a},$$
where a’ and b’ have standard values 4.4‰ and 27‰, representing the diffusional 
and biochemical components of carbon isotope discrimination, respectively (Wang et al. 2017).


``` {r}
woody_field_traits_georef_tree_form %>% 
  filter(trait_name %in% c("ci_over_ca", "leaf_delta13C")) %>%
  select(trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date, ID) %>%
  mutate(value = as.numeric(value)) %>%
  group_by(trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date, ID) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  spread(key = trait_name, value = value)%>%
  mutate(delta_C = (-8-leaf_delta13C)/(1+leaf_delta13C/1000))%>%
  mutate(ci_over_ca_calc = (delta_C-4.4)/(27-4.4)) %>%
  mutate(ci_over_ca_combined = ifelse(!is.na(ci_over_ca),ci_over_ca,ci_over_ca_calc)) ->calculated_data

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         ci_over_ca_combined, ID) %>%
  filter(!is.na(ci_over_ca_combined)) %>%
  mutate(units = "unitless",
         trait_name = "ci_over_ca_calc",
         value = as.numeric(ci_over_ca_combined)) %>%
  select(-ci_over_ca_combined) -> ci_over_ca_calculated

```


``` {r, fig.width=10}
# 
# calculated_data %>% drop_na(leaf_delta13C, ci_over_ca)%>% mutate(proportion_difference = abs(ci_over_ca - ci_over_ca_calc)/ci_over_ca_calc) -> ci_over_ca_validation
# 
# 
# hist(ci_over_ca_validation$proportion_difference, xlab = "abs(Observed_X-Predicted_X)/Predicted_X", main = "Difference between observed and predicted X")
```


``` {r, fig.width=10}
#add a 1:1 line

# ci_over_ca_validation %>% ggplot(aes(x=ci_over_ca, y=leaf_delta13C))+geom_point()+theme(axis.text=element_text(size=12),
#         axis.title=element_text(size=14,face="bold"))
# 
# ci_over_ca_validation %>% ggplot(aes(x=ci_over_ca, y=ci_over_ca_calc))+geom_point()+xlab("Observed ci_over_ca")+ylab("Estimated ci_over_ca")+theme(axis.text=element_text(size=12),
#         axis.title=element_text(size=14,face="bold"))
```

Bind cliamte data to the summarised data frame
```{r}
woody_field_traits_georef_tree_form %>%
  bind_rows(leaf_N_per_area_calcuated) %>%
  bind_rows(leaf_area_calcuated) %>%
  bind_rows(specific_leaf_area_calcuated) %>%
  bind_rows(ci_over_ca_calculated) %>%
  group_by(site_name, taxon_name, dataset_id, trait_name, ID) %>%
  summarise(value=mean(value, na.rm=T)) %>%
  ungroup() %>%
  left_join(climate_data)-> woody_field_traits_georef_tree_form_climate
```

We will now inspect distribution of data in each study relative to total distribution to see if there is any erroneous data now that data has been averaged
```{r}
traits_to_inspect <- woody_field_traits_georef_tree_form %>%
   distinct(trait_name)

trait_by_dataset_core_traits<-function(trait) {
  woody_field_traits_georef_tree_form %>%
  filter(trait_name == trait) %>%
  distinct(dataset_id) -> dataset_index_leaf_area

purrr::map(dataset_index_leaf_area$dataset_id, plot_trait_by_dataset_site_level, trait)
}

purrr::map(traits_to_inspect$trait_name, trait_by_dataset_core_traits)
```

Basic patterns with environment

```{r}

core_traits <- c("huber_value","ci_over_ca_calc","leaf_N_per_area_calc","specific_leaf_area_calc","wood_density","plant_height","leaf_area_calc","seed_mass")

```

```{r, fig.width=10}

filter_function <- function(traits_function){
woody_field_traits_georef_tree_form_climate %>%
  filter(trait_name %in% core_traits) %>%
  distinct(dataset_id, .keep_all=TRUE) %>%
select(starts_with(c("prec_WC", "GDD_5_envirem","solar_WC","VPD_WC","MI_WC","avg_temp","elev"))) -> data

cor(data, use="pairwise.complete.obs")
}
library(purrr)

purrr::map(core_traits, filter_function)

```

```{r}
png("output/four_panel_test.png", height=1300, width=2000, res=250)

core_traits <- c("plant_height","specific_leaf_area_calc","seed_mass","wood_density")

sub_labels <- tibble(trait_name = core_traits, label = paste(c("a","c","b","d"),")",sep=""))

woody_field_traits_georef_tree_form_climate%>%
    filter(trait_name %in% core_traits) %>%
    select(trait_name, value, prec = prec_WC)%>%
    pivot_longer(-c("trait_name", "value"), names_to = "env", values_to = "env_value")%>%
  left_join(sub_labels) %>%
    mutate(env = factor(env, levels = c("prec"),labels =  c("MAP~(mm~yr^{-1})")))%>%
  mutate(trait_name = factor(trait_name, levels = core_traits,labels =  c("Height~at~maturation~(m)","Specific~leaf~area~(mg~mm^{-2})","Seed~mass~(mg)","Wood~density")))%>%
  ggplot(aes(env_value, value,group = trait_name)) +
  geom_point() + 
  scale_y_log10() +
  scale_x_log10() + 
  theme_bw() + 
    facet_wrap(~trait_name, scales = "free",labeller = label_parsed, drop=TRUE, strip.position ="left") + 
  theme(axis.title.y=element_blank())+
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 12), axis.text=element_text(size=11)) +
  xlab(expression(MAP~(mm~yr^{-1}))) + 
  theme(strip.placement = "outside") +
  theme(strip.background = element_rect(fill = "white", colour = "white")) +
    geom_text(mapping = aes(x = 0, y = Inf, label = label, group=env),
              vjust="inward",hjust=-0.25,
              inherit.aes = FALSE, check_overlap = TRUE, size=4)

dev.off()
```


```{r}

png("output/cow_plot_test.png", height=6000, width=5000, res=300)

plot_figure_1("leaf_N_per_area_calc","Leaf N per area (mg/mm2)",woody_field_traits_georef_tree_form_climate, 1) -> a

plot_figure_1("huber_value","Huber value",woody_field_traits_georef_tree_form_climate, 2) -> b

plot_figure_1("leaf_area_calc","Leaf area (mm2)",woody_field_traits_georef_tree_form_climate, 3) -> c

plot_figure_1("specific_leaf_area_calc","Specific leaf area (mg/mm2)",woody_field_traits_georef_tree_form_climate, 4) -> d

plot_figure_1("plant_height","Plant height (m)",woody_field_traits_georef_tree_form_climate, 4) -> e

plot_figure_1("ci_over_ca_calc","ci_ca",woody_field_traits_georef_tree_form_climate, 5) -> f

plot_figure_1("seed_mass","Seed mass (g)",woody_field_traits_georef_tree_form_climate, 6) -> g

plot_figure_1("wood_density","Wood density",woody_field_traits_georef_tree_form_climate, 7) -> h

cowplot::plot_grid(a/b/c/d/e/f/g/h)

dev.off()
```

```{r}
png("output/facet_wrap_test.png", height=2600, width=2600, res=300)


trait_names <- tibble(trait_name = core_traits,
                      trait = c("huber","ci:ca","leaf_N", "SLA", "Wood_dens", "height", "leaf_area","seed_mass"))

woody_field_traits_georef_tree_form_climate%>%
    filter(trait_name %in% core_traits) %>%
    left_join(by="trait_name", trait_names)%>%
    select(trait, value, Temp = avg_temp_WC, VPD = VPD_WC, PAR = solar_WC,elev = elev_WC, prec = prec_WC) %>%
    pivot_longer(-c("trait", "value"), names_to = "env", values_to = "env_value") %>%
    mutate(env = factor(env, levels = c("Temp","VPD","PAR","elev","prec"),labels=c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) %>%
    left_join(sub_labels) %>% 
    mutate(env = factor(env, levels = c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) ->data_for_plot

data_for_plot %>%
  mutate(keep = case_when(
    trait %in% c("huber", "leaf_N") & env %in% c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)") ~ "keep",
  trait == "ci:ca" & env %in% c("MAT ~(degree*C)","VPD~(kPa)","Elevation~(m)") ~ "keep",
  trait == "leaf_area" & env %in% c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})") ~ "keep",
  trait %in% c("SLA","Wood_dens","height","seed_mass") & env %in% c("MAP~(mm~yr^{-1})") ~ "keep")) %>%
  filter(!is.na(keep))%>% 
  ggplot(aes(env_value, value,group = trait)) +
  geom_point() + 
  scale_y_log10() +
  scale_x_log10() + 
  theme_bw() + 
    facet_wrap(trait~env, scales = "free",labeller = label_parsed, drop=TRUE, ncol=4, strip.position = "top") + 
  theme(axis.title.x=element_blank())+
  theme(axis.title.y=element_blank())+
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 6), axis.text=element_text(size=7))

dev.off()
```

```{r}
png("output/facet_grid_test.png", height=2600, width=2600, res=300)


trait_names <- tibble(trait_name = core_traits,
                      trait = c("huber","ci:ca","leaf_N", "SLA", "Wood_dens", "height", "leaf_area","seed_mass"))

woody_field_traits_georef_tree_form_climate%>%
    filter(trait_name %in% core_traits) %>%
    left_join(by="trait_name", trait_names)%>%
    select(trait, value, Temp = avg_temp_WC, VPD = VPD_WC, PAR = solar_WC,elev = elev_WC, prec = prec_WC) %>%
    pivot_longer(-c("trait", "value"), names_to = "env", values_to = "env_value") %>%
    mutate(env = factor(env, levels = c("Temp","VPD","PAR","elev","prec"),labels=c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) %>%
    left_join(sub_labels) %>% 
    mutate(env = factor(env, levels = c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) ->data_for_plot

data_for_plot %>%
  mutate(keep = case_when(
    trait %in% c("huber", "leaf_N") & env %in% c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)") ~ "keep",
  trait == "ci:ca" & env %in% c("MAT ~(degree*C)","VPD~(kPa)","Elevation~(m)") ~ "keep",
  trait == "leaf_area" & env %in% c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})") ~ "keep",
  trait %in% c("SLA","Wood_dens","height","seed_mass") & env %in% c("MAP~(mm~yr^{-1})") ~ "keep")) %>%
  mutate(value = ifelse(keep == "keep", value, NA_real_)) %>%
  mutate(annotation = ifelse(is.na(keep), "No prediction", "")) %>%
  ggplot(aes(env_value, value,group = trait)) +
  geom_point() + 
  scale_y_log10() +
  scale_x_log10() + 
  theme_bw() + 
    facet_grid(trait~env, scales = "free",labeller = label_parsed, drop=TRUE) + 
  theme(axis.title.x=element_blank())+
  theme(axis.title.y=element_blank())+
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 6), axis.text=element_text(size=7)) +
  geom_text(aes(label=annotation,x=Inf, y=Inf), hjust=1.35,vjust=4.5)

dev.off()
```


```{r, fig.width=10}
trait_names <- tibble(trait_name = core_traits,
                      trait = c("huber","ci:ca","leaf_N", "SLA", "Wood_dens", "height", "leaf_area","seed_mass"))

woody_field_traits_georef_tree_form_climate%>%
    filter(trait_name %in% core_traits) %>%
    left_join(by="trait_name", trait_names)%>%
    select(trait, value, Temp = avg_temp_WC, VPD = VPD_WC, PAR = solar_WC,elev = elev_WC, prec = prec_WC) %>%
    pivot_longer(-c("trait", "value"), names_to = "env", values_to = "env_value") %>%
    mutate(env = factor(env, levels = c("Temp","VPD","PAR","elev","prec"),labels=c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) %>%
    left_join(sub_labels) %>% 
    mutate(env = factor(env, levels = c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) ->data_for_plot

data_for_plot %>%
  mutate(keep = case_when(
    trait == "huber" & env %in% c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)") ~ "keep")) %>%
  filter(!is.na(keep))%>% 
  ggplot(aes(env_value, value,group = trait)) +
  geom_hex() + 
  scale_y_log10() +
  scale_x_log10() + 
  theme_bw() + 
  facet_wrap(trait ~ env, scales = "free", drop=TRUE) +
  theme(axis.title.x=element_blank())+
  theme(axis.title.y=element_blank()) +
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 6), axis.text=element_text(size=7))


```

```{r}
data_for_plot %>%
  filter(!(env == "Temp" & trait == "huber"))%>% 
  ggplot(aes(env_value, value, col = trait)) + geom_point(alpha = 0.3, shape=16, stroke=0, show.legend = F) + scale_y_log10()   +scale_x_log10()+ theme_classic() + facet_wrap(trait ~ env, scales = "free", drop=TRUE)+ scale_colour_viridis(discrete = TRUE) +theme(axis.title.x=element_blank()) +theme(axis.title.y=element_blank()) +
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 6), axis.text=element_text(size=7))
```



```{r, fig.width=10}
png("output/trait_by_environment_viridis_high_res_small_axes.png", height=1200, width=2600, res=300)
data_for_plot %>% 
  ggplot(aes(env_value, value, col = trait)) + geom_point(alpha = 0.3, shape=16, stroke=0, show.legend = F) + scale_y_log10()   +scale_x_log10()+ theme_classic() + facet_grid(trait ~ env, scales = "free")+ scale_colour_viridis(discrete = TRUE) +theme(axis.title.x=element_blank()) +theme(axis.title.y=element_blank()) +
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 6), axis.text=element_text(size=7))
dev.off()
```

Correlation plot using ellipses

```{r}
woody_field_traits_georef_tree_form_climate %>%
  filter(trait_name %in% core_traits) %>%
  left_join(by="trait_name", trait_names) %>%
  select(trait, value, Temp = avg_temp_WC, Max_Temp = max_temp_BC, GDD_5 = GDD_5_envirem, VPD = VPD_WC, PAR = solar_WC, Prec = prec_WC, PET = PET_envirem, MI = MI_WC, Prec_CV = Prec_CV_BC, elev = elev_WC,latitude,site_name, taxon_name, dataset_id, ID) %>%
  pivot_wider(values_from = value, names_from = trait) -> woody_field_traits_georef_tree_form_climate_wide

woody_field_traits_georef_tree_form_climate_wide %>%
  select(-c(,site_name, taxon_name, dataset_id, ID)) -> for_corrplot
trait_env_correlation<- cor(for_corrplot, use="pairwise.complete.obs")
corrplot::corrplot(trait_env_correlation[12:19,1:11], method="ellipse")
```

Leaf area analyses

```{r}
woody_field_traits_georef_tree_form_climate_wide%>%
mutate(aridity = case_when(MI < 0.5 ~ "MI < 0.5",
                           MI > 0.5 & MI < 1.5~"0.5 < MI < 1.5", 
                           MI > 1.5 ~ "MI > 1.5")) -> woody_field_traits_georef_tree_form_climate_wide


#assess correlation in each aridity group
correlation_aridity <- function(aridity_class){
  woody_field_traits_georef_tree_form_climate_wide %>%
    filter(aridity == aridity_class) -> woody_field_traits_georef_tree_form_climate_wide_for_function
  cor(x=woody_field_traits_georef_tree_form_climate_wide_for_function$leaf_area,y=woody_field_traits_georef_tree_form_climate_wide_for_function$latitude, use="pairwise.complete.obs")
}
  
correlation_coefficients<-purrr::map(unique(woody_field_traits_georef_tree_form_climate_wide$aridity)[c(2,3,1)], correlation_aridity)
correlation_coefficients <- tibble(correlation_values = paste("r = ",round(unlist(correlation_coefficients),2), sep=""), aridity = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"))
woody_field_traits_georef_tree_form_climate_wide%>%
  drop_na(aridity) %>%  
  left_join(correlation_coefficients) %>%
  mutate(aridity = factor(aridity, levels = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"))) %>%
  ggplot() +
  geom_point(aes(x=latitude, y=leaf_area), shape=17, size=2.5, colour="gray40") +
  facet_wrap(~aridity) +
  scale_y_log10() +
  theme_classic() +
  xlab("Latitude") +
  ylab("Leaf area")+
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  geom_text(mapping = aes(x = -Inf, y = Inf, label = aridity),hjust=-0.2,  vjust   = 1, colour="black", size=6)+ theme(panel.spacing = unit(2, "lines")) +
  geom_text(mapping = aes(x = Inf, y = Inf, label = correlation_values),hjust=1,  vjust   = 1, colour="black", size=6)+ theme(panel.spacing = unit(2, "lines")) +
  theme(axis.title = element_text(size=15), axis.text = element_text(size = 12))


```
