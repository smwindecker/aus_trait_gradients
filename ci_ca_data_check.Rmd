---
title: "c13 data"
author: "Isaac Towers"
date: "11/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls())

library(tidyverse)

#load in Austraits
austraits <- readRDS("data/austraits_develop.RDS")
```

```{r}
location_of_sites <-
  austraits$sites %>%
  filter(site_property %in% c("longitude (deg)", "latitude (deg)")) %>%
  spread(site_property, value) %>%
  rowid_to_column("ID") %>%
  rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
  mutate_at(c("latitude", "longitude"), ~suppressWarnings(as.numeric(.x))) %>%
  drop_na(longitude, latitude)

traits <- austraits$traits %>%
  left_join(location_of_sites) %>%
  filter(trait_name == c("ci_over_ca", "leaf_delta13C"))%>%
  mutate(value = as.numeric(value)) %>%
  left_join(austraits$taxa)
```


```{r}
#filter out data from experimental sites. unis and arboretums (i.e. only plant trait observed in the field)

field_traits <- traits %>%
  filter(!(dataset_id %in% c("Ahrens_2019", "Crous_2013", "Crous_2019", "Du_2018",
                            "Du_2019", "Duan_2015", "EsperonRodriguez_2019",
                            "EsperonRodriguez_2020","Everingham_2020",
                            "Farrell_2012", "Farrell_2013", "Farrell_2017", "Firn_2019",
                            "Gallagher_2011_1", "Gallagher_2011_3","Gallagher_2012", "Gallagher_2015", 
                            "Gardiner_2019", "Geange_2017", "Geange_2020", "Ghannoum_2010","Groom_2010",
                            "Harrison_2009",
                            "Hassiotou_2009", "Huang_2015", "Jagdish_2020", "Lewis_2015",
                            "Lusk_2012", "Lusk_2014", "Moore_2019_2", "Reynolds_2018", "Roderick_1999",
                            "Roderick_2002", "Schulze_2006", "Smith_2012",
                            "Tomlinson_2013","Tomlinson_2019", "Turner_2010", "Vesk_2019",
                            "Vlasveld_2018", "Warren_2005", "Warren_2006"))) %>%
  filter(!(site_name %in% c("Currency Creek Arboretum","Currency Creek Arboretum, South Australia",
                            "Australian National University glasshouse","MU_campus",
                            "Australian National Botanic Gardens","Australian National University"))) %>%
  filter(!(dataset_id %in% c("Kooyman_2011") & trait_name == "wood_density")) %>%
  filter(!(dataset_id %in% c("Wells_2012") & trait_name %in% c("seed_mass","wood_density")))
```

```{r}
# We also remove all trait values which are records across multiple sites, are from the literature, expert values, or are from unknown sources

field_traits %>%
  filter(value_type %in% c("raw_value", "site_mean", "site_max", "individual_mean") | trait_name == "plant_height") -> field_traits
```

```{r}
# Create a new trait dataframe to only include observations with associated latitude and longitude

field_traits_georef <- 
  field_traits %>%
  drop_na(latitude,longitude)
```

```{r}
# exclude all non-woody plants as listed below

woody_plant_growth_forms <- c("hemi-epiphyte_shrub", "hemi-epiphyte_tree", "leafless_shrub_tree", "parasite_woody", "subshrub", "shrub", "treelet", "tree", "shrub tree", "shrub treelet",
"shrub subshrub","herb subshrub", "herb_large shrub", "herb shrub", "tree tree")

austraits$traits %>% 
  filter(trait_name== "plant_growth_form") %>%
  group_by(taxon_name) %>% 
  filter(all((value %in% woody_plant_growth_forms))) %>%
  ungroup() %>%
  distinct(taxon_name)-> woody_taxa_plant_growth_form

austraits$traits %>% 
  filter(trait_name == "woodiness") %>% 
  group_by(taxon_name) %>%
  filter(all(value %in% c("woody","semi_woody"))) %>%
  distinct(taxon_name)%>%
  bind_rows(woody_taxa_plant_growth_form) %>%
    distinct(taxon_name) -> woody_taxa

# list of species which did not have woody data, updated with data pulled off internet
read_csv("data/no_woody_data_updated.csv") %>%
  filter(woodiness %in% c("woody","semi_woody")) %>%
           distinct(taxon_name) %>%
           bind_rows(woody_taxa) %>%
           distinct(taxon_name) -> woody_taxa
```

```{r include=FALSE}
# Remove woody plants

woody_field_traits_georef <- 
  field_traits_georef %>%
  filter(taxon_name %in% woody_taxa$taxon_name)
```

```{r include=FALSE}

# Go through and remove families which were recorded as woody but either aren't woody or do not have a tree/shrub-like growth form, e.g. grass,sedges, palms, ferns

ferns_species <-
  austraits$taxa%>%
  filter(family %in% c("Schizaeaceae", "Gleicheniaceae","Dennstaedtiaceae", "Polypodiaceae","Dicksoniaceae", "Datiscaceae"))

palm_species <-
  austraits$taxa%>%
  filter(family %in% c("Arecaceae"))

cycad_species <-
  austraits$taxa%>%
  filter(family %in% c("Cycadaceae","Zamiaceae", "Stangeriaceae"))

graminoid_species <-
  austraits$taxa %>%
  filter(family %in% c("Poaceae","Cyperaceae","Restionaceae"))

ginger_species <-
  austraits$taxa %>%
  filter(family %in% c("Zingiberaceae"))

woody_field_traits_georef %>%
  filter(!taxon_name %in% ferns_species$taxon_name) %>%
  filter(!taxon_name %in% palm_species$taxon_name)%>%
  filter(!taxon_name %in% cycad_species$taxon_name)%>%
  filter(!taxon_name %in% graminoid_species$taxon_name)%>%
  filter(!taxon_name %in% ginger_species$taxon_name) ->
  woody_field_traits_georef_tree_form
```

Data for c4 genus retrieved from: Sage, R. A portrait of the C4 photosynthetic family on the 50th anniversary of its discovery: species number, evolutionary lineages, and Hall of Fame. Journal of Experimental Biology. Supplementary Table S1. Bascially, just removes Atriplex. 

```{r}
c4_plants <- read_csv("data/c4_plants.csv")
table(c4_plants$family)

woody_field_traits_georef_tree_form %>%
  filter(!(genus %in% c4_plants$genus & family %in% c4_plants$family)) -> woody_field_traits_georef_tree_form
```

Function which calculates the min, max, s, ean, min max ratio, min max sum and cv ratio for a given trait for taxa with more than two observations.

```{r}
error_check <- function(data, trait_to_check){
  data %>%
    filter(trait_name == trait_to_check) %>%
    group_by(taxon_name, trait_name) %>%
    filter(n()>2) %>%
    summarise(max_value = max(value, na.rm=T), min_value = min(value, na.rm=T), sd_value = sd(value, na.rm=T), mean_value = mean(value, na.rm=T)) %>%
    mutate(max_min_ratio = max_value/min_value, max_min_sum = max_value + min_value, cv_value = sd_value/mean_value*100)-> error_check
  
  data %>%
    filter(taxon_name %in% error_check$taxon_name) %>%
    group_by(trait_name, taxon_name) %>%
    distinct(dataset_id) %>%
    mutate(studies = paste0(dataset_id, collapse= "")) %>%
    slice(1) %>%
    inner_join(error_check) -> error_check
}
```

Error checking for ci:ca ratio

```{r}
error_check(woody_field_traits_georef_tree_form, "ci_over_ca") -> error_check_ci_ca
```
Error checking for leaf_delta13C

```{r}
error_check(woody_field_traits_georef_tree_form, "leaf_delta13C") -> error_check_13C
```


Extract values for ci:ca ratios from delta13c using equations in Farqhuar (1989) and Wang et al. (2017)

Carbon isotope discrimination values are dervied from delta_13C $\delta ^{13}C$ using the following equation from Farqhuar (1989):

$$\Delta = \frac{\delta_a-\delta ^{13}C}{1+\delta ^{13}C/1000}$$

The ci:ca ratio $(X)$ is linked to the carbon isotope discrimination value of plant samples according the following equation:

$$X = \frac{\Delta-a}{b-a},$$
where a’ and b’ have standard values 4.4‰ and 27‰, representing the diffusional and biochemical components of carbon isotope discrimination, respectively (Wang et al. 2017).

What we do below is convert leaf_delta13c values to the ci:ca ratio, which can then be added to the pre-existing, raw ci:ca data. 

``` {r}
woody_field_traits_georef_tree_form %>% 
  select(trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date, ID) %>%
  group_by(trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date, ID) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  spread(key = trait_name, value = value)%>%
  mutate(delta_C = (-8-leaf_delta13C)/(1+leaf_delta13C/1000))%>%
  mutate(ci_over_ca_calc = (delta_C-4.4)/(27-4.4)) %>%
  mutate(ci_over_ca_combined = ifelse(!is.na(ci_over_ca),ci_over_ca,ci_over_ca_calc)) ->calculated_data

calculated_data %>%
  filter(!is.na(ci_over_ca_combined)) %>%
  mutate(units = "unitless",
         trait_name = "ci_over_ca_calc",
         value = as.numeric(ci_over_ca_combined)) %>%
  select(-ci_over_ca_combined) -> ci_over_ca_calculated

View(calculated_data)
```

Inspecting the calculated data and sorting by `ci_over_ca_combined` reveals that there are a number of extremely high values of ci:ca ratio, notably a number exceeding 1. In all cases bar 3, these data are all derived from very negative delta13c measurements in Austraits, rather than reported values of ci:ca . Also of note is the fact that the majority of these delta 13c values are from the Daintree, even from multiple studies. So, is it actually possible to have ci:ca > 1, or 1) the delta13c values are incorrect, or 2) the method of converting the values employed here is incorrect. To inspect the second option, I have run a couple of diganostics below. For studies where both the delta13c values and the ci:ca ratio was reported, I can check whether or not the conversion method is working. The histogram below suggests that there isnt a huge differnce bewteen observed and estimated values (but some very large differences are present).


``` {r, fig.width=10}

calculated_data %>% drop_na(leaf_delta13C, ci_over_ca)%>% mutate(proportion_difference = abs(ci_over_ca - ci_over_ca_calc)/ci_over_ca_calc) -> ci_over_ca_validation


hist(ci_over_ca_validation$proportion_difference, xlab = "abs(Observed_X-Predicted_X)/Predicted_X", main = "Difference between observed and predicted X")
```

The plots below show pretty poor correspondence for the most part between leaf delta 13 c and ci:ca ratio except for one study, which was Dong et al. 2017. Given the almost perfect 1:1 slope, I am convinced that I have at least used the method correctly as was employed in that study, but can't explain the otherwise poor relationship for the remaining data.

``` {r, fig.width=10}

ci_over_ca_validation %>% 
  ggplot(aes(x=ci_over_ca, y=leaf_delta13C))+
  geom_point()+
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14,face="bold")) +
  theme_classic()

ci_over_ca_validation %>% ggplot(aes(x=ci_over_ca, y=ci_over_ca_calc))+
  geom_point()+
  xlab("Observed ci_over_ca")+
  ylab("Estimated ci_over_ca")+
  theme(axis.text=element_text(size=12),axis.title=element_text(size=14,face="bold")) + 
  geom_abline(slope=1)+
  theme_classic()

ci_over_ca_validation %>% 
  ggplot(aes(x=ci_over_ca, y=ci_over_ca_calc, colour = dataset_id))+
  geom_point()+
  xlab("Observed ci_over_ca")+
  ylab("Estimated ci_over_ca")+
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14,face="bold")) + 
  geom_abline(slope=1) +
  theme_classic()
  
```

Check how these plots look against the environment

```{r}
climate_data <- readRDS("data/climate_data.RDS")

ci_over_ca_calculated %>%
  left_join(climate_data) %>%
  mutate(data_type = if_else(is.na(ci_over_ca), "Estimated", "Observed")) %>%
  ggplot() +
  geom_point(aes(x = avg_temp_WC, y = value, colour = data_type)) +
  theme_classic()


```

```{r}
ci_over_ca_calculated %>%
  left_join(climate_data) %>%
    ggplot() +
  geom_point(aes(x = avg_temp_WC, y = ci_over_ca)) +
  theme_classic()

ci_over_ca_calculated %>%
  left_join(climate_data) %>%
    ggplot() +
  geom_point(aes(x = avg_temp_WC, y = leaf_delta13C)) +
  theme_classic()

ci_over_ca_calculated %>%
  left_join(climate_data) %>%
    ggplot() +
  geom_point(aes(x = avg_temp_WC, y = ci_over_ca_calc)) +
  theme_classic()
```

