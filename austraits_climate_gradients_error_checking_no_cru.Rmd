---
title: Report on data in AusTraits
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---

Load data
```{r, warning=FALSE, message=FALSE}
# Install dependencies as needed
# devtools::install_deps()
# Load packages and functions for this analysis

rm(list=ls())
devtools::load_all()
source("R/load_climate_data_AWAP.R")
source("R/compile_and_read_AWAP_data.R")
source("R/load_bioclim.R")
source("R/load_worldclim.R")
source("R/plot_trait_by_dataset.R")
source("R/load_CRU_clim.R")
source("R/load_envirem.R")
source("R/load_terraclimate.R")
source("R/compile_terraclimate.R")
source("R/figure_opt_plot.R")
library(lubridate)
library(R.utils)
library(tidyverse)

# load trait data
austraits <- readRDS("data/austraits_develop.RDS")

```

```{r}
sum_no_NA <- function(x) if(all(is.na(x))) NA_integer_ else sum(x, na.rm=TRUE)
```

```{r}
##test to check if points were correclty sampled from raster

# raster::plot(new_worldclim)
# points(x=extracted_object$longitude, y=extracted_object$latitude, col=rev(terrain.colors(255))[(extracted_object$value - raster::minValue(new_worldclim))/
#                                          (raster::maxValue(new_worldclim)- raster::minValue(new_worldclim)) * 255])

```


```{r}
#where are sites located?

location_of_sites <-
  austraits$sites %>%
  filter(site_property %in% c("longitude (deg)", "latitude (deg)")) %>%
  spread(site_property, value) %>%
  rowid_to_column("ID") %>%
  rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
  mutate_at(c("latitude", "longitude"), ~suppressWarnings(as.numeric(.x))) %>%
  drop_na(longitude, latitude)


# load map of australia (required for climate data analysis)
au_map <- raster::raster("data/australia.tif")
```

<!-- Start with solar which has the highest temporal resolution (i.e. unique daily values) -->

<!-- ```{r} -->
<!-- # extract values for solar irradiance (12, 16-27th November 2009 missing, 2014 incomplete) -->

<!-- available_years <- c(1990:2008, 2010:2013) -->

<!-- #This function compiles extracts point values from daily spatial files and compiles these values into yearly csvs -->
<!-- map(available_years, compile_daily_solar_data) -->


<!-- #This function reads yearly csvs and compiles them into a total data frame -->
<!-- read_and_combine_compiled_solar_data() -->


<!-- read_csv("data/AWAP/AWAP_solar/compiled_annual_solar/compiled_total_solar_data.csv") %>% -->
<!--   filter(year %in% available_years) %>% -->
<!--   mutate(day = as.numeric(day)) -> solar_data_daily_AWAP -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #all other data is on at least a monthly scale, so let's convert solar to monthly before joining all enviro variables together (Solar has daily data for 1990 - 2013, except 2009 which had days missing) -->

<!-- if(file.exists("data/AWAP/AWAP_solar/compiled_annual_solar/compiled_monthly_solar_data.csv")){ -->
<!--   solar_data_monthly_AWAP<-read_csv("data/AWAP/AWAP_solar/compiled_annual_solar/compiled_monthly_solar_data.csv") -->
<!-- } else{ -->
<!--   solar_data_monthly_AWAP <- solar_data_daily_AWAP %>% -->
<!--   group_by(ID, year, month) %>% -->
<!--   summarise(mean_monthly_shortwave_radiation = mean(shortwave_radiation, na.rm=T)) %>% -->
<!--   ungroup() -->

<!--   write_csv(solar_data_monthly_AWAP,"data/AWAP/AWAP_solar/compiled_annual_solar/compiled_monthly_solar_data.csv") -->
<!-- } -->

<!-- solar_data_monthly_AWAP %>% -->
<!--   group_by(ID, year) %>% -->
<!--   summarise(mean_annual_shortwave_radiation_AWAP = mean(mean_monthly_shortwave_radiation, na.rm=T)) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(ID) %>% -->
<!--   summarise(mean_annual_shortwave_radiation_AWAP = mean(mean_annual_shortwave_radiation_AWAP, na.rm=T)) -> solar_data_AWAP -->

<!-- #remove the daily dataset to free up computational resources -->
<!-- rm(solar_data_daily_AWAP) -->

<!-- ``` -->

<!-- Next, data for which we have unique monthly data within years. -->

<!-- Start with Australian water availability project data -->

<!-- ```{r} -->
<!-- # Extract values for monthly totaly rainfall (mm) #2020 incomplete -->

<!-- compile_annual_rainfall_data() -->

<!-- annual_rainfall_data_AWAP <- read_csv("data/AWAP/agcd/v2/r005/01month/compiled_rainfall_data/compiled_rainfall_data.csv")%>% -->
<!--   select(-day) %>% -->
<!--   filter(year !="2020") %>% -->
<!--   rename(prec_AWAP = prec) %>% -->
<!--   select(-buffer_extracted) %>% -->
<!--   group_by(year, ID, latitude, longitude) %>% -->
<!--   summarise(prec_AWAP = sum_no_NA(prec_AWAP)) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(ID, latitude, longitude) %>% -->
<!--   summarise(prec_AWAP = mean(prec_AWAP, na.rm=T)) %>% -->
<!--   ungroup() -->
<!-- ``` -->


<!-- ```{r} -->
<!-- compile_terraclim_data_vpd() -->

<!-- vpd_terraclimate <- read_csv("data/TerraClimate_vpd/compiled_TerraClimate_vpd/compiled_TerraClimate_vpd.csv") %>% -->
<!--   select(-day) %>% -->
<!--   select(-buffer_extracted) %>% -->
<!--   group_by(year, ID, latitude,longitude) %>% -->
<!--   summarise(vpd_terraclim = mean(vpd_terraclim , na.rm=T)) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(ID, latitude,longitude) %>% -->
<!--   summarise(vpd_terraclim = mean(vpd_terraclim, na.rm=T)) %>% -->
<!--   ungroup()  -->

<!-- ``` -->


<!-- ```{r} -->
<!-- # First, extract values for 9am vapour pressure (hPA) #2020 incomplete -->

<!-- compile_vp_09_data() -->

<!-- vp_09_data_AWAP <- read_csv("data/AWAP/agcd/v1/vapourpres_h09_monthly/mean/r005/01month/compiled_h09_data/compiled_h09_data.csv") %>% -->
<!--   select(-day) %>% -->
<!--   filter(year !="2020")%>% -->
<!--   rename(vp09_AWAP = vp09) %>% -->
<!--   select(-buffer_extracted) -->


<!-- # vp_09_data_AWAP1 <- read_csv("data/AWAP/agcd/v1/vapourpres_h09_monthly/mean/r005/01month/compiled_h09_data/compiled_h09_data1.csv") %>% -->
<!-- #   select(-day) %>% -->
<!-- #   filter(year !="2020")%>% -->
<!-- #   rename(vp09_AWAP = vp09) %>% -->
<!-- #   select(-buffer_extracted) -->
<!-- # -->
<!-- # plot(vp_09_data_AWAP$vp09_AWAP~vp_09_data_AWAP1$vp09_AWAP) -->


<!-- ``` -->

<!-- ```{r} -->
<!-- # Next, extract values for 3pm vapour pressure (hPA) #2020 incomplete -->

<!-- compile_vp_15_data() -->

<!-- vp_15_data_AWAP <- read_csv("data/AWAP/agcd/v1/vapourpres_h15_monthly/compiled_h15_data/compiled_h15_data.csv") %>% -->
<!--   select(-day)%>% -->
<!--   filter(year !="2020")%>% -->
<!--   rename(vp15_AWAP = vp15)%>% -->
<!--   select(-buffer_extracted) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- # Next, extract values for average monthly maximum temperature #2020 incomplete -->

<!-- compile_max_T_data() -->

<!-- max_t_data_AWAP <- read_csv("data/AWAP/agcd/v1/monthly_tmax/compiled_temperature_data/compiled_temperature_data.csv") %>%select(-day) %>% -->
<!--   filter(year !="2020") %>% -->
<!--   rename(max_t_AWAP = max_t)%>% -->
<!--   select(-buffer_extracted) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- vpd_data_AWAP <- left_join(max_t_data_AWAP, vp_15_data_AWAP) %>% -->
<!--   left_join(vp_09_data_AWAP) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- #add vapour pressure deficit to dataframe using formulas for saturated vapour pressure (esat; kPa) and vapour pressure deficit (VPD; kPa) in Monteith JL & Unsworth MH (1990) Principles of environmental physics -->

<!-- es_T_star = 0.611 #kPa -->
<!-- T_dash = 36.0;  #K -->
<!-- T_star = 273.0; #K -->
<!-- A = 17.27 -->
<!-- DEG_TO_KELVIN = 273.0 # convert celcius to kelvins -->
<!-- hPa_to_kPA = 1/10 #vapour pressure is in hPa -->

<!-- vpd_data_AWAP$max_t_K_AWAP<- vpd_data_AWAP$max_t_AWAP+DEG_TO_KELVIN -->

<!-- vpd_data_AWAP$esat = es_T_star * exp(A * (vpd_data_AWAP$max_t_K_AWAP - T_star) / (vpd_data_AWAP$max_t_K_AWAP - T_dash)) -->

<!-- #convert vapour pressure to kPa -->

<!-- vpd_data_AWAP$vp_09_kpa_AWAP <- vpd_data_AWAP$vp09_AWAP * hPa_to_kPA -->
<!-- vpd_data_AWAP$vp_15_kpa_AWAP <- vpd_data_AWAP$vp15_AWAP * hPa_to_kPA -->

<!-- #VPD is saturated vapour pressure minus vapour pressure -->

<!-- vpd_data_AWAP$VPD_09 <- vpd_data_AWAP$esat - vpd_data_AWAP$vp_09_kpa_AWAP -->
<!-- vpd_data_AWAP$VPD_15 <- vpd_data_AWAP$esat - vpd_data_AWAP$vp_15_kpa_AWAP -->
<!-- ``` -->

<!-- ```{r} -->
<!-- vpd_data_AWAP %>% -->
<!--   group_by(year, ID, latitude,longitude) %>% -->
<!--   summarise(VPD_09_AWAP = mean(VPD_09, na.rm=T), -->
<!--             VPD_15_AWAP = mean(VPD_15, na.rm=T), -->
<!--             max_t_AWAP = mean(max_t_AWAP, na.rm=T)) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(ID, latitude,longitude) %>% -->
<!--   summarise(VPD_09_AWAP = mean(VPD_09_AWAP, na.rm=T), -->
<!--             VPD_15_AWAP = mean(VPD_15_AWAP, na.rm=T), -->
<!--             max_t_AWAP = mean(max_t_AWAP, na.rm=T)) %>% -->
<!--   ungroup() %>% -->
<!--   left_join(solar_data_AWAP) %>% -->
<!--   left_join(annual_rainfall_data_AWAP) -> climate_data_AWAP -->
<!-- ``` -->

<!-- Next, prepare monthly data from the Worldclim dataset. Worldclim has monthly values averaged across years -->

<!-- ```{r} -->
<!-- load_worldclim("data/WC/wc2.1_30s_elev/", "elev_worldclim") -->

<!-- elev_worldclim <- read_csv("data/WC/wc2.1_30s_elev/elev_worldclim.csv") %>% -->
<!--   rename(elev_WC = value)%>% -->
<!--   select(-buffer_extracted, -month) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- load_worldclim("data/WC/wc2.1_30s_prec/", "prec_worldclim") -->

<!-- prec_worldclim <- read_csv("data/WC/wc2.1_30s_prec/prec_worldclim.csv") %>% -->
<!--   rename(prec_WC = value)%>% -->
<!--   select(-buffer_extracted) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- load_worldclim("data/WC/wc2.1_30s_tavg/", "avg_temp_wordlclim") -->

<!-- avg_temp_worldclim <- read_csv("data/WC/wc2.1_30s_tavg/avg_temp_wordlclim.csv") %>% -->
<!--   rename(avg_temp_WC = value)%>% -->
<!--   select(-buffer_extracted) -->

<!-- avg_temp_5_worldclim <- avg_temp_worldclim %>% -->
<!--   filter(avg_temp_WC >= 5) %>% -->
<!--   rename(avg_temp_WC_5 = avg_temp_WC) -->

<!-- avg_temp_0_worldclim <- avg_temp_worldclim %>% -->
<!--   filter(avg_temp_WC >= 0) %>% -->
<!--   rename(avg_temp_WC_0 = avg_temp_WC) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- load_worldclim("data/WC/wc2.1_30s_srad/", "solar_wordlclim") -->

<!-- solar_worldclim_data <- read_csv("data/WC/wc2.1_30s_srad/solar_wordlclim.csv") %>% -->
<!--   rename(solar_WC = value)%>% -->
<!--   select(-buffer_extracted) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- load_worldclim("data/WC/wc2.1_30s_vapr/", "VP_wordlclim") -->

<!-- VP_worldclim_data <- read_csv("data/WC/wc2.1_30s_vapr/VP_wordlclim.csv") %>% -->
<!--   rename(VP_WC = value)%>% -->
<!--   select(-buffer_extracted) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- load_worldclim("data/WC/wc2.1_30s_tmax/", "tmax_wordlclim") -->

<!-- tmax_worldclim_data <- read_csv("data/WC/wc2.1_30s_tmax/tmax_wordlclim.csv") %>% -->
<!--   rename(tmax_WC = value)%>% -->
<!--   select(-buffer_extracted) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- vpd_data_WC <- left_join(tmax_worldclim_data, VP_worldclim_data) %>% -->
<!--   left_join(avg_temp_worldclim) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # #add vapour pressure deficit to dataframe using formulas for saturated vapour pressure (esat; kPa) and vapour pressure deficit (VPD; kPa) in Monteith JL & Unsworth MH (1990) Principles of environmental physics -->
<!-- # -->
<!-- es_T_star = 0.611 #kPa -->
<!-- T_dash = 36.0;  #K -->
<!-- T_star = 273.0; #K -->
<!-- A = 17.27 -->
<!-- DEG_TO_KELVIN = 273.0 # convert celcius to kelvins -->

<!-- vpd_data_WC$max_t_K_WC<- vpd_data_WC$tmax_WC+DEG_TO_KELVIN -->

<!-- vpd_data_WC$esat = es_T_star * exp(A * (vpd_data_WC$max_t_K_WC - T_star) / (vpd_data_WC$max_t_K_WC - T_dash)) -->

<!-- #VPD is saturated vapour pressure minus vapour pressure -->

<!-- vpd_data_WC$VPD_WC <- vpd_data_WC$esat - vpd_data_WC$VP_WC -->


<!-- vpd_data_WC$mean_t_K_WC<- vpd_data_WC$avg_temp_WC+DEG_TO_KELVIN -->

<!-- vpd_data_WC$esat_mean_t = es_T_star * exp(A * (vpd_data_WC$mean_t_K_WC - T_star) / (vpd_data_WC$mean_t_K_WC - T_dash)) -->

<!-- #VPD is saturated vapour pressure minus vapour pressure -->

<!-- vpd_data_WC$VPD_WC_mean_t <- vpd_data_WC$esat_mean_t - vpd_data_WC$VP_WC -->

<!-- ``` -->

<!-- ```{r} -->
<!-- vpd_data_WC %>% -->
<!--   select(tmax_WC, ID, latitude, longitude, month, VPD_WC, VPD_WC_mean_t,VP_WC) %>% -->
<!--   left_join(solar_worldclim_data) %>% -->
<!--   left_join(avg_temp_worldclim) %>% -->
<!--   left_join(avg_temp_5_worldclim) %>% -->
<!--   left_join(avg_temp_0_worldclim) %>% -->
<!--   left_join(prec_worldclim) %>% -->
<!--   left_join(elev_worldclim) %>% -->
<!--   group_by(ID, latitude, longitude) %>% -->
<!--   summarise(VPD_WC = mean(VPD_WC, na.rm=T), -->
<!--             VPD_WC_mean_t = mean(VPD_WC_mean_t, na.rm=T), -->
<!--             VP_WC = mean(VP_WC, na.rm=T), -->
<!--             solar_WC = mean(solar_WC, na.rm=T), -->
<!--             avg_temp_WC = mean(avg_temp_WC, na.rm=T), -->
<!--             avg_temp_WC_5 = mean(avg_temp_WC_5, na.rm=T), -->
<!--             avg_temp_WC_0 = mean(avg_temp_WC_0, na.rm=T), -->
<!--             prec_WC = sum_no_NA(prec_WC), -->
<!--             tmax_WC = mean(tmax_WC, na.rm=T), -->
<!--             elev_WC = mean(elev_WC, na.rm=T))-> climate_data_WC -->

<!-- ``` -->

<!-- Also, bring in some data from the ENVIREM dataset which is derived from Worldclim data. Specifically, PET and growing degree days. -->

<!-- ```{r} -->
<!-- load_envirem("data/Envirem/Australia_current_30arcsec_geotiff_set1/","PET_ENVIREM") -->

<!-- PET_envirem <- read_csv("data/Envirem/Australia_current_30arcsec_geotiff_set1/PET_ENVIREM.csv") %>% -->
<!--   rename(PET_envirem = value) %>% -->
<!--   select(-buffer_extracted) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- load_envirem("data/Envirem/Australia_current_30arcsec_geotiff_set2/","growing_deg_day_5") -->

<!-- GDD_5_envirem <- read_csv("data/Envirem/Australia_current_30arcsec_geotiff_set2/growing_deg_day_5.csv") %>% -->
<!--   rename(GDD_5_envirem = value) %>% -->
<!--   select(-buffer_extracted) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- climate_data_WC <- left_join(climate_data_WC, PET_envirem) %>% -->
<!--   mutate(MI_WC = prec_WC/PET_envirem) %>% -->
<!--   left_join(GDD_5_envirem) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- #bind wordclim data to compare temp and rainfall data to -->

<!-- #load bioclim data -->
<!-- climate_data_BC <- load_climate_data() %>% -->
<!--   select(-buffer_extracted) %>% -->
<!--   pivot_wider(names_from = key, values_from= value) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- climate_data <- climate_data_AWAP %>% -->
<!--   left_join(climate_data_WC) %>% -->
<!--   left_join(climate_data_BC) %>% -->
<!--   left_join(vpd_terraclimate) -->
<!-- ``` -->


```{r}
# saveRDS(climate_data, "data/climate_data.RDS")
climate_data <- readRDS("data/climate_data.RDS")
```



```{r}
library("GGally")

climate_data %>% 
  select(starts_with(c("Prec","prec")), -Prec_CV_BC) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

climate_data %>% 
  select(avg_temp_WC, Temp_BC) %>%
  mutate(Temp_BC = Temp_BC/10) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

climate_data %>% 
  select(starts_with("VPD")) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

climate_data %>% 
  select(mean_annual_shortwave_radiation_AWAP, solar_WC) %>%
  mutate(mean_annual_shortwave_radiation_AWAP = mean_annual_shortwave_radiation_AWAP * 1000) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

climate_data %>% 
  select(VPD_WC, VPD_WC_mean_t) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank") +
  geom_abline(slope=1, intercept=0, col="red", linetype=3, size=2)

plot(climate_data$VPD_WC, climate_data$VPD_WC_mean_t)

climate_data %>%
  select(VP_WC, avg_temp_WC, VPD_WC, VPD_WC_mean_t, tmax_WC) %>%
  ggpairs(upper=list(continuous = "points"), diag="blank")

plot(climate_data$VPD_WC_mean_t, climate_data$vpd_terraclim)

plot(climate_data$GDD_5_envirem, climate_data$avg_temp_WC_5)

abline(0,1)
```

```{r}
library(corrplot)

climate_data %>% 
  select(-ID, -latitude, -longitude) %>%
  cor(use="pairwise.complete.obs") %>%
  corrplot(., diag=TRUE, method = "ellipse", type="upper", order="AOE", tl.cex=0.5)

```


```{r}
traits <- austraits$traits %>%
  left_join(location_of_sites) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass","leaf_N_per_area","ci_over_ca","wood_density","plant_height", "seed_mass", "leaf_delta13C","huber_value")) %>%
  mutate(value = as.numeric(value)) %>%
  left_join(climate_data)
```


```{r}
field_traits <- traits %>%
  filter(!(dataset_id %in% c("Ahrens_2019", "Crous_2013", "Crous_2019", "Du_2018",
                            "Du_2019", "Duan_2015", "EsperonRodriguez_2019",
                            "EsperonRodriguez_2020","Everingham_2020",
                            "Farrell_2012", "Farrell_2013", "Farrell_2017", "Firn_2019",
                            "Gallagher_2011_1", "Gallagher_2011_3","Gallagher_2012", "Gallagher_2015", 
                            "Gardiner_2019", "Geange_2017", "Geange_2020", "Ghannoum_2010","Groom_2010",
                            "Harrison_2009",
                            "Hassiotou_2009", "Huang_2015", "Jagdish_2020", "Lewis_2015",
                            "Lusk_2012", "Lusk_2014", "Moore_2019_2", "Reynolds_2018", "Roderick_1999",
                            "Roderick_2002", "Schulze_2006", "Smith_2012",
                            "Tomlinson_2013","Tomlinson_2019", "Turner_2010", "Vesk_2019",
                            "Vlasveld_2018", "Warren_2005", "Warren_2006"))) %>%
  filter(!(site_name %in% c("Currency Creek Arboretum","Currency Creek Arboretum, South Australia",
                            "Australian National University glasshouse","MU_campus",
                            "Australian National Botanic Gardens","Australian National University"))) %>%
  filter(!(dataset_id %in% c("Kooyman_2011") & trait_name == "wood_density")) %>%
  filter(!(dataset_id %in% c("Wells_2012") & trait_name %in% c("seed_mass","wood_density")))

```

We also remove all trait values which are records across multiple sites, are from the literature, expert values, or are from unknown sources

```{r}
field_traits %>%
  filter(value_type %in% c("raw_value", "site_mean", "site_max", "individual_mean") | trait_name == "plant_height") -> field_traits
```

Create a new trait dataframe to only include observations with associated latitude and longitude
```{r}
field_traits_georef <- 
  field_traits %>%
  drop_na(latitude,longitude)
```

```{r}

woody_plant_growth_forms <- c("hemi-epiphyte_shrub", "hemi-epiphyte_tree", "leafless_shrub_tree", "parasite_woody", "subshrub", "shrub", "treelet", "tree", "shrub tree", "shrub treelet",
"shrub subshrub","herb subshrub", "herb_large shrub", "herb shrub", "tree tree")

austraits$traits %>% 
  filter(trait_name== "plant_growth_form") %>%
  group_by(taxon_name) %>% 
  filter(all((value %in% woody_plant_growth_forms))) %>%
  ungroup() %>%
  distinct(taxon_name)-> woody_taxa_plant_growth_form

austraits$traits %>% 
  filter(trait_name == "woodiness") %>% 
  group_by(taxon_name) %>%
  filter(all(value %in% c("woody","semi_woody"))) %>%
  distinct(taxon_name)%>%
  bind_rows(woody_taxa_plant_growth_form) %>%
    distinct(taxon_name) -> woody_taxa

# list of species which did not have woody data, updated with data pulled off internet
read_csv("data/no_woody_data_updated.csv") %>%
  filter(woodiness %in% c("woody","semi_woody")) %>%
           distinct(taxon_name) %>%
           bind_rows(woody_taxa) %>%
           distinct(taxon_name) -> woody_taxa

```

Create a new trait dataframe to only include observations with associated latitude and longitude
```{r include=FALSE}
woody_field_traits_georef <- 
  field_traits_georef %>%
  filter(taxon_name %in% woody_taxa$taxon_name)
```

Go through and remove families which were recorded as woody but either aren't woody or do not have a tree/shrub-like growth form, e.g. grass,sedges, palms, ferns

```{r include=FALSE}
ferns_species <-
  austraits$taxa%>%
  filter(family %in% c("Schizaeaceae", "Gleicheniaceae","Dennstaedtiaceae", "Polypodiaceae","Dicksoniaceae", "Datiscaceae"))

palm_species <-
  austraits$taxa%>%
  filter(family %in% c("Arecaceae"))

cycad_species <-
  austraits$taxa%>%
  filter(family %in% c("Cycadaceae","Zamiaceae", "Stangeriaceae"))

graminoid_species <- 
  austraits$taxa %>%
  filter(family %in% c("Poaceae","Cyperaceae","Restionaceae"))

ginger_species <- 
  austraits$taxa %>%
  filter(family %in% c("Zingiberaceae"))

woody_field_traits_georef %>%
  filter(!taxon_name %in% ferns_species$taxon_name) %>%
  filter(!taxon_name %in% palm_species$taxon_name)%>%
  filter(!taxon_name %in% cycad_species$taxon_name)%>%
  filter(!taxon_name %in% graminoid_species$taxon_name)%>%
  filter(!taxon_name %in% ginger_species$taxon_name) ->
  woody_field_traits_georef_tree_form
```

For species with more than one observation, we can check to see if their values are relatively consistent by inspecting max:min ratio, sd, CV etc. We need to do this seperately for measurements involving leaves and for the rest of the traits because of the fact that hte leaf vs. leaflet perspective will lead to large differences in measurements. So we need to first divide the leaf area dataset up into leaf area measurements on simple leaves, compound leaves measured at the leaflet scale, and leaf area measured at the leaf scale. 


```{r}
read_csv("data/datasets_with_leaf_area_or_dry_mass.csv") %>%
  select(dataset_id, compound_species, leaf_unit_measured)-> leaf_area_leaf_dry_mass_studies

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "no_compound") -> no_compound

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "compound_present" & leaf_unit_measured == "leaflet") -> compound_leaflet

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "compound_present" & leaf_unit_measured %in% c(NA,"leaf")) %>%
  mutate(trait_name = paste(trait_name, "_leaf_unit", sep=""))-> compound_leaf

leaf_leaflet <- bind_rows(no_compound, compound_leaflet)  %>%
  mutate(trait_name = paste(trait_name, "_leaflet_unit", sep=""))
```

Below, we are going to do some error checking. The first step is to see if there are any outliers based on other observations of that species' traits. Next, will inspect to see if data is duplicated across studies, which might occur when studies share data (although most will be removed if they did not have the "field" identifier from above). Finally, compare the distribution of a given dataset for a trait to the entire distribution of that trait to see if there are any data-set scale issues. 

Error checking for leaf area for 1) simple leaf area and compound leaf area measured at leaflet scale and 2) compound leaf area measured at leaf scale.

```{r}

error_check(leaf_leaflet, "leaf_area_leaflet_unit") -> error_check_leaf_leaflet_leaf_area
error_check(leaf_leaflet, "leaf_area_leaflet_unit") -> error_check_leaf_leaflet_leaf_dry_mass

error_check(compound_leaf, "leaf_area_leaf_unit") -> error_check_compound_leaf_area
error_check(compound_leaf, "leaf_area_leaf_unit") -> error_check_compound_leaf_dry_mass
```

Error checking for specific leaf area

```{r}
error_check(woody_field_traits_georef_tree_form, "specific_leaf_area") -> error_check_SLA
```

Error checking for huber value

```{r}
error_check(woody_field_traits_georef_tree_form, "huber_value") -> error_check_huber
```

Error checking for leaf N per area

```{r}
error_check(woody_field_traits_georef_tree_form, "leaf_N_per_area") -> error_check_leaf_N
```

Error checking for wood density - no problematic data points detected

```{r}
error_check(woody_field_traits_georef_tree_form, "wood_density") -> error_check_wood_density
```

Error checking for plant height - no problematic data points detected

```{r}
error_check(woody_field_traits_georef_tree_form, "plant_height") -> error_check_plant_height
```

Error checking for ci:ca ratio

```{r}
error_check(woody_field_traits_georef_tree_form, "ci_over_ca") -> error_check_ci_ca
```

Error checking for leaf_delta13C - no problematic points detected

```{r}
error_check(woody_field_traits_georef_tree_form, "leaf_delta13C") -> error_check_13C
```

Error checking for seed mass

```{r}
error_check(woody_field_traits_georef_tree_form, "seed_mass") -> error_check_seed_mass
```

To see if there any instances where data is shared between studies, we inspect occurrences of identical trait values for each trait~species group. Although there are a number of cases where this occurs, most seem to be coincidental.

```{r}
woody_field_traits_georef_tree_form %>%
  group_by(value, taxon_name, trait_name) %>% 
  filter(n()>1) %>% 
  filter(n_distinct(dataset_id)>1) -> identical_values
```


Combine leaf mass and area back onto dataframe now that it is seperated into studies which considered the leaflet scale vs. leaf scale

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(trait_name %in% c("leaf_area", "leaf_dry_mass"))) %>%
  bind_rows(leaf_leaflet) %>%
  bind_rows(compound_leaf) -> woody_field_traits_georef_tree_form
```

We will now inspect distribution of data in each study relative to total distribution to see if there is any erroneous data
```{r eval=FALSE, include=FALSE}
traits_to_inspect <- woody_field_traits_georef_tree_form %>%
   distinct(trait_name)

trait_by_dataset_core_traits<-function(trait){

woody_field_traits_georef_tree_form %>%
  filter(trait_name == trait) %>%
  distinct(dataset_id) -> dataset_index

purrr::map(dataset_index$dataset_id, plot_trait_by_dataset, trait)
}

purrr::map(traits_to_inspect$trait_name, trait_by_dataset_core_traits)
```


```{r}
erroneous_values <- read_csv("data/erroneous_values.csv")

erroneous_list <- vector("list", nrow(erroneous_values))

for(i in 1:nrow(erroneous_values)){
  erroneous_data <- erroneous_values[i,] %>% select_if(~ !any(is.na(.)))
  erroneous_data <- woody_field_traits_georef_tree_form %>% left_join(erroneous_data) %>% drop_na(erroneous)
  erroneous_list[[i]] <- erroneous_data
}

woody_field_traits_georef_tree_form_error <- left_join(woody_field_traits_georef_tree_form,bind_rows(erroneous_list))
```


Calculate leaf_N_per_area and leaf_area for additional observations:
```{r include=FALSE}
woody_field_traits_georef_tree_form %>% 
  filter(trait_name %in% c("leaf_dry_mass_leaflet_unit","leaf_dry_mass_leaf_unit","leaf_area_leaflet_unit","leaf_area_leaf_unit","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass","leaf_N_per_area")) %>%
  select(ID, trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date) %>%
    group_by(ID, trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  mutate(value = as.numeric(value)) %>%
    pivot_wider(names_from = trait_name, values_from = value) %>%
  mutate(leaf_area_combined = ifelse(!is.na(leaf_area_leaflet_unit),leaf_area_leaflet_unit,specific_leaf_area*leaf_dry_mass_leaflet_unit)) %>%
  mutate(specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area),specific_leaf_area,leaf_area_leaflet_unit/leaf_dry_mass_leaflet_unit)) %>%
  mutate(specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area_combined),specific_leaf_area_combined,leaf_area_leaf_unit/leaf_dry_mass_leaf_unit)) %>%
  mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area_combined,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass_leaflet_unit/leaf_area_leaflet_unit,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA)) %>%
   mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass_leaf_unit/leaf_area_leaf_unit,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA))->calculated_data
  
  
calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_N_per_area_combined) %>%
  filter(!is.na(leaf_N_per_area_combined)) %>%
  mutate(units = "g/m2",
         trait_name = "leaf_N_per_area_calc",
         value = leaf_N_per_area_combined) %>%
  select(-leaf_N_per_area_combined) -> leaf_N_per_area_calcuated

calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_area_combined) %>%
  filter(!is.na(leaf_area_combined)) %>%
  mutate(units = "mm2",
         trait_name = "leaf_area_calc",
         value = leaf_area_combined) %>%
  select(-leaf_area_combined) -> leaf_area_calcuated

calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         specific_leaf_area_combined) %>%
  filter(!is.na(specific_leaf_area_combined)) %>%
  mutate(units = "mm2/mg",
         trait_name = "specific_leaf_area_calc",
         value = specific_leaf_area_combined) %>%
  select(-specific_leaf_area_combined) -> specific_leaf_area_calcuated


```

Extract values for ci:ca ratios from delta13c using equations in Farqhuar (1989) and Wang et al. (2017)

Carbon isotope discrimination values are dervied from delta_13C $\delta ^{13}C$ using the following equation from Farqhuar (1989):

$$\Delta = \frac{\delta_a-\delta ^{13}C}{1+\delta ^{13}C/1000}$$

The ci:ca ratio $(X)$ is linked to the carbon isotope discrimination value of plant samples according the following equation:

$$X = \frac{\Delta-a}{b-a},$$
where a’ and b’ have standard values 4.4‰ and 27‰, representing the diffusional 
and biochemical components of carbon isotope discrimination, respectively (Wang et al. 2017).


``` {r}
woody_field_traits_georef_tree_form %>% 
  filter(trait_name %in% c("ci_over_ca", "leaf_delta13C")) %>%
  select(trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date, ID) %>%
  mutate(value = as.numeric(value)) %>%
  group_by(trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date, ID) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  spread(key = trait_name, value = value)%>%
  mutate(delta_C = (-8-leaf_delta13C)/(1+leaf_delta13C/1000))%>%
  mutate(ci_over_ca_calc = (delta_C-4.4)/(27-4.4)) %>%
  mutate(ci_over_ca_combined = ifelse(!is.na(ci_over_ca),ci_over_ca,ci_over_ca_calc)) ->calculated_data

calculated_data %>%
  select(observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         ci_over_ca_combined, ID) %>%
  filter(!is.na(ci_over_ca_combined)) %>%
  mutate(units = "unitless",
         trait_name = "ci_over_ca_calc",
         value = as.numeric(ci_over_ca_combined)) %>%
  select(-ci_over_ca_combined) -> ci_over_ca_calculated

```


``` {r, fig.width=10}

calculated_data %>% drop_na(leaf_delta13C, ci_over_ca)%>% mutate(proportion_difference = abs(ci_over_ca - ci_over_ca_calc)/ci_over_ca_calc) -> ci_over_ca_validation


hist(ci_over_ca_validation$proportion_difference, xlab = "abs(Observed_X-Predicted_X)/Predicted_X", main = "Difference between observed and predicted X")
```


``` {r, fig.width=10}
#add a 1:1 line

ci_over_ca_validation %>% ggplot(aes(x=ci_over_ca, y=leaf_delta13C))+geom_point()+theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))

ci_over_ca_validation %>% ggplot(aes(x=ci_over_ca, y=ci_over_ca_calc))+geom_point()+xlab("Observed ci_over_ca")+ylab("Estimated ci_over_ca")+theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) + geom_abline(yintercept=0, slope=1)
```

Bind cliamte data to the summarised data frame
```{r}
woody_field_traits_georef_tree_form %>%
  bind_rows(leaf_N_per_area_calcuated) %>%
  bind_rows(leaf_area_calcuated) %>%
  bind_rows(specific_leaf_area_calcuated) %>%
  bind_rows(ci_over_ca_calculated) %>%
  group_by(site_name, taxon_name, dataset_id, trait_name, ID) %>%
  summarise(value=mean(value, na.rm=T)) %>%
  ungroup() %>%
  left_join(climate_data)-> woody_field_traits_georef_tree_form_climate
```

Need to also transform ci:ca ratio to the logit form

```{r}
woody_field_traits_georef_tree_form_climate %>%
  filter(trait_name == "ci_over_ca_calc") %>%
  filter(value <=1) %>%
  mutate(value = log(value/(1-value))) %>%
  mutate(trait_name = "logit_ci_over_ca_calc") -> logit_ci_over_ca

woody_field_traits_georef_tree_form_climate %>%
  bind_rows(logit_ci_over_ca) -> woody_field_traits_georef_tree_form_climate
```


```{r}
#define the core traits to focus on
core_traits <- c("huber_value","logit_ci_over_ca_calc","leaf_N_per_area_calc","specific_leaf_area_calc","wood_density","plant_height","leaf_area_calc","seed_mass")
```


First, let's calculate the correlations between the traits and the environmental variables. This is will be the key statistic which will be used for analysis.For starters, which traits and environmental variables are not normally distributed? We need to turn the data into a wide format.

```{r}

#turn the trait data into a wide format for correlation analyses
woody_field_traits_georef_tree_form_climate %>%
  filter(trait_name %in% core_traits) %>%
  select(trait_name, value, Temp = Temp_BC, Max_Temp = max_temp_BC, GDD_5 = GDD_5_envirem, VPD_terra = vpd_terraclim, avg_temp_WC_5=avg_temp_WC_5,  VPD_AWAP = VPD_15_AWAP, VPD = VPD_WC, VPD_WC_mean_t = VPD_WC_mean_t, SWdown = solar_WC, Prec = Prec_BC, PET = PET_envirem, Prec_CV = Prec_CV_BC, elev = elev_WC,latitude,longitude,site_name, taxon_name, dataset_id, ID) %>%
  mutate(MI = Prec/PET) %>%
  pivot_wider(values_from = value, names_from = trait_name) -> woody_field_traits_georef_tree_form_climate_wide


#environmental variables
hist(woody_field_traits_georef_tree_form_climate_wide$Temp)
hist(woody_field_traits_georef_tree_form_climate_wide$avg_temp_WC_5)
hist(woody_field_traits_georef_tree_form_climate_wide$Max_Temp)
hist(woody_field_traits_georef_tree_form_climate_wide$GDD_5)
hist(log(woody_field_traits_georef_tree_form_climate_wide$VPD))
hist(log(woody_field_traits_georef_tree_form_climate_wide$VPD_AWAP))
hist(log(woody_field_traits_georef_tree_form_climate_wide$VPD_terra))

hist(woody_field_traits_georef_tree_form_climate_wide$SWdown)
hist(log(woody_field_traits_georef_tree_form_climate_wide$Prec))
hist(woody_field_traits_georef_tree_form_climate_wide$PET)
hist(log(woody_field_traits_georef_tree_form_climate_wide$MI))
hist(log(woody_field_traits_georef_tree_form_climate_wide$Prec_CV))
hist(sqrt(woody_field_traits_georef_tree_form_climate_wide$elev))
hist((woody_field_traits_georef_tree_form_climate_wide$latitude))

#traits
hist(log(woody_field_traits_georef_tree_form_climate_wide$leaf_area_calc))
hist(log(woody_field_traits_georef_tree_form_climate_wide$specific_leaf_area_calc))
hist(woody_field_traits_georef_tree_form_climate_wide$wood_density)
hist(log(woody_field_traits_georef_tree_form_climate_wide$leaf_N_per_area_calc))
hist(log(woody_field_traits_georef_tree_form_climate_wide$plant_height))
hist(log(woody_field_traits_georef_tree_form_climate_wide$huber_value))
hist(log(woody_field_traits_georef_tree_form_climate_wide$seed_mass))
hist((woody_field_traits_georef_tree_form_climate_wide$logit_ci_over_ca_calc))

#all traits bar wood density and ci:ca ratio, which is already logit, will be log transformed.
```


Basic patterns with environment - first without transforming the variables

Supp Figure. 1

```{r}
png("output/supps_ellipse.png", height=1300, width=2000, res=275)


woody_field_traits_georef_tree_form_climate_wide %>%
  select(-c(,site_name, taxon_name, dataset_id, ID)) -> for_corrplot
trait_env_correlation<- cor(for_corrplot, use="pairwise.complete.obs")
corrplot::corrplot(trait_env_correlation[c("seed_mass","logit_ci_over_ca_calc","leaf_area_calc","specific_leaf_area_calc","wood_density","leaf_N_per_area_calc","plant_height","huber_value"),c("Temp","Max_Temp","GDD_5","VPD","VPD_AWAP","VPD_WC_mean_t","SWdown","Prec","PET","MI","Prec_CV","elev","latitude")], method="ellipse")

dev.off()
```

```{r}
woody_field_traits_georef_tree_form_climate_wide %>%
  mutate(log_leaf_area = log(leaf_area_calc),
         log_SLA = log(specific_leaf_area_calc),
         log_wood_dens = log(wood_density),
         log_leaf_N = log(leaf_N_per_area_calc),
         log_height = log(plant_height),
         log_huber = log(huber_value),
         log_VPD = log(VPD),
         log_VPD_terra = log(VPD_terra),
         log_VPD_15 = log(VPD_AWAP),
         log_VPD_WC_mean_t = log(VPD_WC_mean_t),
         log_Prec = log(Prec),
         log_MI = log(MI),
         log_Prec_CV = log(Prec_CV),
         sqrt_elev = sqrt(elev)) -> woody_field_traits_georef_tree_form_climate_wide

woody_field_traits_georef_tree_form_climate_wide %>%
  select(-c(,site_name, taxon_name, dataset_id, ID)) -> for_corrplot
trait_env_correlation_transformed<- cor(for_corrplot, use="pairwise.complete.obs")
```

Test correlations between environmental predictors for the core traits and across all sites

```{r, fig.width=10}

filter_function <- function(core_trait){
woody_field_traits_georef_tree_form_climate_wide %>%
    drop_na(core_trait) %>%
    distinct(dataset_id, site_name, .keep_all=TRUE) %>%
select((c("Temp","Max_Temp","GDD_5","log_VPD","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev","latitude"))) -> data

corr_plot_data <- cor(data, use="pairwise.complete.obs")
corrplot::corrplot(corr_plot_data, method="ellipse", type="lower")
}

purrr::map(core_traits, filter_function)

woody_field_traits_georef_tree_form_climate_wide %>%
    distinct(dataset_id, site_name, .keep_all=TRUE) %>%
    select((c("Temp","Max_Temp","GDD_5","log_VPD","log_VPD_15","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev","latitude"))) %>% cor(., use="pairwise.complete.obs") ->corrplot_data_whole_data

corrplot::corrplot(corrplot_data_whole_data, method="ellipse", type="lower")

```

Latitudinal span of each trait

```{r}

lat_function <- function(core_trait){
woody_field_traits_georef_tree_form_climate_wide %>%
    drop_na(core_trait) %>%
    distinct(dataset_id, site_name, .keep_all=TRUE) %>%
select((c("Temp","Max_Temp","GDD_5","log_VPD","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev","latitude"))) %>%
    summarise(min_lat = min(latitude, na.rm=T), max_lat = max(latitude, na.rm=T))
}

purrr::map(core_traits, lat_function)

```

Whittaker distribution of each trait

```{r}
dev.off()
png("output/whittaker_plot_test.png", height=4000, width=4000, res=150)

purrr::map(core_traits, austraits_climate_space) -> whittaker_plots
sjPlot::plot_grid(whittaker_plots)

dev.off()
```

```{r}
png("output/supps_ellipse_log.png", height=1300, width=2000, res=275)

corrplot::corrplot(trait_env_correlation_transformed[c("seed_mass","logit_ci_over_ca_calc","log_leaf_area","log_SLA","log_wood_dens","log_leaf_N","log_height","log_huber"),c("Temp","Max_Temp","GDD_5","avg_temp_WC_5","log_VPD","log_VPD_15","log_VPD_WC_mean_t","log_VPD_terra","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev","latitude")], method="ellipse")

dev.off()
```


```{r}
png("output/supps_ellipse_log_traits.png", height=1300, width=2000, res=275)

corrplot::corrplot(trait_env_correlation_transformed[c("seed_mass","logit_ci_over_ca_calc","log_leaf_area","log_SLA","log_wood_dens","log_leaf_N","log_height","log_huber"),c("seed_mass","logit_ci_over_ca_calc","log_leaf_area","log_SLA","log_wood_dens","log_leaf_N","log_height","log_huber")], method="ellipse", type = "lower")

dev.off()
```

```{r}
library("relaimpo")
library(visreg)
fit<-(lm(log_leaf_N ~ scale(log_VPD_terra) + scale(GDD_5) + scale(sqrt_elev)+scale(SWdown), woody_field_traits_georef_tree_form_climate_wide))
visreg(fit, "SWdown")
library(lme4)
summary(lmer(log_leaf_N ~ scale(log_VPD_terra) + scale(GDD_5) + scale(sqrt_elev)+scale(SWdown) + (1|site_name), woody_field_traits_georef_tree_form_climate_wide))

calc.relimp(fit)
```





Limits figure

Leaf area analyses

```{r}
woody_field_traits_georef_tree_form_climate_wide%>%
mutate(aridity = case_when(MI < 0.5 ~ "MI < 0.5",
                           MI > 0.5 & MI < 1.0~"0.5 < MI < 1.5", 
                           MI > 1.0 ~ "MI > 1.5")) -> woody_field_traits_georef_tree_form_climate_wide


#assess correlation in each aridity group
correlation_aridity <- function(aridity_class){
  woody_field_traits_georef_tree_form_climate_wide %>%
    filter(aridity == aridity_class) -> woody_field_traits_georef_tree_form_climate_wide_for_function
  cor(x=log(woody_field_traits_georef_tree_form_climate_wide_for_function$leaf_area_calc),y=woody_field_traits_georef_tree_form_climate_wide_for_function$latitude, use="pairwise.complete.obs")
}

correlation_coefficients<-purrr::map(unique(woody_field_traits_georef_tree_form_climate_wide$aridity)[c(2,3,1)], correlation_aridity)
correlation_coefficients <- tibble(correlation_values = paste("r = ",round(unlist(correlation_coefficients),2), sep=""), aridity = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"))

sub_labels <- tibble(aridity = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"), label = paste(c("a","b","c"),")",sep=""))

png("output/limit_figure.png", height=1300, width=2000, res=275)

woody_field_traits_georef_tree_form_climate_wide%>%
  drop_na(aridity) %>%  
  left_join(correlation_coefficients) %>%
  left_join(sub_labels) %>%
  mutate(aridity = factor(aridity, levels = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"))) %>%
  ggplot() +
  geom_point(aes(x=latitude, y=leaf_area_calc))+
  facet_wrap(~aridity, nrow=2) +
  scale_y_log10() +
  theme_bw() +
  xlab("Latitude") +
  ylab(expression(Leaf~area~(mm^2)))+
  theme(strip.background = element_blank(), strip.text = element_blank()) +
  geom_text(mapping = aes(x = Inf, y = Inf, label = aridity),hjust="right",  vjust   = "inward", colour="black") +
  geom_text(mapping = aes(x = Inf, y = 0, label = correlation_values),hjust="right",  vjust   = "inward", colour="black")+
    geom_text(mapping = aes(x = -Inf, y = Inf, label = label),hjust="left",  vjust   = "inward", colour="black")

dev.off()

```

Optimality figure

```{r}
library(ggpubr)

optimality_traits <-c("leaf_N_per_area_calc", "huber_value","logit_ci_over_ca_calc","leaf_area_calc")
trait_env_correlation_transformed[c("log_leaf_N","log_huber","logit_ci_over_ca_calc","log_leaf_area"),c("Temp","log_VPD")] %>% 
  as_tibble() %>%
  mutate(trait_name = optimality_traits) %>%
  rename(avg_temp_WC = Temp, VPD_WC = log_VPD) %>%
  pivot_longer(c("avg_temp_WC", "VPD_WC"), names_to ="env")-> correlations

trait_to_plot <- c("leaf_N_per_area_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("a"),")",sep=""))

figure_opt_plot("VPD_WC", logit="no") -> a
a + ylab(expression(Leaf~N~per~area~(mg~mm^{-2}))) -> a

trait_to_plot <- c("logit_ci_over_ca_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("b"),")",sep=""))

figure_opt_plot("VPD_WC", logit="yes") -> b
b + ylab(expression(logit(chi))) -> b

trait_to_plot <- c("leaf_area_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("c"),")",sep=""))

figure_opt_plot("VPD_WC", logit="no") -> c
c + ylab(expression(Leaf~area~(mm^2))) -> c

trait_to_plot <- c("huber_value")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("d"),")",sep=""))
figure_opt_plot("VPD_WC", logit="no") -> d
d + ylab(expression(Huber~value)) -> d


trait_to_plot <- c("leaf_N_per_area_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("e"),")",sep=""))

figure_opt_plot_log_x("avg_temp_WC", logit="no") -> e
e + ylab(expression(Leaf~N~per~area~(mg~mm^{-2}))) -> e

trait_to_plot <- c("logit_ci_over_ca_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("f"),")",sep=""))

figure_opt_plot_log_x("avg_temp_WC", logit="yes") -> f
f + ylab(expression(logit(chi))) -> f

trait_to_plot <- c("leaf_area_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("g"),")",sep=""))
figure_opt_plot_log_x("avg_temp_WC", logit="no") -> g
g + ylab(expression(Leaf~area~(mm^2))) -> g

trait_to_plot <- c("huber_value")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("h"),")",sep=""))
figure_opt_plot_log_x("avg_temp_WC", logit="no") -> h
h + ylab(expression(Huber~value)) -> h

ggpubr::ggarrange(a,b,c,d, nrow=1) -> figure_top
ggpubr::ggarrange(e,f,g,h, nrow=1) -> figure_bottom

ggpubr::annotate_figure(figure_top,
                bottom = text_grob(expression(Vapour~pressure~deficit~(kPa))))-> figure_top

ggpubr::annotate_figure(figure_bottom,
                bottom = text_grob(expression(Mean~annual~temperature~(degree*C)))) -> figure_bottom



png("output/optimality_figure_log_test.png", height=2000, width=4500, res=350)

ggpubr::ggarrange(figure_top, figure_bottom, nrow=2)

dev.off()
```

```{r}
png("output/ess_figure_log.png", height=1300, width=2000, res=250)

game_theory_traits <- c("plant_height","specific_leaf_area_calc","seed_mass","wood_density")

sub_labels <- tibble(trait_name = game_theory_traits, label = paste(c("a","b","c","d"),")",sep=""))

trait_env_correlation_transformed[c("log_height","log_SLA","seed_mass","log_wood_dens"),c("log_Prec")] %>% 
  as_tibble() %>%
  mutate(trait_name = game_theory_traits) %>%
  rename(cor= value) %>%
  mutate(cor = round(cor, digits=2))->correlations

woody_field_traits_georef_tree_form_climate%>%
    filter(trait_name %in% game_theory_traits) %>%
    select(trait_name, value, prec = Prec_BC)%>%
    pivot_longer(-c("trait_name", "value"), names_to = "env", values_to = "env_value")%>%
  left_join(sub_labels) %>%
  left_join(correlations) %>%
    mutate(env = factor(env, levels = c("prec"),labels =  c("Mean~annual~precipitation~(mm~yr^{-1})")))%>%
  mutate(trait_name = factor(trait_name, levels = game_theory_traits,labels =  c("Height~at~maturation~(m)","Specific~leaf~area~(mg~mm^{-2})","Seed~mass~(mg)","Wood~density~(mg~mm^{-3})")))%>%
  ggplot(aes(env_value, value,group = trait_name)) +
  geom_point() + 
  scale_y_log10() +
  scale_x_log10(limits=c(100,3500)) + 
  theme_bw() + 
    facet_wrap(~trait_name, scales = "free",labeller = label_parsed, drop=TRUE, strip.position ="left") + 
  theme(axis.title.y=element_blank())+
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 12), axis.text=element_text(size=11)) +
  xlab(expression(Mean~annual~precipitation~(mm~yr^{-1}))) + 
  theme(strip.placement = "outside") +
  theme(strip.background = element_rect(fill = "white", colour = "white")) +
    geom_text(mapping = aes(x = 0, y = Inf, label = label, group=env),
              vjust="inward",hjust=-0.25,
              inherit.aes = FALSE, check_overlap = TRUE, size=4) +
      geom_text(mapping = aes(x = 0, y = 0, label = paste("r = ",cor), group=env),
              vjust="bottom",hjust="left",
              inherit.aes = FALSE, size=4)

dev.off()
```

```{r, fig.width=10}
#define the core traits to focus on
core_traits <- c("huber_value","ci_over_ca_calc","leaf_N_per_area_calc","specific_leaf_area_calc","wood_density","plant_height","leaf_area_calc","seed_mass")

#give them a short name
trait_names <- tibble(trait_name = core_traits,
                      trait = c("huber","ci:ca","leaf_N", "SLA", "Wood_dens", "height", "leaf_area","seed_mass"))
woody_field_traits_georef_tree_form_climate%>%
    filter(trait_name %in% core_traits) %>%
    left_join(by="trait_name", trait_names)%>%
    select(trait, value, Temp = avg_temp_WC, VPD = VPD_WC, PAR = solar_WC,elev = elev_WC, prec = prec_WC) %>%
    pivot_longer(-c("trait", "value"), names_to = "env", values_to = "env_value") %>%
    mutate(env = factor(env, levels = c("Temp","VPD","PAR","elev","prec"),labels=c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) %>%
    mutate(env = factor(env, levels = c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) ->data_for_plot


png("output/trait_by_environment_viridis_high_res_small_axes.png", height=1200, width=2600, res=300)
data_for_plot %>% 
  ggplot(aes(env_value, value, col = trait)) + geom_point(alpha = 0.3, shape=16, stroke=0, show.legend = F) + scale_y_log10()   +scale_x_log10()+ theme_classic() + facet_grid(trait ~ env, scales = "free")+ scale_colour_viridis(discrete = TRUE) +theme(axis.title.x=element_blank()) +theme(axis.title.y=element_blank()) +
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 6), axis.text=element_text(size=7))
dev.off()
```
