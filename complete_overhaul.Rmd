---
output: html_document
editor_options: 
  chunk_output_type: console
---
0---
title: Report on data in AusTraits
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---

Load data
```{r, warning=FALSE, message=FALSE}
# Install dependencies as needed
# devtools::install_deps()
# Load packages and functions for this analysis

rm(list=ls())
# devtools::load_all(quiet = TRUE)
source("R/calc_c13_a.R")
source("R/load_climate_data_AWAP.R")
source("R/compile_and_read_AWAP_data.R")
source("R/error_checking_function.R")
source("R/load_bioclim.R")
source("R/load_worldclim.R")
source("R/plot_trait_by_dataset.R")
source("R/load_CRU_clim.R")
source("R/load_envirem.R")
source("R/load_terraclimate.R")
source("R/compile_terraclimate.R")
source("R/figure_opt_plot.R")
source("R/new_iteration_environment_extractor.R")
source("R/plot_whittaker_biomes.R")

library(lubridate)
library(R.utils)
library(tidyverse)

# load trait data
austraits <- readRDS("data/austraits_develop.RDS")

# load woodiness data

woodiness_data <- read_csv("data/woodiness_2022.03.19.csv") %>%
  distinct(taxon_name, .keep_all = T) %>%
  select(taxon_name, plant_growth_form_recoded, woodiness_recoded)
```


```{r}
sum_no_NA <- function(x) if(all(is.na(x))) NA_integer_ else sum(x, na.rm=TRUE)
```


```{r}
#where are sites located?

location_of_sites <-
  austraits$sites %>%
  filter(site_property %in% c("longitude (deg)", "latitude (deg)")) %>%
  spread(site_property, value) %>%
  rowid_to_column("ID") %>%
  rename(latitude = `latitude (deg)`, longitude = `longitude (deg)`) %>%
  mutate_at(c("latitude", "longitude"), ~suppressWarnings(as.numeric(.x))) %>%
  drop_na(longitude, latitude)


# load map of australia (required for climate data analysis)
au_map <- raster::raster("data/australia.tif")
```


```{r}
traits <- austraits$traits %>%
  left_join(location_of_sites) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass","leaf_N_per_area","wood_density","plant_height", "seed_mass", "leaf_delta13C","huber_value")) %>%
  mutate(value = as.numeric(value))
```


```{r}
field_traits <- traits %>%
  filter(!(dataset_id %in% c("Ahrens_2019", "Crous_2013", "Crous_2019", "Du_2018",
                            "Du_2019", "Duan_2015", "EsperonRodriguez_2019",
                            "EsperonRodriguez_2020","Everingham_2020",
                            "Farrell_2012", "Farrell_2013", "Farrell_2017", "Firn_2019",
                            "Gallagher_2011_1", "Gallagher_2011_3","Gallagher_2012", "Gallagher_2015", 
                            "Gardiner_2019", "Geange_2017", "Geange_2020", "Ghannoum_2010","Groom_2010",
                            "Harrison_2009",
                            "Hassiotou_2009", "Huang_2015", "Jagdish_2020", "Lewis_2015",
                            "Lusk_2012", "Lusk_2014", "Moore_2019_2", "Reynolds_2018", "Roderick_1999",
                            "Roderick_2002", "Schulze_2006", "Smith_2012",
                            "Tomlinson_2013","Tomlinson_2019", "Turner_2010", "Vesk_2019",
                            "Vlasveld_2018", "Warren_2005", "Warren_2006"))) %>%
  filter(!(site_name %in% c("Currency Creek Arboretum","Currency Creek Arboretum, South Australia",
                            "Australian National University glasshouse","MU_campus",
                            "Australian National Botanic Gardens","Australian National University"))) %>%
  filter(!(dataset_id %in% c("Kooyman_2011") & trait_name == "wood_density")) %>%
  filter(!(dataset_id %in% c("Wells_2012") & trait_name %in% c("seed_mass","wood_density")))

```

We also remove all trait values which are records across multiple sites, are from the literature, expert values, or are from unknown sources

```{r}
field_traits %>%
  filter(value_type %in% c("raw_value", "site_mean", "site_max", "individual_mean") | trait_name == "plant_height") -> field_traits
```

Create a new trait dataframe to only include observations with associated latitude and longitude
```{r}
field_traits_georef <- 
  field_traits %>%
  drop_na(latitude,longitude)
```


Go through and remove families which were recorded as woody but either aren't woody or do not have a tree/shrub-like growth form, e.g. grass,sedges, palms, ferns

```{r include=FALSE}
ferns_species <-
  austraits$taxa%>%
  filter(family %in% c("Schizaeaceae", "Gleicheniaceae","Dennstaedtiaceae", "Polypodiaceae","Dicksoniaceae", "Datiscaceae"))

palm_species <-
  austraits$taxa%>%
  filter(family %in% c("Arecaceae", "Pandanaceae"))

cycad_species <-
  austraits$taxa%>%
  filter(family %in% c("Cycadaceae","Zamiaceae", "Stangeriaceae"))

graminoid_species <- 
  austraits$taxa %>%
  filter(family %in% c("Poaceae","Cyperaceae","Restionaceae"))

ginger_species <- 
  austraits$taxa %>%
  filter(family %in% c("Zingiberaceae"))

field_traits_georef %>%
  filter(!taxon_name %in% ferns_species$taxon_name) %>%
  filter(!taxon_name %in% palm_species$taxon_name)%>%
  filter(!taxon_name %in% cycad_species$taxon_name)%>%
  filter(!taxon_name %in% graminoid_species$taxon_name)%>%
  filter(!taxon_name %in% ginger_species$taxon_name) ->
  field_traits_georef_tree_form
```


```{r}
field_traits_georef_tree_form %>%
  left_join(woodiness_data) %>%
  filter(woodiness_recoded == "woody") %>%
  filter(plant_growth_form_recoded %in% c("mallee","mallee shrub","mallee shrub tree", "mallee tree", "mallee tree shrub", "mallet", "shrub", "shrub mallee", "shrub subshrub", "shrub tree", "shrub tree mallee", "shrub treelet", "shurb", "shurb subshrub", "subshrub", "subshrub shrub", "tree", "tree (shrub)", "tree mallee", "tree shrub")) -> woody_field_traits_georef_tree_form
```



For species with more than one observation, we can check to see if their values are relatively consistent by inspecting max:min ratio, sd, CV etc. We need to do this seperately for measurements involving leaves and for the rest of the traits because of the fact that hte leaf vs. leaflet perspective will lead to large differences in measurements. So we need to first divide the leaf area dataset up into leaf area measurements on simple leaves, compound leaves measured at the leaflet scale, and leaf area measured at the leaf scale. 


```{r}
read_csv("data/datasets_with_leaf_area_or_dry_mass.csv") %>%
  select(dataset_id, compound_species, leaf_unit_measured)-> leaf_area_leaf_dry_mass_studies

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "no_compound") -> no_compound

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "compound_present" & leaf_unit_measured == "leaflet") -> compound_leaflet

woody_field_traits_georef_tree_form %>% 
  left_join(leaf_area_leaf_dry_mass_studies) %>%
  filter(trait_name %in% c("leaf_area","leaf_dry_mass")) %>%
  filter(compound_species == "compound_present" & leaf_unit_measured %in% c(NA,"leaf")) %>%
  mutate(trait_name = paste(trait_name, "_leaf_unit", sep=""))-> compound_leaf

leaf_leaflet <- bind_rows(no_compound, compound_leaflet)  %>%
  mutate(trait_name = paste(trait_name, "_leaflet_unit", sep=""))
```

Below, we are going to do some error checking. The first step is to see if there are any outliers based on other observations of that species' traits. Next, will inspect to see if data is duplicated across studies, which might occur when studies share data (although most will be removed if they did not have the "field" identifier from above). Finally, compare the distribution of a given dataset for a trait to the entire distribution of that trait to see if there are any data-set scale issues. 

Error checking for leaf area for 1) simple leaf area and compound leaf area measured at leaflet scale and 2) compound leaf area measured at leaf scale.

```{r}

error_check(leaf_leaflet, "leaf_area_leaflet_unit") -> error_check_leaf_leaflet_leaf_area
error_check(leaf_leaflet, "leaf_area_leaflet_unit") -> error_check_leaf_leaflet_leaf_dry_mass

error_check(compound_leaf, "leaf_area_leaf_unit") -> error_check_compound_leaf_area
error_check(compound_leaf, "leaf_area_leaf_unit") -> error_check_compound_leaf_dry_mass
```

Error checking for specific leaf area

```{r}
error_check(woody_field_traits_georef_tree_form, "specific_leaf_area") -> error_check_SLA
```

Error checking for huber value

```{r}
error_check(woody_field_traits_georef_tree_form, "huber_value") -> error_check_huber
```

Error checking for leaf N per area

```{r}
error_check(woody_field_traits_georef_tree_form, "leaf_N_per_area") -> error_check_leaf_N
```

Error checking for wood density - no problematic data points detected

```{r}
error_check(woody_field_traits_georef_tree_form, "wood_density") -> error_check_wood_density
```

Error checking for plant height - no problematic data points detected

```{r}
error_check(woody_field_traits_georef_tree_form, "plant_height") -> error_check_plant_height
```


Error checking for leaf_delta13C - no problematic points detected

```{r}
error_check(woody_field_traits_georef_tree_form, "leaf_delta13C") -> error_check_13C
```

Error checking for seed mass

```{r}
error_check(woody_field_traits_georef_tree_form, "seed_mass") -> error_check_seed_mass
```

To see if there any instances where data is shared between studies, we inspect occurrences of identical trait values for each trait~species group. Although there are a number of cases where this occurs, most seem to be coincidental.

```{r}
woody_field_traits_georef_tree_form %>%
  group_by(value, taxon_name, trait_name) %>% 
  filter(n()>1) %>% 
  filter(n_distinct(dataset_id)>1) -> identical_values
```


Combine leaf mass and area back onto dataframe now that it is seperated into studies which considered the leaflet scale vs. leaf scale

```{r}
woody_field_traits_georef_tree_form %>%
  filter(!(trait_name %in% c("leaf_area", "leaf_dry_mass"))) %>%
  bind_rows(leaf_leaflet) %>%
  bind_rows(compound_leaf) -> woody_field_traits_georef_tree_form
```

Calculate leaf_N_per_area and leaf_area for additional observations:
```{r include=FALSE}
woody_field_traits_georef_tree_form %>% 
  filter(trait_name %in% c("leaf_dry_mass_leaflet_unit","leaf_dry_mass_leaf_unit","leaf_area_leaflet_unit","leaf_area_leaf_unit","leaf_dry_mass","specific_leaf_area","leaf_N_per_dry_mass","leaf_N_per_area")) %>%
  select(ID, trait_name, value, observation_id, taxon_name,dataset_id,site_name, context_name, date,latitude, longitude) %>%
    group_by(ID, trait_name, observation_id, taxon_name, dataset_id, site_name, context_name, date,latitude, longitude) %>%
  summarise(value = mean(value)) %>%
  ungroup() %>%
  mutate(value = as.numeric(value)) %>%
    pivot_wider(names_from = trait_name, values_from = value) %>%
  mutate(leaf_area_combined = ifelse(!is.na(leaf_area_leaflet_unit),leaf_area_leaflet_unit,specific_leaf_area*leaf_dry_mass_leaflet_unit)) %>%
  mutate(specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area),specific_leaf_area,leaf_area_leaflet_unit/leaf_dry_mass_leaflet_unit)) %>%
  mutate(specific_leaf_area_combined = ifelse(!is.na(specific_leaf_area_combined),specific_leaf_area_combined,leaf_area_leaf_unit/leaf_dry_mass_leaf_unit)) %>%
  mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area_combined,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass_leaflet_unit/leaf_area_leaflet_unit,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA)) %>%
   mutate(leaf_N_calc_SLA = leaf_N_per_dry_mass / specific_leaf_area,
         leaf_N_calc_LA = leaf_N_per_dry_mass*leaf_dry_mass_leaf_unit/leaf_area_leaf_unit,
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area),leaf_N_per_area,leaf_N_calc_SLA),
         leaf_N_per_area_combined = ifelse(!is.na(leaf_N_per_area_combined),leaf_N_per_area_combined,leaf_N_calc_LA))->calculated_data
  
  
calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_N_per_area_combined, latitude, longitude) %>%
  filter(!is.na(leaf_N_per_area_combined)) %>%
  mutate(units = "g/m2",
         trait_name = "leaf_N_per_area_calc",
         value = leaf_N_per_area_combined) %>%
  select(-leaf_N_per_area_combined) -> leaf_N_per_area_calcuated

calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         leaf_area_combined, latitude, longitude) %>%
  filter(!is.na(leaf_area_combined)) %>%
  mutate(units = "mm2",
         trait_name = "leaf_area_calc",
         value = leaf_area_combined) %>%
  select(-leaf_area_combined) -> leaf_area_calcuated

calculated_data %>%
  select(ID, observation_id, taxon_name, dataset_id, site_name, context_name, date, 
         specific_leaf_area_combined, latitude, longitude) %>%
  filter(!is.na(specific_leaf_area_combined)) %>%
  mutate(units = "mm2/mg",
         trait_name = "specific_leaf_area_calc",
         value = specific_leaf_area_combined) %>%
  select(-specific_leaf_area_combined) -> specific_leaf_area_calcuated
```

```{r}
erroneous_values <- read_csv("data/erroneous_values.csv")

woody_field_traits_georef_tree_form %>% 
  left_join(erroneous_values, na_matches = "never")


erroneous_list <- vector("list", nrow(erroneous_values))

for(i in 1:nrow(erroneous_values)){
  erroneous_data <- erroneous_values[i,] %>% select_if(~ !any(is.na(.)))
  erroneous_data <- woody_field_traits_georef_tree_form %>% left_join(erroneous_data) %>% drop_na(erroneous)
  erroneous_list[[i]] <- erroneous_data
}

woody_field_traits_georef_tree_form_error <- left_join(woody_field_traits_georef_tree_form,bind_rows(erroneous_list))
```

Bind all calculated data to the summarised data frame
```{r}
woody_field_traits_georef_tree_form_error %>%
  filter(is.na(erroneous)) %>%
  bind_rows(leaf_N_per_area_calcuated) %>%
  bind_rows(leaf_area_calcuated) %>%
  bind_rows(specific_leaf_area_calcuated) %>%
  group_by(site_name, taxon_name, dataset_id, trait_name, ID, latitude, longitude) %>%
  summarise(value=mean(value, na.rm=T)) %>%
  ungroup() -> woody_field_traits_georef_tree_form
```

```{r}
paste("data/WC copy/", list.files("data/WC copy"), sep = "")[1:6] %>%
  map(extract_compile_data, data_source = "WC", woody_field_traits_georef_tree_form) %>%
  bind_rows() -> WC_data
```

```{r}
paste("data/envirem/", list.files("data/envirem"), sep = "")[2] %>%
  map(extract_compile_data, data_source = "Envirem") %>%
  bind_rows()
```

```{r}
climate_data <- readRDS("data/climate_data.RDS") %>%
  dplyr::select(ID, latitude, longitude, prec_WC, elev_WC, vpd_terraclim, Prec_CV_BC, solar_WC, avg_temp_WC, GDD_5_envirem, PET_envirem, max_temp_BC, avg_temp_WC_5, prec_AWAP)
```

```{r}
woody_field_traits_georef_tree_form <- woody_field_traits_georef_tree_form %>%
  left_join(climate_data)
```

```{r}
#define the core traits to focus on
core_traits <- c("huber_value","leaf_delta13C","leaf_N_per_area_calc","specific_leaf_area_calc","wood_density","plant_height","leaf_area_calc","seed_mass")
```


We will now inspect distribution of data in each study relative to total distribution to see if there is any erroneous data
```{r eval=FALSE, include=FALSE}
# traits_to_inspect <- woody_field_traits_georef_tree_form %>%
#    distinct(trait_name)
# 
# trait_by_dataset_core_traits<-function(trait){
# 
# woody_field_traits_georef_tree_form %>%
#   filter(trait_name == trait) %>%
#   distinct(dataset_id) -> dataset_index
# 
# purrr::map(dataset_index$dataset_id, plot_trait_by_dataset, trait)
# }
# 
# purrr::map(traits_to_inspect$trait_name, trait_by_dataset_core_traits)
```



First, let's calculate the correlations between the traits and the environmental variables. This is will be the key statistic which will be used for analysis.For starters, which traits and environmental variables are not normally distributed? We need to turn the data into a wide format.

```{r}
#turn the trait data into a wide format for correlation analyses
woody_field_traits_georef_tree_form %>%
  filter(trait_name %in% core_traits) %>%
  dplyr::select(trait_name, value, Temp = avg_temp_WC, GDD_5 = GDD_5_envirem, VPD = vpd_terraclim, SWdown = solar_WC, Prec = prec_AWAP, Prec_CV = Prec_CV_BC, Max_temp = max_temp_BC, elev = elev_WC, PET = PET_envirem, Temp_5 = avg_temp_WC_5, latitude,longitude,site_name, taxon_name, dataset_id, ID) %>%
  mutate(MI = Prec/PET) %>%
  pivot_wider(values_from = value, names_from = trait_name) -> woody_field_traits_georef_tree_form_wide


woody_field_traits_georef_tree_form_wide %>%
  mutate(log_leaf_area = log(leaf_area_calc),
         log_seed_mass = log(seed_mass),
         log_SLA = log(specific_leaf_area_calc),
         log_wood_dens = log(wood_density),
         log_leaf_N = log(leaf_N_per_area_calc),
         log_height = log(plant_height),
         log_huber = log(huber_value),
         log_VPD = log(VPD),
         log_Prec = log(Prec),
         log_MI = log(MI),
         log_Prec_CV = log(Prec_CV),
         sqrt_elev = sqrt(elev),
         `leaf_delta13C (-)` = -1*leaf_delta13C) -> woody_field_traits_georef_tree_form_climate_wide

woody_field_traits_georef_tree_form_climate_wide %>%
  pivot_longer(names_to = "trait_name", cols = c(leaf_area_calc, log_leaf_area, seed_mass, log_seed_mass, specific_leaf_area_calc, log_SLA, wood_density, log_wood_dens, leaf_N_per_area_calc, log_leaf_N, plant_height, log_height, huber_value, log_huber, leaf_delta13C, `leaf_delta13C (-)`)) -> woody_field_traits_georef_tree_form_climate



#environmental variables
hist(woody_field_traits_georef_tree_form_climate_wide$Temp)
hist(woody_field_traits_georef_tree_form_climate_wide$Temp_5)
hist(woody_field_traits_georef_tree_form_climate_wide$GDD_5)
hist(log(woody_field_traits_georef_tree_form_climate_wide$VPD))
hist(woody_field_traits_georef_tree_form_climate_wide$SWdown)
hist(log(woody_field_traits_georef_tree_form_climate_wide$Prec))
hist(woody_field_traits_georef_tree_form_climate_wide$PET)
hist(log(woody_field_traits_georef_tree_form_climate_wide$MI))
hist(log(woody_field_traits_georef_tree_form_climate_wide$Prec_CV))
hist(sqrt(woody_field_traits_georef_tree_form_climate_wide$elev))
hist(woody_field_traits_georef_tree_form_climate_wide$Max_temp)

#traits
hist(log(woody_field_traits_georef_tree_form_climate_wide$leaf_area_calc))
hist(log(woody_field_traits_georef_tree_form_climate_wide$specific_leaf_area_calc))
hist(woody_field_traits_georef_tree_form_climate_wide$wood_density)
hist(log(woody_field_traits_georef_tree_form_climate_wide$leaf_N_per_area_calc))
hist(log(woody_field_traits_georef_tree_form_climate_wide$plant_height))
hist(log(woody_field_traits_georef_tree_form_climate_wide$huber_value))
hist(log(woody_field_traits_georef_tree_form_climate_wide$seed_mass))
hist(woody_field_traits_georef_tree_form_climate_wide$`leaf_delta13C (-)`)

#all traits bar wood density will be log transformed. leafdelta13c will be mutated by *-1 to put on positive scale
```

First, just check relationships between environmental variables, strong relationship between all variables related to amount of radiation (i.e. Temp, max temp, gdd, SWdown, vpd)

```{r}
png("output/supps_ellipse_environmental.png", height=1300, width=2000, res=275)

library(corrplot)

woody_field_traits_georef_tree_form_climate_wide %>%
  dplyr::select(-c(,site_name, taxon_name, dataset_id, ID)) -> for_corrplot
trait_env_correlation<- cor(for_corrplot, use="pairwise.complete.obs")
corrplot::corrplot(trait_env_correlation[c("Temp","Temp_5","Max_temp","GDD_5","log_VPD","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev"),c("Temp","Temp_5","Max_temp","GDD_5","log_VPD","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev")], method="ellipse", type = "upper")

dev.off()
```


Basic patterns with environment

Supp Figure. 1

```{r}
png("output/supps_ellipse.png", height=1300, width=2000, res=275)

library(corrplot)

woody_field_traits_georef_tree_form_climate_wide %>%
  select(-c(,site_name, taxon_name, dataset_id, ID)) -> for_corrplot
trait_env_correlation<- cor(for_corrplot, use="pairwise.complete.obs")
corrplot::corrplot(trait_env_correlation[c("log_seed_mass","leaf_delta13C (-)","log_leaf_area","log_SLA","log_wood_dens","log_leaf_N","log_height","log_huber"),c("Temp","Max_temp","GDD_5","log_VPD","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev")], method="ellipse")

dev.off()
```

Latitudinal span of each trait

```{r}

lat_function <- function(core_trait){
  browser()
woody_field_traits_georef_tree_form_climate_wide %>%
    drop_na(core_trait) %>%
    distinct(dataset_id, site_name, .keep_all=TRUE) %>%
select((c("Temp","Max_temp","GDD_5","log_VPD","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev","latitude"))) %>%
    summarise(min_lat = min(latitude, na.rm=T), max_lat = max(latitude, na.rm=T))
}

purrr::map(core_traits, lat_function)

```

Whittaker distribution of each trait

```{r}
dev.off()
png("output/whittaker_plot_test.png", height=4000, width=4000, res=150)

purrr::map(core_traits[8], austraits_climate_space) -> whittaker_plots
cowplot::plot_grid(whittaker_plots)

dev.off()
```

```{r}
library("relaimpo")
library(visreg)
fit<-(lm(log_leaf_N ~ (log_VPD) + scale(GDD_5) + scale(sqrt_elev)+scale(SWdown) + +scale(log_Prec), woody_field_traits_georef_tree_form_climate_wide))
fit<-(lm(log_leaf_area ~ scale(log_MI) * scale(Temp) , woody_field_traits_georef_tree_form_climate_wide))
fit<-(lm(log_leaf_area ~ scale(VPD) + scale(SWdown) * scale(Temp) , woody_field_traits_georef_tree_form_climate_wide))

visreg(fit, "Temp")

calc.relimp(fit)
```


Limits figure

Leaf area analyses

```{r}
woody_field_traits_georef_tree_form_climate_wide%>%
mutate(aridity = case_when(MI < 0.5 ~ "MI < 0.5",
                           MI > 0.5 & MI < 1.0~"0.5 < MI < 1.5", 
                           MI > 1.0 ~ "MI > 1.5")) -> woody_field_traits_georef_tree_form_climate_wide


#assess correlation in each aridity group
correlation_aridity <- function(aridity_class){
  woody_field_traits_georef_tree_form_climate_wide %>%
    filter(aridity == aridity_class) -> woody_field_traits_georef_tree_form_climate_wide_for_function
  cor(x=log(woody_field_traits_georef_tree_form_climate_wide_for_function$leaf_area_calc),y=woody_field_traits_georef_tree_form_climate_wide_for_function$Temp_5, use="pairwise.complete.obs")
}

correlation_coefficients<-purrr::map(unique(woody_field_traits_georef_tree_form_climate_wide$aridity)[c(2,3,1)], correlation_aridity)
correlation_coefficients <- tibble(correlation_values = paste("r = ",round(unlist(correlation_coefficients),2), sep=""), aridity = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"))

sub_labels <- tibble(aridity = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"), label = paste(c("a","b","c"),")",sep=""))

png("output/limit_figure.png", height=1300, width=2000, res=275)

woody_field_traits_georef_tree_form_climate_wide%>%
  drop_na(aridity) %>%  
  left_join(correlation_coefficients) %>%
  left_join(sub_labels) %>%
  mutate(aridity = factor(aridity, levels = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"))) %>%
  ggplot() +
  geom_point(aes(x=Temp_5, y=leaf_area_calc), size =3)+
  facet_wrap(~aridity, nrow=2) +
  scale_y_log10() +
  theme_bw() +
  xlab("Temp_5") +
  ylab(expression(Leaf~area~(mm^2)))+
  geom_text(mapping = aes(x = Inf, y = Inf, label = aridity),hjust="right",  vjust   = "inward", colour="black", size = 12) +
  geom_text(mapping = aes(x = Inf, y = 0, label = correlation_values),hjust="right",  vjust   = "inward", colour="black",size = 12)+
  geom_text(mapping = aes(x = -Inf, y = Inf, label = label),hjust="left",  vjust   = "inward", colour="black",size = 12) +
  theme(text = element_text(size = 24), strip.background = element_blank(), strip.text = element_blank())

dev.off()

```

```{r}
woody_field_traits_georef_tree_form_climate_wide%>%
mutate(aridity = case_when(MI < 0.5 ~ "MI < 0.5",
                           MI > 0.5 & MI < 1.0~"0.5 < MI < 1.5", 
                           MI > 1.0 ~ "MI > 1.5")) -> woody_field_traits_georef_tree_form_climate_wide


#assess correlation in each aridity group
correlation_aridity <- function(aridity_class){
  woody_field_traits_georef_tree_form_climate_wide %>%
    filter(aridity == aridity_class) -> woody_field_traits_georef_tree_form_climate_wide_for_function
  cor(x=log(woody_field_traits_georef_tree_form_climate_wide_for_function$leaf_area_calc),y=woody_field_traits_georef_tree_form_climate_wide_for_function$SWdown, use="pairwise.complete.obs")
}

correlation_coefficients<-purrr::map(unique(woody_field_traits_georef_tree_form_climate_wide$aridity)[c(2,3,1)], correlation_aridity)
correlation_coefficients <- tibble(correlation_values = paste("r = ",round(unlist(correlation_coefficients),2), sep=""), aridity = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"))

sub_labels <- tibble(aridity = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"), label = paste(c("a","b","c"),")",sep=""))

png("output/limit_figure.png", height=1300, width=2000, res=275)

woody_field_traits_georef_tree_form_climate_wide%>%
  drop_na(aridity) %>%  
  left_join(correlation_coefficients) %>%
  left_join(sub_labels) %>%
  mutate(aridity = factor(aridity, levels = c("MI < 0.5", "0.5 < MI < 1.5", "MI > 1.5"))) %>%
  ggplot() +
  geom_point(aes(x=SWdown, y=leaf_area_calc), size =3)+
  facet_wrap(~aridity, nrow=2) +
  scale_y_log10() +
  theme_bw() +
  xlab("SW_down") +
  ylab(expression(Leaf~area~(mm^2)))+
  geom_text(mapping = aes(x = Inf, y = Inf, label = aridity),hjust="right",  vjust   = "inward", colour="black", size = 12) +
  geom_text(mapping = aes(x = Inf, y = 0, label = correlation_values),hjust="right",  vjust   = "inward", colour="black",size = 12)+
  geom_text(mapping = aes(x = -Inf, y = Inf, label = label),hjust="left",  vjust   = "inward", colour="black",size = 12) +
  theme(text = element_text(size = 24), strip.background = element_blank(), strip.text = element_blank())

dev.off()

```

Optimality figure

```{r}
library(ggpubr)

trait_to_plot <- c("leaf_N_per_area_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("a"),")",sep=""))

  woody_field_traits_georef_tree_form_climate %>%
    dplyr::select(trait_name, value, VPD)%>%
    pivot_longer(-c("trait_name", "value"), names_to = "env", values_to = "env_value")%>%
    left_join(sub_labels) %>%
    filter(trait_name == "leaf_N_per_area_calc") %>%
    mutate(cor = round(cor(value, env_value, use = "pairwise.complete.obs"), digits = 2)) %>%
    drop_na(value) %>%
    ggplot(aes(env_value, value,group = trait_name)) +
    geom_point() + 
    scale_y_log10() +
    scale_x_log10() +
    theme_bw() + 
    # theme(axis.title.x = element_blank())++ 
    xlab("Vapour pressure deficit (kPa)") +
    ylab(expression("Leaf nitrogen per area (g"~m^{-2}~")")) + 
    theme(text=element_text(size=15)) +
    geom_text(mapping = aes(x = 0, y = Inf, label = label, group=env),
            hjust = "inward", vjust = "inward",
            inherit.aes = FALSE, check_overlap = TRUE, size = 6) +
    geom_text(mapping = aes(x = 0, y = 0, label = paste("r = ",cor), group=env),
            hjust = "left", vjust = "bottom",
                inherit.aes = FALSE, size = 6) -> a
  
  
sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("b"),")",sep=""))

  woody_field_traits_georef_tree_form_climate %>%
    dplyr::select(trait_name, value, Temp_5)%>%
    pivot_longer(-c("trait_name", "value"), names_to = "env", values_to = "env_value")%>%
    left_join(sub_labels) %>%
    filter(trait_name == "leaf_N_per_area_calc") %>%
    mutate(cor = round(cor(value, env_value, use = "pairwise.complete.obs"), digits = 2)) %>%
    drop_na(value) %>%
    ggplot(aes(env_value, value,group = trait_name)) +
    geom_point() + 
    scale_y_log10() +
    scale_x_log10() +
    theme_bw() + 
    # theme(axis.title.x = element_blank())++ 
    xlab("Vapour pressure deficit (kPa)") +
    ylab(expression("Leaf nitrogen per area (g"~m^{-2}~")")) + 
    theme(text=element_text(size=15)) +
    geom_text(mapping = aes(x = 0, y = Inf, label = label, group=env),
            hjust = "inward", vjust = "inward",
            inherit.aes = FALSE, check_overlap = TRUE, size = 6) +
    geom_text(mapping = aes(x = 0, y = 0, label = paste("r = ",cor), group=env),
            hjust = "left", vjust = "bottom",
                inherit.aes = FALSE, size = 6) -> b
  

  
  
    woody_field_traits_georef_tree_form_climate %>%
    dplyr::select(trait_name, value, Prec)%>%
    pivot_longer(-c("trait_name", "value"), names_to = "env", values_to = "env_value")%>%
    left_join(sub_labels) %>%
    filter(trait_name == "leaf_N_per_area_calc") %>%
    mutate(cor = round(cor(value, env_value, use = "pairwise.complete.obs"), digits = 2)) %>%
    drop_na(value) %>%
    ggplot(aes(env_value, value,group = trait_name)) +
    geom_point() + 
    scale_y_log10() +
    scale_x_log10() +
    theme_bw() + 
    # theme(axis.title.x = element_blank())++ 
    xlab("Precipitaiton (mm)") +
    ylab(expression("Leaf nitrogen per area (g"~m^{-2}~")")) + 
    theme(text=element_text(size=15)) +
    geom_text(mapping = aes(x = 0, y = Inf, label = label, group=env),
            hjust = "inward", vjust = "inward",
            inherit.aes = FALSE, check_overlap = TRUE, size = 6) +
    geom_text(mapping = aes(x = 0, y = 0, label = paste("r = ",cor), group=env),
            hjust = "left", vjust = "bottom",
                inherit.aes = FALSE, size = 6) -> b
  
  trait_vector <- c("seed_mass","leaf_delta13C (-)","leaf_area_calc","specific_leaf_area_calc","wood_density","leaf_N_per_area_calc","plant_height","huber_value")
  expression_vector <- c(expression(Seed~mass),expression(Delta~13_c))
  
  asd <- (parse(text= c(paste(expression(Seed~mass~(mg)), sep=""), paste(expression(Delta~C[13]), sep="")) ))

  p <- list()
  for(i in 1:length(trait_vector)){
      woody_field_traits_georef_tree_form_climate %>%
    dplyr::select(trait_name, value, Prec)%>%
    pivot_longer(-c("trait_name", "value"), names_to = "env", values_to = "env_value")%>%
    left_join(sub_labels) %>%
    filter(trait_name == trait_vector[[i]]) %>%
    mutate(cor = round(cor(value, env_value, use = "pairwise.complete.obs"), digits = 2)) %>%
    drop_na(value) %>%
    ggplot(aes(env_value, value,group = trait_name)) +
    geom_point() + 
    scale_y_log10() +
    scale_x_log10() +
    theme_classic() + 
    # theme(axis.title.x = element_blank())++ 
    xlab("Precipitation (mm)") +
    ylab(asd[[2]]) +
    theme(text=element_text(size=15)) +
    geom_text(mapping = aes(x = 0, y = Inf, label = label, group=env),
            hjust = "inward", vjust = "inward",
            inherit.aes = FALSE, check_overlap = TRUE, size = 6) +
    geom_text(mapping = aes(x = 0, y = 0, label = paste("r = ",cor), group=env),
            hjust = "left", vjust = "bottom",
                inherit.aes = FALSE, size = 6) +
    geom_smooth(method = "lm")-> p[[i]]
}
  
  
  corrplot::corrplot(trait_env_correlation[c("log_seed_mass","leaf_delta13C (-)","log_leaf_area","log_SLA","log_wood_dens","log_leaf_N","log_height","log_huber"),c("Temp","Max_temp","GDD_5","log_VPD","SWdown","log_Prec","PET","log_MI","log_Prec_CV","sqrt_elev")], method="ellipse")
  
trait_to_plot <- c("ci_over_ca_from_c13")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("b"),")",sep=""))

figure_opt_plot("VPD_WC", logit="yes") -> b
b + ylab(expression(logit(chi))) -> b

trait_to_plot <- c("leaf_area_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("c"),")",sep=""))

figure_opt_plot("VPD_WC", logit="no") -> c
c + ylab(expression(Leaf~area~(mm^2))) -> c

trait_to_plot <- c("huber_value")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("d"),")",sep=""))
figure_opt_plot("VPD_WC", logit="no") -> d
d + ylab(expression(Huber~value)) -> d


trait_to_plot <- c("leaf_N_per_area_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("e"),")",sep=""))

figure_opt_plot_log_x("avg_temp_WC", logit="no") -> e
e + ylab(expression(Leaf~N~per~area~(mg~mm^{-2}))) -> e

trait_to_plot <- c("ci_over_ca_from_c13")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("f"),")",sep=""))

figure_opt_plot_log_x("avg_temp_WC", logit="yes") -> f
f + ylab(expression(logit(chi))) -> f

trait_to_plot <- c("leaf_area_calc")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("g"),")",sep=""))
figure_opt_plot_log_x("avg_temp_WC", logit="no") -> g
g + ylab(expression(Leaf~area~(mm^2))) -> g

trait_to_plot <- c("huber_value")

sub_labels <- tibble(trait_name = trait_to_plot, label = paste(c("h"),")",sep=""))
figure_opt_plot_log_x("avg_temp_WC", logit="no") -> h
h + ylab(expression(Huber~value)) -> h

ggpubr::ggarrange(a,b,c,d, nrow=1) -> figure_top
ggpubr::ggarrange(e,f,g,h, nrow=1) -> figure_bottom

ggpubr::annotate_figure(figure_top,
                bottom = text_grob(expression(Vapour~pressure~deficit~(kPa))))-> figure_top

ggpubr::annotate_figure(figure_bottom,
                bottom = text_grob(expression(Mean~annual~temperature~(degree*C)))) -> figure_bottom



png("output/optimality_figure_log_test.png", height=2000, width=4500, res=350)

ggpubr::ggarrange(figure_top, figure_bottom, nrow=2)

dev.off()
```

```{r}
png("output/ess_figure_log.png", height=1300, width=2000, res=250)

game_theory_traits <- c("plant_height","specific_leaf_area_calc","seed_mass","wood_density")

sub_labels <- tibble(trait_name = game_theory_traits, label = paste(c("a","b","c","d"),")",sep=""))

trait_env_correlation_transformed[c("log_height","log_SLA","seed_mass","log_wood_dens"),c("log_Prec")] %>% 
  as_tibble() %>%
  mutate(trait_name = game_theory_traits) %>%
  rename(cor= value) %>%
  mutate(cor = round(cor, digits=2))->correlations

woody_field_traits_georef_tree_form_climate%>%
    filter(trait_name %in% game_theory_traits) %>%
    select(trait_name, value, prec = Prec_BC)%>%
    pivot_longer(-c("trait_name", "value"), names_to = "env", values_to = "env_value")%>%
  left_join(sub_labels) %>%
  left_join(correlations) %>%
    mutate(env = factor(env, levels = c("prec"),labels =  c("Mean~annual~precipitation~(mm~yr^{-1})")))%>%
  mutate(trait_name = factor(trait_name, levels = game_theory_traits,labels =  c("Height~at~maturation~(m)","Specific~leaf~area~(mg~mm^{-2})","Seed~mass~(mg)","Wood~density~(mg~mm^{-3})")))%>%
  ggplot(aes(env_value, value,group = trait_name)) +
  geom_point() + 
  scale_y_log10() +
  scale_x_log10(limits=c(100,3500)) + 
  theme_bw() + 
    facet_wrap(~trait_name, scales = "free",labeller = label_parsed, drop=TRUE, strip.position ="left") + 
  theme(axis.title.y=element_blank())+
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 12), axis.text=element_text(size=11)) +
  xlab(expression(Mean~annual~precipitation~(mm~yr^{-1}))) + 
  theme(strip.placement = "outside") +
  theme(strip.background = element_rect(fill = "white", colour = "white")) +
    geom_text(mapping = aes(x = 0, y = Inf, label = label, group=env),
              vjust="inward",hjust=-0.25,
              inherit.aes = FALSE, check_overlap = TRUE, size=4) +
      geom_text(mapping = aes(x = 0, y = 0, label = paste("r = ",cor), group=env),
              vjust="bottom",hjust="left",
              inherit.aes = FALSE, size=4)

dev.off()
```

```{r, fig.width=10}
#define the core traits to focus on
core_traits <- c("huber_value","logit_ci_over_ca_from_c13","leaf_N_per_area_calc","specific_leaf_area_calc","wood_density","plant_height","leaf_area_calc","seed_mass")

#give them a short name
trait_names <- tibble(trait_name = core_traits,
                      trait = c("huber","ci:ca","leaf_N", "SLA", "Wood_dens", "height", "leaf_area","seed_mass"))
woody_field_traits_georef_tree_form_climate%>%
    filter(trait_name %in% core_traits) %>%
    left_join(by="trait_name", trait_names)%>%
    select(trait, value, Temp = avg_temp_WC, VPD = VPD_WC, PAR = solar_WC,elev = elev_WC, prec = prec_WC) %>%
    pivot_longer(-c("trait", "value"), names_to = "env", values_to = "env_value") %>%
    mutate(env = factor(env, levels = c("Temp","VPD","PAR","elev","prec"),labels=c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) %>%
    mutate(env = factor(env, levels = c("MAT ~(degree*C)","VPD~(kPa)","PAR (kJ~m^{-2}~day^{-1})","Elevation~(m)","MAP~(mm~yr^{-1})"))) ->data_for_plot


png("output/trait_by_environment_viridis_high_res_small_axes.png", height=1200, width=2600, res=300)
data_for_plot %>% 
  ggplot(aes(env_value, value, col = trait)) + geom_point(alpha = 0.3, shape=16, stroke=0, show.legend = F) + scale_y_log10()   +scale_x_log10()+ theme_classic() + facet_grid(trait ~ env, scales = "free")+ scale_colour_viridis(discrete = TRUE) +theme(axis.title.x=element_blank()) +theme(axis.title.y=element_blank()) +
  theme(strip.text.x = element_text(size = 6), strip.text.y = element_text(size = 6), axis.text=element_text(size=7))
dev.off()
```
